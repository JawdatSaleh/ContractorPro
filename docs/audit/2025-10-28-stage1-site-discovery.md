# Stage 1 – Site Discovery & Mapping (2025-10-28)

## 1. Executive summary
- تم جرد جميع واجهات ContractorPro بما في ذلك الصفحات العامة، لوحات HTML التراثية، وتطبيق React الأحادي الصفحة.
- تم استخراج جدول شامل بنقاط الربط بين الواجهات الأمامية وواجهات REST الخلفية، مع توثيق 10 فجوات تكامل أساسية تتطلب معالجات في المراحل المقبلة.
- تم توثيق نماذج البيانات المعتمدة في Prisma لإعطاء رؤية واضحة لعلاقات الموارد البشرية والمالية وسجلات النشاط.

## 2. منهجية الاكتشاف
1. فحص الملفات الجذرية والفرعية لتحديد نقاط الدخول العامة (`index.html`, `login.html`).
2. تصنيف الصفحات في مجلد `pages/` إلى محاور أعمال بحسب المحتوى والروابط الداخلية.
3. تحليل مسارات React المعرّفة في `apps/web/src/router.tsx` وربطها بالمكونات الخاصة بكل ميزة.
4. مراجعة تطبيق Fastify الرئيسي (`apps/api/src/index.ts`) واستكشاف حزم المسارات المتخصصة (IAM، HR، Finance، Activity).
5. استخلاص مخطط Prisma (`apps/api/prisma/schema.prisma`) لتوثيق نماذج البيانات والعلاقات.
6. مطابقة استدعاءات واجهة برمجة التطبيقات في الواجهة الأمامية مع النقاط المتوفرة في الخادم لتحديد الفجوات.

## 3. واجهات المستخدم الأمامية
### 3.1 نقاط الدخول العامة
- **الصفحة الافتتاحية**: تعرض شاشة تحميل مع إعادة توجيه تلقائي إلى بوابة تسجيل الدخول بعد ثانيتين وتحتوي على تضمينات لمنصة Rocket.【F:index.html†L1-L68】
- **بوابة تسجيل الدخول**: واجهة RTL تتضمن نموذج اعتماد، بيانات تجريبية، وتحقق مبكر من جلسة المستخدم المخزنة محليًا.【F:login.html†L1-L133】

### 3.2 لوحات HTML التراثية (Static Legacy Dashboards)
تم تصنيف 18 صفحة فرعية إلى خمس حزم وظيفية، مع روابط داخلية موثقة في ملف خريطة الموقع المحدث (`docs/site-map.json`). أمثلة:
- **المشاريع**: `Projects/projects_management_center.html`, `projects_hub.html`, `Projects/project_creation_wizard.html` تقدم قوائم ومخططات للمشاريع.【F:pages/Projects/projects_management_center.html†L1-L200】
- **المالية**: صفحات الفواتير والمراكز المالية تضم عناصر بطاقات ورسوم بيانية لـ Chart.js.【F:pages/financial_management_center.html†L1-L34】
- **الموارد البشرية**: نماذج إضافة الموظفين والملفات الشخصية توفر حقولاً تفصيلية للمعلومات الوظيفية.【F:pages/add_employee.html†L1-L38】

### 3.3 تطبيق React الأحادي
- يتم تحميل التطبيق عبر `main.tsx` الذي يغلّف `App` داخل React Router وموفرات الحالة.【F:apps/web/src/main.tsx†L1-L33】
- يحدد `App.tsx` الهيكل العام (Sidebar، Header، Footer) ويستخدم `AuthProvider` لإدارة الصلاحيات.【F:apps/web/src/App.tsx†L1-L40】
- تعرف `router.tsx` جميع المسارات الديناميكية، متضمنة مسارات الموارد البشرية، الحضور، الرواتب، السجلات، والصلاحيات.【F:apps/web/src/router.tsx†L1-L37】
- كل مسار يرتبط بمكون Lazy مستقل، مثل `EmployeesPage` الذي يستدعي `EmployeeTable` مع متجر Zustand لجلب البيانات.【F:apps/web/src/components/employees/EmployeeTable.tsx†L1-L110】
- صفحات الميزات تستخدم React Query أو مخازن مخصصة للتكامل مع API (مثال: `AttendancePage`، `LeavesPage`).【F:apps/web/src/features/attendance/AttendancePage.tsx†L1-L51】【F:apps/web/src/features/leaves/LeavesPage.tsx†L1-L60】

## 4. الخدمات الخلفية (Fastify)
- الخادم الرئيسي يقوم بتهيئة CORS، Swagger، واستخراج JWT ثم يربط مسارات IAM, HR, Finance, Activity ويشغل جدولة لقطات النشاط اليومية.【F:apps/api/src/index.ts†L1-L44】
- **IAM**: يوفر تسجيل الدخول، استرجاع الملف الشخصي، إدارة المستخدمين، الأدوار، والصلاحيات مع تسجيل النشاط في كل عملية حساسة.【F:apps/api/src/iam/routes.ts†L38-L147】
- **HR**: يغطي استعلامات الموظفين، ملفاتهم، العقود، الحضور، والإجازات مع ضوابط رؤية حسب الدور.【F:apps/api/src/hr/routes.ts†L19-L181】
- **Finance**: يدير دورات الرواتب، السلف، القروض، وتقارير مراكز التكلفة، ويتكامل مع سجلات اليومية المحاسبية.【F:apps/api/src/finance/routes.ts†L11-L168】
- **Activity**: يقدم سجلات نشاط قابلة للبحث وتحليلات زمنية مع إمكانية إنشاء نسخ أرشيفية بالطلب.【F:apps/api/src/activity/routes.ts†L13-L75】

## 5. نماذج البيانات (Prisma)
- يحتوي `schema.prisma` على 20 نموذجاً، أبرزها `Employee` الذي يرتبط بأقسام، مشاريع، عقود، رواتب، سلف، قروض، ومصروفات، مما يوفّر رؤية موحدة للموارد البشرية والمالية.【F:apps/api/prisma/schema.prisma†L37-L124】
- نماذج الرواتب (`PayrollBatch`, `PayrollItem`) ترتبط بـ `Journal` و`JournalEntry` لتوثيق الحركات المحاسبية بعد الترحيل.【F:apps/api/prisma/schema.prisma†L125-L188】
- سجلات المتابعة (`AuditLog`, `ActivityLog`) تحتفظ بسياق غني (المستخدم، الوصف، البيانات التعريفية) لدعم التتبع والامتثال.【F:apps/api/prisma/schema.prisma†L189-L236】

## 6. مطابقة الواجهة الأمامية مع خدمات API
تم تحديث `docs/site-map.json` لتضمين 10 استدعاءات واجهة أمامية غير مدعومة حاليًا في الخادم. أبرز الفجوات:
1. **إنشاء وتحديث الموظف**: الواجهة تستدعي `POST /api/employees` و`PUT /api/employees/:id` عبر `EmployeeForm`، بينما الخادم لا يوفر سوى استعلامات القراءة والعقود المرتبطة.【F:apps/web/src/api/employees.ts†L65-L90】【F:apps/api/src/hr/routes.ts†L57-L168】
2. **ملف الموظف المالي**: الطلبات إلى `/api/employees/:id/{finance|contracts|advances|loans|expenses}` غير متوفرة، ما يعطل تبويبات الملف المالي في الواجهة.【F:apps/web/src/api/employees.ts†L45-L74】
3. **تقارير الموظف المالية التفصيلية**: استدعاءات `/api/payroll?employeeId` و`/api/expenses?employeeId` غير موجودة، بينما الخادم يوفر فقط إجماليات الدُفعات وتقارير مراكز التكلفة.【F:apps/web/src/api/finance.ts†L1-L23】【F:apps/api/src/finance/routes.ts†L11-L168】

## 7. مخرجات المرحلة
- **خريطة الموقع**: `docs/site-map.json` تحتوي على بنية مفصلة للواجهات، المسارات، نقاط التكامل، ونماذج البيانات.
- **قائمة الفجوات**: تم تضمين حالة كل استدعاء (مدعوم/مفقود/مدعوم جزئياً) لتغذية خطة الإصلاح في المراحل المقبلة.

## 8. توصيات للمراحل اللاحقة
1. **أتمتة توليد الـ API الناقصة**: تحديد الأولويات لإنشاء نقاط REST المفقودة بما يتوافق مع توقعات واجهة المستخدم.
2. **توحيد واجهات HTML التراثية**: تقييم إمكانية ترحيل الصفحات الساكنة إلى مكونات React للحفاظ على تجربة موحدة.
3. **تدقيق إعدادات Rocket Script**: التحقق من تكوينات الاستدعاء الخارجي (rocket.new) وضمان عملها في بيئة staging.
4. **تهيئة اختبارات زحف أوتوماتيكية**: استخدام Playwright في المرحلة التالية للتأكد من صحة الروابط والتنقلات المذكورة في خريطة الموقع.
