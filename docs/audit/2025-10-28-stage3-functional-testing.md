# Stage 3 – الاختبارات الوظيفية (2025-10-28)

## 1. ملخص تنفيذي
- **ملف الموظف معطّل بالكامل**: الواجهة تعتمد على `Promise.all` لجلب ست نقاط نهاية فرعية (/finance, /expenses, /advances, /loans) غير موجودة في الخادم، ما يؤدي إلى فشل تحميل الملف الشخصي والرسائل التحذيرية بدلًا من البيانات المطلوبة (أولوية حرجة).【F:apps/web/src/store/useEmployeeStore.ts†L61-L101】【F:apps/web/src/api/employees.ts†L103-L135】【F:apps/api/src/hr/routes.ts†L20-L130】
- **أدوات التصفية الرئيسة لا تعمل**: مكوّن جدول الموظفين يرسل وسائط `search`, `department`, `roleKey` بينما خادم الموارد البشرية لا يفهم سوى `q` و`departmentId`، فتفشل عمليات البحث والتقسيم (أولوية عالية).【F:apps/web/src/store/useEmployeeStore.ts†L65-L70】【F:apps/api/src/common/validators.ts†L8-L11】
- **إنشاء وتحديث الموظفين محجوبان**: الواجهة تستدعي `POST /api/employees` و`PUT /api/employees/:id`، لكن الخادم يوفّر فقط الاستعلامات ورفع العقود، ما يجعل زر "إضافة موظف" وروابط التحرير عديمة الفائدة (أولوية حرجة).【F:apps/web/src/components/employees/EmployeeTable.tsx†L47-L175】【F:apps/web/src/api/employees.ts†L128-L135】【F:apps/api/src/hr/routes.ts†L20-L130】

## 2. منهجية الاختبار
1. تتبّع كل تدفق من واجهة المستخدم (التصفية، الروابط، الأزرار) إلى متجر الحالة واستدعاءات REST ذات الصلة للتأكد من توقعات البيانات.【F:apps/web/src/components/employees/EmployeeTable.tsx†L19-L183】【F:apps/web/src/components/employees/EmployeeDetails.tsx†L12-L200】
2. مطابقة المسارات المستخدمة في React Query وZustand مع المسارات المفعّلة في Fastify لتأكيد وجود الدعم الخلفي أو غيابه.【F:apps/web/src/features/payroll/PayrollPage.tsx†L13-L63】【F:apps/api/src/finance/routes.ts†L10-L210】
3. تصنيف النتائج بحسب شدّة الأثر (تعطيل/تدهور/مخاطر) مع وضع حالات النجاح تحت المراقبة للحفاظ على تغطية الاختبارات في المراحل اللاحقة.【F:apps/web/src/features/attendance/AttendancePage.tsx†L13-L44】【F:apps/api/src/hr/routes.ts†L132-L191】

## 3. مصفوفة حالات الاختبار

| # | الميزة | السيناريو | الخطوات المختصرة | التوقع | النتيجة الفعلية | الحالة | الأولوية |
|---|--------|-----------|------------------|---------|------------------|---------|----------|
| 1 | قائمة الموظفين | تطبيق بحث باسم الموظف | فتح `/employees`، إدخال "Ahmed" في حقل البحث | تضييق القائمة إلى السجلات المطابقة | الخادم يتجاهل وسيط `search`، فيبقى الجدول بدون تصفية | فشل | عالية |
| 2 | قائمة الموظفين | تصفية بحسب القسم | اختيار قسم من القائمة المنسدلة | عرض موظفي القسم المحدد | يرسل `department` بدلاً من `departmentId` فيسقط الشرط وتبقى النتائج كاملة | فشل | عالية |
| 3 | ملف الموظف | عرض التفاصيل | فتح رابط `/employees/:id` | تحميل المعلومات، العقود، الملخص المالي | `Promise.all` يفشل عند أول 404، فيظهر تنبيه "تعذر تحميل بيانات الموظف" | فشل | حرجة |
| 4 | ملف الموظف | الانتقال إلى صفحة التحرير | الضغط على "تعديل البيانات" | ملء النموذج بالبيانات الحالية | نفس فشل #3 يمنع ملء المتغيرات، فيظهر نموذج فارغ مع أخطاء حفظ لاحقة | فشل | حرجة |
| 5 | ملف الموظف | حفظ موظف جديد | الضغط على "إضافة موظف" وتعبئة الحقول | إنشاء سجل والعودة للتفاصيل | `POST /api/employees` غير مدعوم، يعيد 404 | فشل | حرجة |
| 6 | ملف الموظف | حفظ تعديل | تعديل بيانات موجودة والضغط على "حفظ" | تحديث السجل | `PUT /api/employees/:id` غير مدعوم، يعيد 404 | فشل | حرجة |
| 7 | الحضور | استيراد سجل يومي | اختيار تاريخ والضغط على "تسجيل حضور افتراضي" | إنشاء سجل وتحديث الجدول | نقطة النهاية `/api/attendance/bulk` تعمل وتعيد إدراج السجل | ناجح | متوسطة |
| 8 | الإجازات | تقديم طلب اعتماد | تعبئة النموذج، ثم الضغط على "اعتماد" | يتغير الحقل إلى `approved` ويُعاد التحميل | كل من `POST /api/leaves` و`PATCH /api/leaves/:id/approve` يعملان مع إعادة الجلب | ناجح | متوسطة |
| 9 | الرواتب | دورة كاملة (إنشاء → حساب → ترحيل) | إنشاء دفعة، حسابها، ترحيلها | يجب تحديث الحالة حتى "posted" وتسجيل قيد | مسارات `/api/payroll/batches` تعمل متسلسلة وتعيد الأنشطة المطلوبة | ناجح | متوسطة |
|10 | السلف/القروض | اعتماد سلفة | الضغط على زر "اعتماد" | تحديث حالة السلفة | استدعاء `PATCH /api/advances/:id/approve` متاح ويعيد الحالة الجديدة | ناجح | متوسطة |
|11 | مركز النشاط | تصدير CSV | تحميل السجل ثم الضغط على "تصدير" | تنزيل ملف CSV | يتم إنشاء الملف محليًا إذا توفرت البيانات، يعتمد على صلاحيات المستخدم | ناجح مشروط | منخفضة |

> **ملاحظة:** حالات النجاح تفترض توفر الأدوار/الصلاحيات المطلوبة كما هو محدد في الخادم (MANAGE_PAYROLL، VIEW_ACTIVITY_LOGS، إلخ). أي نقص في التهيئة سيحوّل الحالة إلى فشل بالاعتماد على رمز 403.

## 4. النتائج الحرجة والعالية

### 4.1 تجمّد ملف الموظف عند تحميل الموارد المالية
- **خطوات إعادة الإنتاج:** افتح `/employees/:id` لأي سجل موجود.
- **السبب الجذري:** دالة `fetchEmployeeProfile` تطلب ست نقاط نهاية فرعية في آن واحد، بينما الخادم يوفّر فقط `/api/employees/:id` و`/api/employees/:id/contracts`؛ أي طلب إضافي يعيد 404 ويُسقط الدالة بالكامل.【F:apps/web/src/store/useEmployeeStore.ts†L77-L101】【F:apps/web/src/api/employees.ts†L103-L126】【F:apps/api/src/hr/routes.ts†L20-L130】
- **التأثير:** عدم القدرة على قراءة البيانات أو تعديلها، وتعطّل كامل لجولة المستخدم في إدارة الموظفين.
- **التوصية:** إمّا توفير النقاط المفقودة في الخادم أو تدرّج الطلبات مع التعامل مع الأخطاء (fallback) بحيث يستمر عرض البيانات المتاحة حتى لو فشلت مصادر ثانوية.

### 4.2 تعطل إنشاء وتحديث الموظفين
- **خطوات إعادة الإنتاج:** من `/employees` اضغط "إضافة موظف" وأرسل النموذج، أو افتح `/employees/:id/edit` وحاول الحفظ.
- **السبب الجذري:** واجهة `api.employees` تستدعي `POST` و`PUT` غير معرّفتين ضمن `hrRoutes`، إذ لا توجد سوى عمليات GET وإنشاء العقود.【F:apps/web/src/api/employees.ts†L128-L135】【F:apps/api/src/hr/routes.ts†L20-L130】
- **التأثير:** تمنع المنصة من إضافة موظفين جدد أو تعديل البيانات، ما يعطّل عمليات الموارد البشرية الأساسية.
- **التوصية:** تنفيذ نقاط النهاية اللازمة أو تعديل الواجهة لتشير إلى عمليات مدعومة (مثلاً workflow خارجي) مع تعطيل الأزرار حتى يكتمل الدعم.

### 4.3 فشل التصفية والبحث في قائمة الموظفين
- **خطوات إعادة الإنتاج:** استخدم حقل البحث أو قوائم القسم/الحالة في صفحة `/employees`.
- **السبب الجذري:** يتم إرسال مفاتيح `search`, `department`, `roleKey` لكن مخطط التحقق `employeeFilterQuery` يقبل فقط `q`, `departmentId`, `projectId`، ما يؤدي إلى تجاهل الشروط دون إشعار المستخدم.【F:apps/web/src/store/useEmployeeStore.ts†L65-L70】【F:apps/api/src/common/validators.ts†L8-L11】
- **التأثير:** المستخدمون يظنون أن التصفية تعمل بينما النتائج ثابتة، ما يؤدي إلى قرارات خاطئة ومجهود إضافي يدوي.
- **التوصية:** توحيد أسماء المعاملات بين الواجهة والخادم أو إضافة طبقة تحويل في المخزن لتحويل القيم إلى `q` و`departmentId`.

## 5. نتائج متوسطة ومنخفضة
- **حالة نجاح مشروطة لمركز النشاط:** يعتمد تصدير CSV وإنشاء النسخ الاحتياطية على صلاحيات `VIEW_ACTIVITY_LOGS` و`MANAGE_ACTIVITY_RETENTION`؛ غيابها ينتج 403، لكن واجهة المستخدم لا تعرض رسالة ودية. يُنصح بإظهار تنبيه عند فشل الطلب.【F:apps/web/src/features/activity/ActivityCenterPage.tsx†L25-L120】【F:apps/api/src/activity/routes.ts†L35-L86】
- **التحقق من الرواتب، الحضور، الإجازات:** المسارات الأمامية والخلفية متطابقة وتعمل ضمن حدود صلاحياتها، ما يجعلها مرشحة مبكرة لأتمتة اختبارات E2E في المرحلة الرابعة.【F:apps/web/src/features/payroll/PayrollPage.tsx†L13-L63】【F:apps/api/src/finance/routes.ts†L10-L210】【F:apps/web/src/features/attendance/AttendancePage.tsx†L13-L44】【F:apps/api/src/hr/routes.ts†L132-L277】

## 6. فرص تحسين إضافية
1. إضافة طبقة مراقبة للأخطاء في `useEmployeeStore` لتسجيل الاستثناءات وعرض رسائل تفصيلية للمستخدم بدلاً من الاكتفاء بحالة فارغة.【F:apps/web/src/store/useEmployeeStore.ts†L77-L101】
2. استخدام React Query بدلاً من `Promise.all` في ملف الموظف لرفع قابلية إعادة المحاولة وإظهار مؤشرات تحميل لكل تبويب بيانات.【F:apps/web/src/components/employees/EmployeeDetails.tsx†L12-L200】
3. تفعيل تحذير بصري عندما يُعاد رمز 403 في صفحات تتطلب صلاحيات عالية (مثل النشاط والرواتب) لتقليل البلاغات الوهمية عن "تعطل" النظام.【F:apps/web/src/features/activity/ActivityCenterPage.tsx†L25-L169】

## 7. الخطوات التالية
1. توحيد عقود الموظفين بين الواجهة والخادم ثم إعادة اختبار جميع سيناريوهات الموارد البشرية.
2. إعداد بيانات اختبار ثابتة (seed) تغطي صلاحيات متعددة لتجنّب فشل الاختبارات بسبب الصلاحيات وليس بسبب عطل وظيفي.
3. ترسيم حالات النجاح الحالية (الحضور، الإجازات، الرواتب، السلف) كأساس لسيناريوهات Playwright في المرحلة الرابعة.
