<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مركز إدارة الفواتير الشامل - ContractorPro</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fcontractor7112back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
<script type="module" src="https://static.rocket.new/rocket-shot.js?v=0.0.1"></script>
</head>
<body class="bg-background font-arabic">
    <!-- Navigation Sidebar -->
    <div class="fixed right-0 top-0 h-full w-64 bg-surface shadow-modal z-50 transform transition-transform duration-300" id="sidebar">
        <div class="p-6 border-b border-border">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                    <i class="fas fa-hard-hat text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-text-primary">ContractorPro</h1>
                    <p class="text-sm text-text-secondary">نظام إدارة المقاولات</p>
                </div>
            </div>
        </div>
        
        <nav class="p-4 space-y-2">
            <!-- Dashboard -->
            <a href="main_dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-tachometer-alt w-5"></i>
                <span class="font-medium">لوحة التحكم</span>
            </a>

            <!-- Projects Section -->
            <a href="projects_management_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-building w-5"></i>
                <span>المشاريع</span>
                <i class="fas fa-chevron-left mr-auto text-xs"></i>
            </a>

            <!-- Finance Section -->
            <a href="financial_management_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary-50 text-primary border-r-4 border-primary">
                <i class="fas fa-chart-line w-5"></i>
                <span>المالية</span>
                <i class="fas fa-chevron-left mr-auto text-xs"></i>
            </a>

            <!-- Employees Section -->
            <a href="human_resources_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-users w-5"></i>
                <span>الموظفين</span>
                <i class="fas fa-chevron-left mr-auto text-xs"></i>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="mr-64 min-h-screen">
        <!-- Top Header -->
        <header class="bg-surface shadow-card px-6 py-4 border-b border-border">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="goBack()" class="text-text-secondary hover:text-text-primary transition-fast">
                        <i class="fas fa-arrow-right text-lg"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-text-primary">مركز إدارة الفواتير الشامل</h1>
                        <p class="text-text-secondary">إدارة كاملة للفواتير الضريبية مع التتبع المتقدم والتحليلات</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success-600 transition-fast flex items-center gap-2 shadow-md" onclick="createNewInvoice()">
                        <i class="fas fa-plus"></i>
                        <span>فاتورة جديدة</span>
                    </button>
                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2 shadow-md" onclick="bulkOperations()">
                        <i class="fas fa-tasks"></i>
                        <span>عمليات مجمعة</span>
                    </button>
                    <button class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning-600 transition-fast flex items-center gap-2 shadow-md" onclick="exportInvoices()">
                        <i class="fas fa-download"></i>
                        <span>تصدير</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Invoice Statistics -->
        <section class="p-6 bg-gradient-to-br from-primary-50 to-secondary-50 border-b border-border">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <!-- Total Invoices -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium mb-1">إجمالي الفواتير</p>
                            <p class="text-3xl font-bold text-text-primary">156</p>
                            <div class="flex items-center gap-2 mt-2">
                                <i class="fas fa-arrow-up text-success text-sm"></i>
                                <span class="text-success text-sm font-medium">+8 هذا الشهر</span>
                            </div>
                        </div>
                        <div class="w-14 h-14 bg-primary-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice text-primary text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Paid Invoices -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium mb-1">مدفوعة</p>
                            <p class="text-3xl font-bold text-success">128</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-success text-sm font-medium">82% معدل الدفع</span>
                            </div>
                        </div>
                        <div class="w-14 h-14 bg-success-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-check-circle text-success text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Pending Invoices -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium mb-1">معلقة</p>
                            <p class="text-3xl font-bold text-warning">24</p>
                            <div class="flex items-center gap-2 mt-2">
                                <i class="fas fa-exclamation-triangle text-warning text-sm"></i>
                                <span class="text-warning text-sm font-medium">تحتاج متابعة</span>
                            </div>
                        </div>
                        <div class="w-14 h-14 bg-warning-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-hourglass-half text-warning text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Overdue Invoices -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium mb-1">متأخرة</p>
                            <p class="text-3xl font-bold text-error">4</p>
                            <div class="flex items-center gap-2 mt-2">
                                <i class="fas fa-clock text-error text-sm"></i>
                                <span class="text-error text-sm font-medium">تحتاج إجراء عاجل</span>
                            </div>
                        </div>
                        <div class="w-14 h-14 bg-error-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation-circle text-error text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Value -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium mb-1">إجمالي القيمة</p>
                            <p class="text-2xl font-bold text-primary">8.5M ريال</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-text-secondary text-sm">شامل الضريبة</span>
                            </div>
                        </div>
                        <div class="w-14 h-14 bg-secondary-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-coins text-secondary text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Search & Filters -->
        <section class="p-6 bg-surface border-b border-border">
            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                <div class="flex-1 w-full lg:w-auto">
                    <div class="relative">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary"></i>
                        <input type="text" placeholder="البحث في الفواتير (رقم الفاتورة، العميل، المشروع، المبلغ...)" class="w-full pr-10 pl-4 py-3 border border-border rounded-lg focus:border-primary focus:outline-none bg-white" id="invoiceSearch" onkeyup="performSearch()" />
                    </div>
                </div>
                
                <div class="flex gap-3 flex-wrap">
                    <select class="px-4 py-2 border border-border rounded-lg focus:border-primary focus:outline-none bg-white min-w-32" onchange="applyFilter('status', this.value)">
                        <option value>كافة الحالات</option>
                        <option value="paid">مدفوعة</option>
                        <option value="pending">معلقة</option>
                        <option value="overdue">متأخرة</option>
                        <option value="draft">مسودة</option>
                    </select>
                    
                    <select class="px-4 py-2 border border-border rounded-lg focus:border-primary focus:outline-none bg-white min-w-32" onchange="applyFilter('client', this.value)">
                        <option value>كافة العملاء</option>
                        <option value="mohammed">محمد العبدالله</option>
                        <option value="andalus">شركة الأندلس</option>
                        <option value="fahad">فهد الخالدي</option>
                    </select>
                    
                    <input type="date" class="px-4 py-2 border border-border rounded-lg focus:border-primary focus:outline-none bg-white" onchange="applyFilter('date', this.value)" />
                           
                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        <span>مسح الفلاتر</span>
                    </button>
                    
                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="saveSearchPreset()">
                        <i class="fas fa-bookmark"></i>
                        <span>حفظ البحث</span>
                    </button>
                </div>
            </div>
            
            <!-- Saved Search Presets -->
            <div class="mt-4 flex gap-2 flex-wrap">
                <span class="text-sm text-text-secondary">عمليات بحث محفوظة:</span>
                <button class="text-xs bg-primary-100 text-primary px-3 py-1 rounded-full hover:bg-primary-200" onclick="applySavedSearch('overdue')">
                    الفواتير المتأخرة
                </button>
                <button class="text-xs bg-warning-100 text-warning px-3 py-1 rounded-full hover:bg-warning-200" onclick="applySavedSearch('thisMonth')">
                    فواتير هذا الشهر
                </button>
                <button class="text-xs bg-success-100 text-success px-3 py-1 rounded-full hover:bg-success-200" onclick="applySavedSearch('highValue')">
                    الفواتير عالية القيمة
                </button>
            </div>
        </section>

        <!-- Invoice Analytics Dashboard -->
        <section class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Invoice Performance Chart -->
                <div class="lg:col-span-2 bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-text-primary">أداء الفواتير الشهري</h3>
                        <div class="flex gap-2">
                            <select class="px-3 py-1 border border-border rounded-lg text-sm focus:border-primary focus:outline-none">
                                <option>آخر 6 أشهر</option>
                                <option>آخر سنة</option>
                                <option>السنة الحالية</option>
                            </select>
                            <button class="text-xs bg-secondary-200 text-text-primary px-2 py-1 rounded hover:bg-secondary-300" onclick="exportChart('performance')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="h-64 relative">
                        <canvas id="invoicePerformanceChart"></canvas>
                    </div>
                </div>

                <!-- Payment Status Breakdown -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-text-primary">توزيع حالات الدفع</h3>
                        <button class="text-xs bg-secondary-200 text-text-primary px-2 py-1 rounded hover:bg-secondary-300" onclick="exportChart('paymentStatus')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    
                    <div class="h-64 relative">
                        <canvas id="paymentStatusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Invoice Management Table -->
            <div class="bg-surface rounded-xl shadow-card border border-border">
                <div class="p-6 border-b border-border">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-text-primary">جدول إدارة الفواتير</h2>
                        <div class="flex items-center gap-3">
                            <button class="text-sm bg-secondary-200 text-text-primary px-3 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="selectAllInvoices()">
                                <i class="fas fa-check-square"></i>
                                <span>تحديد الكل</span>
                            </button>
                            <button class="text-sm bg-warning text-white px-3 py-2 rounded-lg hover:bg-warning-600 transition-fast flex items-center gap-2" onclick="sendBulkReminders()">
                                <i class="fas fa-paper-plane"></i>
                                <span>إرسال تذكير جماعي</span>
                            </button>
                            <span class="text-sm text-text-secondary">عرض <strong>24</strong> من أصل <strong>156</strong> فاتورة</span>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full" id="invoicesTable">
                        <thead class="bg-secondary-50 border-b border-border">
                            <tr>
                                <th class="text-center py-4 px-4 font-medium text-text-secondary w-12">
                                    <input type="checkbox" class="rounded" onchange="toggleAllSelection()" />
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('invoice_number')">
                                    رقم الفاتورة <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('client')">
                                    العميل <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('project')">
                                    المشروع <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('amount')">
                                    المبلغ الكلي <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('tax')">
                                    الضريبة (15%) <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('date')">
                                    التاريخ <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('due_date')">
                                    تاريخ الاستحقاق <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-right py-4 px-4 font-medium text-text-secondary cursor-pointer hover:text-text-primary" onclick="sortTable('status')">
                                    الحالة <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-center py-4 px-4 font-medium text-text-secondary">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoice Row 1 -->
                            <tr class="border-b border-border hover:bg-secondary-50 transition-colors invoice-row" data-invoice="INV-2025-001" data-status="paid">
                                <td class="py-4 px-4 text-center">
                                    <input type="checkbox" class="rounded invoice-checkbox" value="INV-2025-001" />
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-primary-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-file-invoice text-primary text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-text-primary">INV-2025-001</p>
                                            <p class="text-xs text-text-secondary">ضريبية معتمدة</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center">
                                            <span class="text-xs font-bold text-success">م.ع</span>
                                        </div>
                                        <div>
                                            <p class="font-medium text-text-primary">محمد العبدالله</p>
                                            <p class="text-xs text-text-secondary">عميل VIP</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-text-primary">فيلا الرياض الحديثة</td>
                                <td class="py-4 px-4">
                                    <div>
                                        <p class="font-bold text-success text-lg">425,000 ريال</p>
                                        <p class="text-xs text-text-secondary">المبلغ الصافي: 369,565 ريال</p>
                                    </div>
                                </td>
                                <td class="py-4 px-4">
                                    <span class="font-medium text-error">55,435 ريال</span>
                                </td>
                                <td class="py-4 px-4 text-text-secondary">15 يناير 2025</td>
                                <td class="py-4 px-4 text-text-secondary">30 يناير 2025</td>
                                <td class="py-4 px-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success-100 text-success border border-success-200">
                                        <i class="fas fa-check-circle text-xs ml-1"></i>
                                        مدفوعة
                                    </span>
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center justify-center gap-1">
                                        <button class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-600 transition-fast" onclick="viewInvoiceDetails('INV-2025-001')" title="عرض التفاصيل">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="text-xs bg-secondary-200 text-text-primary px-2 py-1 rounded hover:bg-secondary-300 transition-fast" onclick="editInvoice('INV-2025-001')" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="text-xs bg-success text-white px-2 py-1 rounded hover:bg-success-600 transition-fast" onclick="downloadInvoicePDF('INV-2025-001')" title="تحميل PDF">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="text-xs bg-warning text-white px-2 py-1 rounded hover:bg-warning-600 transition-fast" onclick="duplicateInvoice('INV-2025-001')" title="نسخ">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Invoice Row 2 -->
                            <tr class="border-b border-border hover:bg-secondary-50 transition-colors invoice-row" data-invoice="INV-2025-002" data-status="pending">
                                <td class="py-4 px-4 text-center">
                                    <input type="checkbox" class="rounded invoice-checkbox" value="INV-2025-002" />
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-warning-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-file-invoice text-warning text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-text-primary">INV-2025-002</p>
                                            <p class="text-xs text-warning">معلقة الدفع</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                                            <span class="text-xs font-bold text-primary">ش.أ</span>
                                        </div>
                                        <div>
                                            <p class="font-medium text-text-primary">شركة الأندلس</p>
                                            <p class="text-xs text-text-secondary">شركة</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-text-primary">مجمع تجاري جدة</td>
                                <td class="py-4 px-4">
                                    <div>
                                        <p class="font-bold text-warning text-lg">540,000 ريال</p>
                                        <p class="text-xs text-text-secondary">المبلغ الصافي: 469,565 ريال</p>
                                    </div>
                                </td>
                                <td class="py-4 px-4">
                                    <span class="font-medium text-error">70,435 ريال</span>
                                </td>
                                <td class="py-4 px-4 text-text-secondary">20 يناير 2025</td>
                                <td class="py-4 px-4 text-warning">5 فبراير 2025</td>
                                <td class="py-4 px-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-warning-100 text-warning border border-warning-200">
                                        <i class="fas fa-hourglass-half text-xs ml-1"></i>
                                        معلقة
                                    </span>
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center justify-center gap-1">
                                        <button class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-600 transition-fast" onclick="viewInvoiceDetails('INV-2025-002')" title="عرض التفاصيل">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="text-xs bg-secondary-200 text-text-primary px-2 py-1 rounded hover:bg-secondary-300 transition-fast" onclick="editInvoice('INV-2025-002')" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="text-xs bg-warning text-white px-2 py-1 rounded hover:bg-warning-600 transition-fast" onclick="sendInvoiceReminder('INV-2025-002')" title="إرسال تذكير">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button class="text-xs bg-success text-white px-2 py-1 rounded hover:bg-success-600 transition-fast" onclick="markAsPaid('INV-2025-002')" title="تسجيل كمدفوعة">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Invoice Row 3 -->
                            <tr class="border-b border-border hover:bg-secondary-50 transition-colors invoice-row" data-invoice="INV-2025-003" data-status="overdue">
                                <td class="py-4 px-4 text-center">
                                    <input type="checkbox" class="rounded invoice-checkbox" value="INV-2025-003" />
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-error-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-file-invoice text-error text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-text-primary">INV-2025-003</p>
                                            <p class="text-xs text-error">متأخرة 15 يوم</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-secondary-100 rounded-full flex items-center justify-center">
                                            <span class="text-xs font-bold text-secondary">ف.خ</span>
                                        </div>
                                        <div>
                                            <p class="font-medium text-text-primary">فهد الخالدي</p>
                                            <p class="text-xs text-error">متأخر في الدفع</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-text-primary">مشروع سكني الدمام</td>
                                <td class="py-4 px-4">
                                    <div>
                                        <p class="font-bold text-error text-lg">150,000 ريال</p>
                                        <p class="text-xs text-text-secondary">المبلغ الصافي: 130,435 ريال</p>
                                    </div>
                                </td>
                                <td class="py-4 px-4">
                                    <span class="font-medium text-error">19,565 ريال</span>
                                </td>
                                <td class="py-4 px-4 text-text-secondary">25 ديسمبر 2024</td>
                                <td class="py-4 px-4 text-error font-medium">10 يناير 2025</td>
                                <td class="py-4 px-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-error-100 text-error border border-error-200 animate-pulse">
                                        <i class="fas fa-exclamation-triangle text-xs ml-1"></i>
                                        متأخرة
                                    </span>
                                </td>
                                <td class="py-4 px-4">
                                    <div class="flex items-center justify-center gap-1">
                                        <button class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-600 transition-fast" onclick="viewInvoiceDetails('INV-2025-003')" title="عرض التفاصيل">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="text-xs bg-error text-white px-2 py-1 rounded hover:bg-error-600 transition-fast" onclick="sendUrgentReminder('INV-2025-003')" title="إنذار عاجل">
                                            <i class="fas fa-exclamation"></i>
                                        </button>
                                        <button class="text-xs bg-warning text-white px-2 py-1 rounded hover:bg-warning-600 transition-fast" onclick="negotiatePayment('INV-2025-003')" title="تفاوض">
                                            <i class="fas fa-handshake"></i>
                                        </button>
                                        <button class="text-xs bg-success text-white px-2 py-1 rounded hover:bg-success-600 transition-fast" onclick="markAsPaid('INV-2025-003')" title="تسجيل كمدفوعة">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="p-6 border-t border-border">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-text-secondary">
                            عرض من <strong>1</strong> إلى <strong>24</strong> من أصل <strong>156</strong> فاتورة
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-1 border border-border rounded hover:bg-secondary-50 transition-fast text-text-secondary">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="px-3 py-1 bg-primary text-white rounded">1</button>
                            <button class="px-3 py-1 border border-border rounded hover:bg-secondary-50 transition-fast">2</button>
                            <button class="px-3 py-1 border border-border rounded hover:bg-secondary-50 transition-fast">3</button>
                            <span class="px-2 text-text-secondary">...</span>
                            <button class="px-3 py-1 border border-border rounded hover:bg-secondary-50 transition-fast">7</button>
                            <button class="px-3 py-1 border border-border rounded hover:bg-secondary-50 transition-fast text-text-secondary">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Invoice Creation Modal -->
    <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-surface rounded-xl shadow-modal w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-border">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-text-primary">إنشاء فاتورة ضريبية جديدة</h2>
                    <button onclick="closeInvoiceModal()" class="text-text-secondary hover:text-text-primary">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            
            <form id="invoiceForm" class="p-6 space-y-6">
                <!-- Client Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">العميل</label>
                        <div class="flex gap-2">
                            <select class="flex-1 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" id="clientSelect">
                                <option value>اختر العميل</option>
                                <option value="mohammed">محمد العبدالله</option>
                                <option value="andalus">شركة الأندلس</option>
                                <option value="fahad">فهد الخالدي</option>
                            </select>
                            <button type="button" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast" onclick="openClientModal()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المشروع</label>
                        <select class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" id="projectSelect">
                            <option value>اختر المشروع</option>
                            <option value="villa">فيلا الرياض الحديثة</option>
                            <option value="mall">مجمع تجاري جدة</option>
                            <option value="residential">مشروع سكني الدمام</option>
                        </select>
                    </div>
                </div>

                <!-- Invoice Details -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">رقم الفاتورة</label>
                        <input type="text" value="INV-2025-004" readonly class="w-full px-3 py-2 border border-border rounded-lg bg-secondary-50 focus:outline-none" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ الفاتورة</label>
                        <input type="date" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" id="invoiceDate" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ الاستحقاق</label>
                        <input type="date" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" id="dueDate" />
                    </div>
                </div>

                <!-- Items Table -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-text-primary">بنود الفاتورة</h3>
                        <button type="button" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success-600 transition-fast" onclick="addInvoiceItem()">
                            <i class="fas fa-plus ml-2"></i>إضافة بند
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border border-border rounded-lg">
                            <thead class="bg-secondary-50">
                                <tr>
                                    <th class="text-right py-3 px-4 font-medium text-text-secondary">الوصف</th>
                                    <th class="text-center py-3 px-4 font-medium text-text-secondary">الكمية</th>
                                    <th class="text-center py-3 px-4 font-medium text-text-secondary">السعر الوحدة</th>
                                    <th class="text-center py-3 px-4 font-medium text-text-secondary">الإجمالي</th>
                                    <th class="text-center py-3 px-4 font-medium text-text-secondary">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <tr class="border-t border-border">
                                    <td class="py-3 px-4">
                                        <input type="text" placeholder="وصف الخدمة أو المنتج" class="w-full px-2 py-1 border border-border rounded focus:border-primary focus:outline-none" />
                                    </td>
                                    <td class="py-3 px-4">
                                        <input type="number" value="1" class="w-full px-2 py-1 border border-border rounded focus:border-primary focus:outline-none text-center" onchange="calculateTotal()" />
                                    </td>
                                    <td class="py-3 px-4">
                                        <input type="number" step="0.01" placeholder="0.00" class="w-full px-2 py-1 border border-border rounded focus:border-primary focus:outline-none text-center" onchange="calculateTotal()" />
                                    </td>
                                    <td class="py-3 px-4 text-center font-medium">0.00 ريال</td>
                                    <td class="py-3 px-4 text-center">
                                        <button type="button" class="text-error hover:text-error-600" onclick="removeInvoiceItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Totals -->
                <div class="bg-secondary-50 rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-text-secondary">المجموع الفرعي:</span>
                                <span class="font-medium" id="subtotal">0.00 ريال</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">ضريبة القيمة المضافة (15%):</span>
                                <span class="font-medium text-error" id="taxAmount">0.00 ريال</span>
                            </div>
                            <div class="flex justify-between border-t border-border pt-3">
                                <span class="text-lg font-bold text-text-primary">المجموع الكلي:</span>
                                <span class="text-lg font-bold text-primary" id="totalAmount">0.00 ريال</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">ملاحظات</label>
                            <textarea rows="4" placeholder="ملاحظات إضافية أو شروط الدفع" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none resize-none"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-between items-center pt-4 border-t border-border">
                    <button type="button" class="px-6 py-2 border border-border rounded-lg text-text-secondary hover:bg-secondary-50 transition-fast" onclick="closeInvoiceModal()">
                        إلغاء
                    </button>
                    <div class="flex gap-3">
                        <button type="button" class="px-6 py-2 bg-secondary-200 text-text-primary rounded-lg hover:bg-secondary-300 transition-fast">
                            حفظ كمسودة
                        </button>
                        <button type="submit" class="px-6 py-2 bg-success text-white rounded-lg hover:bg-success-600 transition-fast">
                            إنشاء الفاتورة
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Chart configurations
        let invoicePerformanceChart;
        let paymentStatusChart;

        // Initialize charts
        function initializeCharts() {
            // Invoice Performance Chart
            const performanceCtx = document.getElementById('invoicePerformanceChart').getContext('2d');
            invoicePerformanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                    datasets: [{
                        label: 'الفواتير المرسلة',
                        data: [28, 32, 24, 35, 29, 38],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderRadius: 6
                    }, {
                        label: 'الفواتير المدفوعة',
                        data: [24, 28, 20, 30, 26, 32],
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5
                            }
                        }
                    }
                }
            });

            // Payment Status Chart
            const statusCtx = document.getElementById('paymentStatusChart').getContext('2d');
            paymentStatusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['مدفوعة', 'معلقة', 'متأخرة', 'مسودة'],
                    datasets: [{
                        data: [128, 24, 4, 8],
                        backgroundColor: [
                            '#10B981',
                            '#F59E0B', 
                            '#EF4444',
                            '#6B7280'
                        ],
                        borderWidth: 2,
                        borderColor: '#FFFFFF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true
                        }
                    }
                }
            });
        }

        // Navigation functions
        function goBack() {
            window.location.href = 'financial_management_center.html';
        }

        // Header action functions
        function createNewInvoice() {
            document.getElementById('invoiceModal').classList.remove('hidden');
            document.getElementById('invoiceModal').classList.add('flex');
            setDefaultDates();
        }

        function bulkOperations() {
            const selectedInvoices = getSelectedInvoices();
            if (selectedInvoices.length === 0) {
                alert('يرجى تحديد فاتورة واحدة على الأقل');
                return;
            }
            alert(`تنفيذ عمليات مجمعة على ${selectedInvoices.length} فاتورة`);
        }

        function exportInvoices() {
            alert('تصدير الفواتير إلى ملف Excel');
        }

        // Search and filter functions
        function performSearch() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.invoice-row');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function applyFilter(filterType, value) {
            const rows = document.querySelectorAll('.invoice-row');
            
            rows.forEach(row => {
                let shouldShow = true;
                
                if (filterType === 'status' && value) {
                    shouldShow = row.dataset.status === value;
                }
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('invoiceSearch').value = '';
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            document.querySelectorAll('.invoice-row').forEach(row => row.style.display = '');
        }

        function saveSearchPreset() {
            alert('تم حفظ إعدادات البحث كمعيار مخصص');
        }

        function applySavedSearch(presetType) {
            clearFilters();
            
            if (presetType === 'overdue') {
                applyFilter('status', 'overdue');
            } else if (presetType === 'thisMonth') {
                // Apply date filter for this month
                alert('تطبيق فلتر فواتير هذا الشهر');
            } else if (presetType === 'highValue') {
                // Apply high value filter
                alert('تطبيق فلتر الفواتير عالية القيمة');
            }
        }

        // Table functions
        function sortTable(column) {
            alert(`ترتيب الجدول حسب: ${column}`);
        }

        function selectAllInvoices() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function toggleAllSelection() {
            const mainCheckbox = document.querySelector('thead input[type="checkbox"]');
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            
            checkboxes.forEach(cb => cb.checked = mainCheckbox.checked);
        }

        function sendBulkReminders() {
            const selectedInvoices = getSelectedInvoices();
            if (selectedInvoices.length === 0) {
                alert('يرجى تحديد الفواتير المراد إرسال التذكير لها');
                return;
            }
            alert(`إرسال تذكير جماعي لـ ${selectedInvoices.length} فاتورة`);
        }

        function getSelectedInvoices() {
            return Array.from(document.querySelectorAll('.invoice-checkbox:checked')).map(cb => cb.value);
        }

        // Invoice action functions
        function viewInvoiceDetails(invoiceId) {
            alert(`عرض تفاصيل الفاتورة: ${invoiceId}`);
        }

        function editInvoice(invoiceId) {
            alert(`تعديل الفاتورة: ${invoiceId}`);
        }

        function downloadInvoicePDF(invoiceId) {
            alert(`تحميل PDF للفاتورة: ${invoiceId}`);
        }

        function duplicateInvoice(invoiceId) {
            alert(`إنشاء نسخة من الفاتورة: ${invoiceId}`);
        }

        function sendInvoiceReminder(invoiceId) {
            alert(`إرسال تذكير للفاتورة: ${invoiceId}`);
        }

        function sendUrgentReminder(invoiceId) {
            alert(`إرسال إنذار عاجل للفاتورة: ${invoiceId}`);
        }

        function negotiatePayment(invoiceId) {
            alert(`فتح نافذة التفاوض على الدفع للفاتورة: ${invoiceId}`);
        }

        function markAsPaid(invoiceId) {
            if (confirm('هل أنت متأكد من تسجيل هذه الفاتورة كمدفوعة؟')) {
                alert(`تم تسجيل الفاتورة كمدفوعة: ${invoiceId}`);
                // Update UI accordingly
            }
        }

        // Chart functions
        function exportChart(chartType) {
            alert(`تصدير الرسم البياني: ${chartType}`);
        }

        // Modal functions
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
            document.getElementById('invoiceModal').classList.remove('flex');
        }

        function openClientModal() {
            alert('فتح نافذة إضافة عميل جديد');
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            
            document.getElementById('invoiceDate').value = today;
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        }

        function addInvoiceItem() {
            const tbody = document.getElementById('invoiceItems');
            const newRow = tbody.insertRow();
            
            newRow.innerHTML = `
                <td class="py-3 px-4">
                    <input type="text" placeholder="وصف الخدمة أو المنتج" class="w-full px-2 py-1 border border-border rounded focus:border-primary focus:outline-none">
                </td>
                <td class="py-3 px-4">
                    <input type="number" value="1" class="w-full px-2 py-1 border border-border rounded focus:border-primary focus:outline-none text-center" onchange="calculateTotal()">
                </td>
                <td class="py-3 px-4">
                    <input type="number" step="0.01" placeholder="0.00" class="w-full px-2 py-1 border border-border rounded focus:border-primary focus:outline-none text-center" onchange="calculateTotal()">
                </td>
                <td class="py-3 px-4 text-center font-medium">0.00 ريال</td>
                <td class="py-3 px-4 text-center">
                    <button type="button" class="text-error hover:text-error-600" onclick="removeInvoiceItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            newRow.classList.add('border-t', 'border-border');
        }

        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            if (document.getElementById('invoiceItems').rows.length > 1) {
                row.remove();
                calculateTotal();
            } else {
                alert('يجب أن تحتوي الفاتورة على بند واحد على الأقل');
            }
        }

        function calculateTotal() {
            let subtotal = 0;
            const rows = document.getElementById('invoiceItems').rows;
            
            for (let i = 0; i < rows.length; i++) {
                const quantity = parseFloat(rows[i].cells[1].querySelector('input').value) || 0;
                const price = parseFloat(rows[i].cells[2].querySelector('input').value) || 0;
                const total = quantity * price;
                
                rows[i].cells[3].textContent = total.toFixed(2) + ' ريال';
                subtotal += total;
            }
            
            const taxRate = 0.15;
            const taxAmount = subtotal * taxRate;
            const totalAmount = subtotal + taxAmount;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ريال';
            document.getElementById('taxAmount').textContent = taxAmount.toFixed(2) + ' ريال';
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2) + ' ريال';
        }

        // Form submission
        document.getElementById('invoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            const client = document.getElementById('clientSelect').value;
            const project = document.getElementById('projectSelect').value;
            
            if (!client || !project) {
                alert('يرجى اختيار العميل والمشروع');
                return;
            }
            
            alert('تم إنشاء الفاتورة بنجاح');
            closeInvoiceModal();
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setDefaultDates();
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
    <script src="../js/session.js" data-login-path="../login.html"></script>
</body>
</html>