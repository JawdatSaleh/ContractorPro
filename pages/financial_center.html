<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>المركز المالي - ContractorPro</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fcontractor7112back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
<script type="module" src="https://static.rocket.new/rocket-shot.js?v=0.0.1"></script>
</head>
<body class="bg-background font-arabic">
    <!-- Navigation Sidebar -->
    <div class="fixed right-0 top-0 h-full w-64 bg-surface shadow-modal z-50 transform transition-transform duration-300" id="sidebar">
        <div class="p-6 border-b border-border">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                    <i class="fas fa-hard-hat text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-text-primary">ContractorPro</h1>
                    <p class="text-sm text-text-secondary">نظام إدارة المقاولات</p>
                </div>
            </div>
        </div>
        
        <nav class="p-4 space-y-2">
            <a href="main_dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-tachometer-alt w-5"></i>
                <span>لوحة التحكم</span>
            </a>
            <a href="project_phases.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-tasks w-5"></i>
                <span>مراحل المشاريع</span>
            </a>
            <a href="financial_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary-50 text-primary border-r-4 border-primary">
                <i class="fas fa-chart-line w-5"></i>
                <span class="font-medium">المركز المالي</span>
            </a>
            <a href="tax_invoice_generator.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-file-invoice w-5"></i>
                <span>مولد الفواتير الضريبية</span>
            </a>
            <a href="team_management.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-users w-5"></i>
                <span>إدارة الفريق</span>
            </a>
            <a href="project_expenses.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-receipt w-5"></i>
                <span>مصاريف المشاريع</span>
            </a>
            <a href="subcontractor_contracts.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-handshake w-5"></i>
                <span>عقود المقاولين الفرعيين</span>
            </a>
            <a href="project_information.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-info-circle w-5"></i>
                <span>معلومات المشاريع</span>
            </a>
            <a href="payment_tracking.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-credit-card w-5"></i>
                <span>تتبع المدفوعات</span>
            </a>
            <a href="employee_management.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-user-tie w-5"></i>
                <span>إدارة الموظفين</span>
            </a>
            <a href="system_settings.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-cog w-5"></i>
                <span>إعدادات النظام</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="mr-64 min-h-screen">
        <!-- Top Header -->
        <header class="bg-surface shadow-card px-6 py-4 border-b border-border">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-text-primary">المركز المالي</h1>
                    <p class="text-text-secondary">إدارة الفواتير والعروض المالية والامتثال الضريبي</p>
                </div>
                
                <!-- Quick Actions & Search -->
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" placeholder="البحث في الفواتير والعروض..." class="w-80 px-4 py-2 pr-10 border border-border rounded-lg focus:border-primary focus:outline-none" />
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary"></i>
                    </div>
                    
                    <!-- Notifications -->
                    <div class="relative">
                        <button class="p-2 rounded-lg hover:bg-secondary-100 transition-fast relative">
                            <i class="fas fa-bell text-text-secondary text-lg"></i>
                            <span class="absolute -top-1 -left-1 w-5 h-5 bg-error text-white text-xs rounded-full flex items-center justify-center">5</span>
                        </button>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="flex items-center gap-3">
                        <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="صورة المستخدم" class="w-10 h-10 rounded-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                        <div>
                            <p class="font-medium text-text-primary">سارة المحاسبة</p>
                            <p class="text-sm text-text-secondary">مدير مالي</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Financial Center Content -->
        <main class="p-6 space-y-6">
            <!-- Financial KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Revenue -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium">إجمالي الإيرادات</p>
                            <p class="text-3xl font-bold text-text-primary mt-2">2,450,000 ريال</p>
                            <div class="flex items-center gap-1 mt-2">
                                <i class="fas fa-arrow-up text-success text-sm"></i>
                                <span class="text-success text-sm font-medium">+18.5% هذا الشهر</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-success text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Invoices -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium">الفواتير المعلقة</p>
                            <p class="text-3xl font-bold text-text-primary mt-2">320,000 ريال</p>
                            <div class="flex items-center gap-1 mt-2">
                                <i class="fas fa-exclamation-triangle text-warning text-sm"></i>
                                <span class="text-warning text-sm font-medium">12 فاتورة معلقة</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-invoice text-warning text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Pending Quotations -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium">العروض المعلقة</p>
                            <p class="text-3xl font-bold text-text-primary mt-2">8</p>
                            <div class="flex items-center gap-1 mt-2">
                                <i class="fas fa-clock text-accent text-sm"></i>
                                <span class="text-accent text-sm font-medium">تحتاج موافقة</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-accent-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-contract text-accent text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Tax Compliance -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm font-medium">الامتثال الضريبي</p>
                            <p class="text-3xl font-bold text-text-primary mt-2" id="taxComplianceRate">98%</p>
                            <div class="flex items-center gap-1 mt-2">
                                <i class="fas fa-shield-alt text-success text-sm"></i>
                                <span class="text-success text-sm font-medium" id="taxComplianceNote">متوافق مع الزكاة</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-certificate text-primary text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                <h3 class="text-lg font-bold text-text-primary mb-6">الإجراءات السريعة</h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <button class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-secondary-50 transition-fast group" onclick="openQuotationModal()">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center group-hover:bg-primary-200 transition-fast">
                            <i class="fas fa-plus text-primary text-lg"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary text-center">عرض سعر جديد</span>
                    </button>

                    <a href="tax_invoice_generator.html" class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-secondary-50 transition-fast group">
                        <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center group-hover:bg-success-200 transition-fast">
                            <i class="fas fa-file-invoice text-success text-lg"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary text-center">إنشاء فاتورة</span>
                    </a>

                    <button class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-secondary-50 transition-fast group" onclick="generateReport()">
                        <div class="w-12 h-12 bg-accent-100 rounded-lg flex items-center justify-center group-hover:bg-accent-200 transition-fast">
                            <i class="fas fa-chart-bar text-accent text-lg"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary text-center">تقرير مالي</span>
                    </button>

                    <a href="payment_tracking.html" class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-secondary-50 transition-fast group">
                        <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center group-hover:bg-warning-200 transition-fast">
                            <i class="fas fa-credit-card text-warning text-lg"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary text-center">تتبع المدفوعات</span>
                    </a>

                    <button class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-secondary-50 transition-fast group" onclick="exportData()">
                        <div class="w-12 h-12 bg-secondary-200 rounded-lg flex items-center justify-center group-hover:bg-secondary-300 transition-fast">
                            <i class="fas fa-download text-secondary text-lg"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary text-center">تصدير البيانات</span>
                    </button>

                    <button class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-secondary-50 transition-fast group" onclick="openTaxSettings()">
                        <div class="w-12 h-12 bg-error-100 rounded-lg flex items-center justify-center group-hover:bg-error-200 transition-fast">
                            <i class="fas fa-cog text-error text-lg"></i>
                        </div>
                        <span class="text-sm font-medium text-text-primary text-center">إعدادات الضرائب</span>
                    </button>
                </div>
            </div>

            <!-- Generated Report Summary -->
            <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-text-primary">ملخص التقارير الأخيرة</h3>
                        <p class="text-sm text-text-secondary">أحدث النتائج الناتجة عن الإجراءات السريعة</p>
                    </div>
                    <button id="clearReportHistory" type="button" class="text-sm text-text-secondary hover:text-text-primary hidden">
                        <i class="fas fa-undo ml-2"></i>
                        إعادة التعيين
                    </button>
                </div>
                <div class="space-y-3" id="reportResultsList">
                    <p class="text-sm text-text-secondary">لم يتم إنشاء تقارير بعد. استخدم زر "تقرير مالي" لعرض ملخص فوري.</p>
                </div>
            </div>

            <!-- Financial Analytics & Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Cash Flow Chart -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-text-primary">التدفق النقدي</h3>
                        <select class="px-3 py-1 border border-border rounded-lg text-sm">
                            <option>آخر 6 أشهر</option>
                            <option>آخر سنة</option>
                            <option>السنة الحالية</option>
                        </select>
                    </div>
                    
                    <!-- Chart Placeholder -->
                    <div class="h-64 bg-secondary-50 rounded-lg flex items-center justify-center relative overflow-hidden">
                        <svg class="w-full h-full" viewBox="0 0 400 200">
                            <!-- Chart Background Grid -->
                            <defs>
                                <pattern id="grid" width="40" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 20" fill="none" stroke="#E2E8F0" stroke-width="1"/>
                                </pattern>
                                <linearGradient id="cashFlowGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#10B981;stop-opacity:0.3"/>
                                    <stop offset="100%" style="stop-color:#10B981;stop-opacity:0.1"/>
                                </linearGradient>
                            </defs>
                            
                            <!-- Grid -->
                            <rect width="100%" height="100%" fill="url(#grid)"/>
                            
                            <!-- Income Line -->
                            <polyline fill="none" stroke="#10B981" stroke-width="3" points="20,140 80,120 140,100 200,80 260,60 320,40 380,30"/>
                            
                            <!-- Expense Line -->
                            <polyline fill="none" stroke="#EF4444" stroke-width="3" points="20,160 80,150 140,130 200,120 260,110 320,100 380,90"/>
                            
                            <!-- Income Area -->
                            <polygon fill="url(#cashFlowGradient)" points="20,140 80,120 140,100 200,80 260,60 320,40 380,30 380,180 20,180"/>
                            
                            <!-- Data Points -->
                            <circle cx="380" cy="30" r="4" fill="#10B981"/>
                            <circle cx="380" cy="90" r="4" fill="#EF4444"/>
                        </svg>
                        
                        <!-- Legend -->
                        <div class="absolute top-4 left-4 bg-white rounded-lg p-2 shadow-card">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-3 h-3 bg-success rounded-full"></div>
                                <span class="text-xs text-text-secondary">الإيرادات</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-error rounded-full"></div>
                                <span class="text-xs text-text-secondary">المصروفات</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Financial Activity -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-text-primary">النشاط المالي الأخير</h3>
                        <button class="text-primary hover:text-primary-700 text-sm font-medium">عرض الكل</button>
                    </div>
                    
                    <div class="space-y-4" id="recentFinancialActivity">
                        <!-- Activity 1 -->
                        <div class="flex items-start gap-3 p-3 border border-border rounded-lg">
                            <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-check text-success text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-text-primary">تم استلام دفعة</p>
                                <p class="text-xs text-text-secondary">فيلا الرياض الحديثة - 125,000 ريال</p>
                                <p class="text-xs text-text-secondary mt-1">منذ ساعة واحدة</p>
                            </div>
                            <span class="text-success font-bold text-sm">+125K</span>
                        </div>

                        <!-- Activity 2 -->
                        <div class="flex items-start gap-3 p-3 border border-border rounded-lg">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-file-invoice text-primary text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-text-primary">تم إنشاء فاتورة ضريبية</p>
                                <p class="text-xs text-text-secondary">مجمع تجاري جدة - INV-2025-0847</p>
                                <p class="text-xs text-text-secondary mt-1">منذ 3 ساعات</p>
                            </div>
                            <span class="text-primary font-bold text-sm">85K</span>
                        </div>

                        <!-- Activity 3 -->
                        <div class="flex items-start gap-3 p-3 border border-border rounded-lg">
                            <div class="w-8 h-8 bg-warning-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-file-contract text-warning text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-text-primary">عرض سعر جديد</p>
                                <p class="text-xs text-text-secondary">مشروع سكني الدمام - QUO-2025-0156</p>
                                <p class="text-xs text-text-secondary mt-1">منذ 5 ساعات</p>
                            </div>
                            <span class="text-warning font-bold text-sm">650K</span>
                        </div>

                        <!-- Activity 4 -->
                        <div class="flex items-start gap-3 p-3 border border-border rounded-lg">
                            <div class="w-8 h-8 bg-accent-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-accent text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-text-primary">تذكير دفعة متأخرة</p>
                                <p class="text-xs text-text-secondary">شركة الأندلس للاستثمار - 45,000 ريال</p>
                                <p class="text-xs text-text-secondary mt-1">أمس</p>
                            </div>
                            <span class="text-error font-bold text-sm">متأخر</span>
                        </div>

                        <!-- Activity 5 -->
                        <div class="flex items-start gap-3 p-3 border border-border rounded-lg">
                            <div class="w-8 h-8 bg-secondary-200 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-chart-bar text-secondary text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-text-primary">تقرير مالي شهري</p>
                                <p class="text-xs text-text-secondary">تم إنشاء تقرير أكتوبر 2025</p>
                                <p class="text-xs text-text-secondary mt-1">منذ يومين</p>
                            </div>
                            <button class="text-primary text-xs hover:underline">تحميل</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices & Quotations Management -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recent Invoices -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-text-primary">الفواتير الأخيرة</h3>
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-1 text-xs border border-border rounded-lg hover:bg-secondary-50">
                                <i class="fas fa-filter ml-1"></i>
                                تصفية
                            </button>
                            <a href="tax_invoice_generator.html" class="text-primary hover:text-primary-700 text-sm font-medium">عرض الكل</a>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <!-- Invoice 1 -->
                        <div class="flex items-center gap-4 p-4 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-invoice text-success"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-text-primary">INV-2025-0847</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-success-100 text-success">
                                        مدفوعة
                                    </span>
                                </div>
                                <p class="text-sm text-text-secondary">محمد العبدالله - فيلا الرياض</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-sm text-text-secondary">04/10/2025</span>
                                    <span class="font-bold text-text-primary">125,000 ريال</span>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice 2 -->
                        <div class="flex items-center gap-4 p-4 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-invoice text-warning"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-text-primary">INV-2025-0846</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-warning-100 text-warning">
                                        معلقة
                                    </span>
                                </div>
                                <p class="text-sm text-text-secondary">شركة الأندلس - مجمع تجاري</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-sm text-text-secondary">02/10/2025</span>
                                    <span class="font-bold text-text-primary">85,000 ريال</span>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice 3 -->
                        <div class="flex items-center gap-4 p-4 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <div class="w-12 h-12 bg-error-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-invoice text-error"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-text-primary">INV-2025-0845</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-error-100 text-error">
                                        متأخرة
                                    </span>
                                </div>
                                <p class="text-sm text-text-secondary">فهد الخالدي - مشروع الدمام</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-sm text-text-secondary">28/09/2025</span>
                                    <span class="font-bold text-text-primary">45,000 ريال</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Quotations -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-text-primary">عروض الأسعار الأخيرة</h3>
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-1 text-xs border border-border rounded-lg hover:bg-secondary-50">
                                <i class="fas fa-filter ml-1"></i>
                                تصفية
                            </button>
                            <button class="text-primary hover:text-primary-700 text-sm font-medium" onclick="openQuotationModal()">عرض الكل</button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <!-- Quotation 1 -->
                        <div class="flex items-center gap-4 p-4 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-contract text-primary"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-text-primary">QUO-2025-0156</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-accent-100 text-accent">
                                        قيد المراجعة
                                    </span>
                                </div>
                                <p class="text-sm text-text-secondary">عبدالرحمن السعود - فيلا الخبر</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-sm text-text-secondary">03/10/2025</span>
                                    <span class="font-bold text-text-primary">750,000 ريال</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quotation 2 -->
                        <div class="flex items-center gap-4 p-4 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-contract text-success"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-text-primary">QUO-2025-0155</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-success-100 text-success">
                                        موافق عليه
                                    </span>
                                </div>
                                <p class="text-sm text-text-secondary">نورا التجارية - مكاتب إدارية</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-sm text-text-secondary">01/10/2025</span>
                                    <span class="font-bold text-text-primary">420,000 ريال</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quotation 3 -->
                        <div class="flex items-center gap-4 p-4 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <div class="w-12 h-12 bg-secondary-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-contract text-secondary"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-text-primary">QUO-2025-0154</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-secondary-200 text-secondary">
                                        مسودة
                                    </span>
                                </div>
                                <p class="text-sm text-text-secondary">خالد الشركة - مستودعات</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-sm text-text-secondary">30/09/2025</span>
                                    <span class="font-bold text-text-primary">280,000 ريال</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tax Compliance & Integration Status -->
            <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                <h3 class="text-lg font-bold text-text-primary mb-6">حالة الامتثال الضريبي والتكامل</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Saudi Tax Authority Status -->
                    <div class="text-center p-4 border border-border rounded-lg">
                        <div class="w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-shield-alt text-success text-2xl"></i>
                        </div>
                        <h4 class="font-medium text-text-primary mb-2">هيئة الزكاة والضريبة</h4>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-success-100 text-success">
                            <i class="fas fa-check ml-1"></i>
                            متصل ومتوافق
                        </span>
                        <p class="text-xs text-text-secondary mt-2">آخر مزامنة: 04/10/2025 07:30</p>
                    </div>

                    <!-- Barcode Generation -->
                    <div class="text-center p-4 border border-border rounded-lg">
                        <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-qrcode text-primary text-2xl"></i>
                        </div>
                        <h4 class="font-medium text-text-primary mb-2">مولد الباركود</h4>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary">
                            <i class="fas fa-cog ml-1"></i>
                            نشط
                        </span>
                        <p class="text-xs text-text-secondary mt-2">847 باركود تم إنشاؤه</p>
                    </div>

                    <!-- Payment Gateway -->
                    <div class="text-center p-4 border border-border rounded-lg">
                        <div class="w-16 h-16 bg-accent-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-credit-card text-accent text-2xl"></i>
                        </div>
                        <h4 class="font-medium text-text-primary mb-2">بوابة الدفع</h4>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-accent-100 text-accent">
                            <i class="fas fa-link ml-1"></i>
                            متكامل
                        </span>
                        <p class="text-xs text-text-secondary mt-2">مدى، فيزا، ماستركارد</p>
                    </div>
                </div>

                <!-- Integration Actions -->
                <div class="mt-6 pt-6 border-t border-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-text-primary">إعدادات التكامل</h4>
                            <p class="text-sm text-text-secondary">إدارة الاتصالات مع الأنظمة الخارجية</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="px-4 py-2 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                                <i class="fas fa-sync-alt ml-2"></i>
                                مزامنة البيانات
                            </button>
                            <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-700 transition-fast">
                                <i class="fas fa-cog ml-2"></i>
                                إعدادات التكامل
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-surface border-t border-border px-6 py-4 mt-8">
            <div class="flex items-center justify-between text-sm text-text-secondary">
                <p>© 2025 ContractorPro. جميع الحقوق محفوظة.</p>
                <p>آخر تحديث: 4 أكتوبر 2025 - 07:34</p>
            </div>
        </footer>
    </div>

    <!-- Quotation Modal -->
    <div id="quotationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-surface rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-text-primary">إنشاء عرض سعر جديد</h3>
                    <button onclick="closeQuotationModal()" class="p-2 hover:bg-secondary-100 rounded-lg transition-fast">
                        <i class="fas fa-times text-text-secondary"></i>
                    </button>
                </div>

                <form class="space-y-4">
                    <!-- Client Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">اسم العميل</label>
                            <input type="text" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="أدخل اسم العميل" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">رقم الهاتف</label>
                            <input type="tel" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="05xxxxxxxx" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">البريد الإلكتروني</label>
                        <input type="email" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="client@example.com" />
                    </div>

                    <!-- Project Details -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">نوع المشروع</label>
                        <select class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none">
                            <option>اختر نوع المشروع</option>
                            <option>فيلا سكنية</option>
                            <option>مجمع تجاري</option>
                            <option>مكاتب إدارية</option>
                            <option>مستودعات</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">المساحة (متر مربع)</label>
                            <input type="number" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">المدة المتوقعة (شهر)</label>
                            <input type="number" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="12" />
                        </div>
                    </div>

                    <!-- Line Items -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">بنود العرض</label>
                        <div class="space-y-2" id="lineItems">
                            <div class="flex items-center gap-2">
                                <input type="text" class="flex-1 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="وصف البند" />
                                <input type="number" class="w-32 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="الكمية" />
                                <input type="number" class="w-32 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="السعر" />
                                <button type="button" class="p-2 text-error hover:bg-error-100 rounded-lg transition-fast">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" onclick="addLineItem()" class="mt-2 px-4 py-2 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة بند
                        </button>
                    </div>

                    <!-- Total -->
                    <div class="bg-secondary-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-text-primary">المجموع الكلي (شامل الضريبة)</span>
                            <span class="text-xl font-bold text-text-primary">0 ريال</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-primary-700 transition-fast">
                            <i class="fas fa-save ml-2"></i>
                            حفظ العرض
                        </button>
                        <button type="button" class="px-6 py-2 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            <i class="fas fa-eye ml-2"></i>
                            معاينة
                        </button>
                        <button type="button" onclick="closeQuotationModal()" class="px-6 py-2 border border-border rounded-lg hover:bg-secondary-50 transition-fast">
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="actionToast" class="fixed bottom-6 left-6 z-50 w-full max-w-sm bg-surface border border-border shadow-modal rounded-xl p-4 hidden" role="status" aria-live="polite">
        <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-primary-100 text-primary" id="actionToastIconWrapper">
                <i class="fas fa-info text-lg" id="actionToastIcon"></i>
            </div>
            <div class="flex-1 space-y-1">
                <p class="text-sm font-bold text-text-primary" id="actionToastTitle">تم تنفيذ الإجراء</p>
                <p class="text-sm text-text-secondary" id="actionToastMessage">سيتم تحديث التفاصيل فوراً.</p>
            </div>
            <button type="button" class="text-text-secondary hover:text-text-primary" aria-label="إغلاق التنبيه" onclick="hideActionToast()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Tax Settings Modal -->
    <div id="taxSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-surface rounded-xl p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-text-primary">إعدادات الضرائب والامتثال</h3>
                    <button type="button" onclick="closeTaxSettingsModal()" class="p-2 hover:bg-secondary-100 rounded-lg transition-fast" aria-label="إغلاق النافذة">
                        <i class="fas fa-times text-text-secondary"></i>
                    </button>
                </div>

                <form id="taxSettingsForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="vatRate" class="block text-sm font-medium text-text-primary mb-2">نسبة ضريبة القيمة المضافة (%)</label>
                            <input type="number" id="vatRate" name="vatRate" min="0" max="100" step="0.5" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="15" />
                        </div>
                        <div>
                            <label for="withholdingRate" class="block text-sm font-medium text-text-primary mb-2">نسبة الاستقطاع الضريبي (%)</label>
                            <input type="number" id="withholdingRate" name="withholdingRate" min="0" max="100" step="0.5" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="5" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="complianceScore" class="block text-sm font-medium text-text-primary mb-2">مؤشر الامتثال (%)</label>
                            <input type="number" id="complianceScore" name="complianceScore" min="0" max="100" step="1" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="98" />
                        </div>
                        <div>
                            <label for="taxPeriod" class="block text-sm font-medium text-text-primary mb-2">دورية الإقرار الضريبي</label>
                            <select id="taxPeriod" name="taxPeriod" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none">
                                <option value="monthly">شهري</option>
                                <option value="quarterly">ربع سنوي</option>
                                <option value="yearly">سنوي</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="zakatStatus" class="block text-sm font-medium text-text-primary mb-2">حالة الالتزام بالزكاة</label>
                        <select id="zakatStatus" name="zakatStatus" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none">
                            <option value="compliant">متوافق بالكامل</option>
                            <option value="review">قيد المراجعة</option>
                            <option value="attention">يحتاج إلى متابعة</option>
                        </select>
                    </div>

                    <div>
                        <label for="taxNotes" class="block text-sm font-medium text-text-primary mb-2">ملاحظات إضافية</label>
                        <textarea id="taxNotes" name="taxNotes" rows="3" class="w-full px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="أدخل أي ملاحظات حول الالتزام أو المتطلبات الخاصة."></textarea>
                    </div>

                    <label class="inline-flex items-center gap-2 text-sm text-text-secondary">
                        <input type="checkbox" id="autoReminder" name="autoReminder" class="rounded border-border text-primary focus:ring-primary">
                        إرسال تذكير تلقائي قبل موعد الإقرار
                    </label>

                    <div class="bg-secondary-50 border border-border rounded-lg p-4" id="taxSettingsPreview">
                        <h4 class="text-sm font-medium text-text-primary mb-2">نظرة سريعة على الإعدادات</h4>
                        <ul class="space-y-1 text-sm text-text-secondary" id="taxSettingsSummary">
                            <li>نسبة ضريبة القيمة المضافة: <span class="font-medium text-text-primary">15%</span></li>
                            <li>دورية الإقرار: <span class="font-medium text-text-primary">شهري</span></li>
                            <li>التذكير التلقائي: <span class="font-medium text-text-primary">مفعل</span></li>
                        </ul>
                    </div>

                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 pt-4">
                        <p class="text-xs text-text-secondary" id="taxSettingsUpdatedAt">آخر تحديث محفوظ: —</p>
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="closeTaxSettingsModal()" class="px-4 py-2 border border-border rounded-lg hover:bg-secondary-50 transition-fast">إلغاء</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-700 transition-fast">حفظ الإعدادات</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const REPORT_PRESETS = {
            monthly: {
                title: 'التقرير المالي الشهري',
                period: 'أبريل 2025',
                revenue: 2450000,
                expenses: 1785000,
                tax: 268000,
                netProfit: 396000,
                trend: '+6.4%'
            },
            quarterly: {
                title: 'التقرير المالي الربعي',
                period: 'الربع الأول 2025',
                revenue: 7120000,
                expenses: 5335000,
                tax: 795000,
                netProfit: 990000,
                trend: '+4.1%'
            },
            tax: {
                title: 'تقرير الالتزام الضريبي',
                period: 'السنة المالية 2024',
                revenue: 9580000,
                expenses: 7030000,
                tax: 1280000,
                netProfit: 1270000,
                trend: '+2.8%'
            }
        };

        const FINANCIAL_EXPORT_DATA = [
            { project: 'فيلا الرياض الحديثة', revenue: 1250000, expenses: 820000, tax: 187500 },
            { project: 'برج جدة التجاري', revenue: 1840000, expenses: 1325000, tax: 276000 },
            { project: 'مستودعات الدمام اللوجستية', revenue: 980000, expenses: 640000, tax: 147000 },
            { project: 'مجمع المدينة الطبي', revenue: 2120000, expenses: 1650000, tax: 318000 }
        ];

        const DEFAULT_TAX_SETTINGS = {
            vatRate: 15,
            withholdingRate: 5,
            complianceScore: 98,
            taxPeriod: 'monthly',
            zakatStatus: 'compliant',
            autoReminder: true,
            notes: '',
            updatedAt: null
        };

        const TAX_SETTINGS_STORAGE_KEY = 'contractorPro.taxSettings';
        let taxSettingsCache = null;
        let toastHideTimeout = null;

        function openQuotationModal() {
            const modal = document.getElementById('quotationModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeQuotationModal() {
            const modal = document.getElementById('quotationModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function addLineItem() {
            const lineItems = document.getElementById('lineItems');
            if (!lineItems) return;
            const newItem = document.createElement('div');
            newItem.className = 'flex items-center gap-2';
            newItem.innerHTML = `
                <input type="text" class="flex-1 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="وصف البند">
                <input type="number" class="w-32 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="الكمية">
                <input type="number" class="w-32 px-3 py-2 border border-border rounded-lg focus:border-primary focus:outline-none" placeholder="السعر">
                <button type="button" onclick="removeLineItem(this)" class="p-2 text-error hover:bg-error-100 rounded-lg transition-fast">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            lineItems.appendChild(newItem);
        }

        function removeLineItem(button) {
            if (button && button.parentElement) {
                button.parentElement.remove();
            }
        }

        function formatCurrency(value) {
            const formatter = new Intl.NumberFormat('ar-SA', { minimumFractionDigits: 0 });
            return `${formatter.format(Math.round(Number(value) || 0))} ريال`;
        }

        function formatCompactCurrency(value) {
            const formatter = new Intl.NumberFormat('ar-SA', { notation: 'compact', maximumFractionDigits: 1 });
            const numericValue = Number(value) || 0;
            const sign = numericValue >= 0 ? '+' : '-';
            return `${sign}${formatter.format(Math.abs(numericValue))}`;
        }

        function formatDateTime(value) {
            if (!value) {
                return '—';
            }
            try {
                return new Date(value).toLocaleString('ar-SA', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });
            } catch (error) {
                return value;
            }
        }

        function getNowTimestamp() {
            return `الساعة ${new Date().toLocaleString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            })}`;
        }

        function showActionFeedback(message, type = 'info', title = 'تم تنفيذ الإجراء') {
            const toast = document.getElementById('actionToast');
            if (!toast) return;

            const iconWrapper = document.getElementById('actionToastIconWrapper');
            const icon = document.getElementById('actionToastIcon');
            const titleEl = document.getElementById('actionToastTitle');
            const messageEl = document.getElementById('actionToastMessage');

            const typeConfig = {
                success: { wrapper: 'bg-success-100 text-success', icon: 'fa-check-circle' },
                warning: { wrapper: 'bg-warning-100 text-warning', icon: 'fa-exclamation-triangle' },
                error: { wrapper: 'bg-error-100 text-error', icon: 'fa-times-circle' },
                info: { wrapper: 'bg-primary-100 text-primary', icon: 'fa-info-circle' }
            };

            const config = typeConfig[type] || typeConfig.info;

            if (iconWrapper) {
                iconWrapper.className = `w-10 h-10 rounded-lg flex items-center justify-center ${config.wrapper}`;
            }
            if (icon) {
                icon.className = `fas ${config.icon} text-lg`;
            }
            if (titleEl) {
                titleEl.textContent = title;
            }
            if (messageEl) {
                messageEl.textContent = message;
            }

            toast.classList.remove('hidden');

            if (toastHideTimeout) {
                clearTimeout(toastHideTimeout);
            }

            toastHideTimeout = window.setTimeout(() => {
                hideActionToast();
            }, 4000);
        }

        function hideActionToast() {
            const toast = document.getElementById('actionToast');
            if (!toast) return;
            toast.classList.add('hidden');
            if (toastHideTimeout) {
                clearTimeout(toastHideTimeout);
                toastHideTimeout = null;
            }
        }

        function addRecentActivity({ title, subtitle, amount, amountClass, badgeClass, icon, timestamp }) {
            const container = document.getElementById('recentFinancialActivity');
            if (!container) return;

            const item = document.createElement('div');
            item.className = 'flex items-start gap-3 p-3 border border-border rounded-lg';

            const iconWrapper = document.createElement('div');
            iconWrapper.className = `w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${badgeClass || 'bg-primary-100 text-primary'}`;
            const iconElement = document.createElement('i');
            iconElement.className = `fas ${icon || 'fa-info-circle'} text-sm`;
            iconWrapper.appendChild(iconElement);
            item.appendChild(iconWrapper);

            const body = document.createElement('div');
            body.className = 'flex-1';
            const titleEl = document.createElement('p');
            titleEl.className = 'text-sm font-medium text-text-primary';
            titleEl.textContent = title;
            body.appendChild(titleEl);

            if (subtitle) {
                const subtitleEl = document.createElement('p');
                subtitleEl.className = 'text-xs text-text-secondary';
                subtitleEl.textContent = subtitle;
                body.appendChild(subtitleEl);
            }

            if (timestamp) {
                const timeEl = document.createElement('p');
                timeEl.className = 'text-xs text-text-secondary mt-1';
                timeEl.textContent = timestamp;
                body.appendChild(timeEl);
            }

            item.appendChild(body);

            if (amount) {
                const amountEl = document.createElement('span');
                amountEl.className = `${amountClass || 'text-text-primary'} font-bold text-sm`;
                amountEl.textContent = amount;
                item.appendChild(amountEl);
            }

            container.prepend(item);

            while (container.children.length > 6) {
                container.removeChild(container.lastElementChild);
            }
        }

        function updateReportResults(report) {
            const list = document.getElementById('reportResultsList');
            if (!list) return;

            if (!list.dataset.initialized) {
                list.innerHTML = '';
                list.dataset.initialized = 'true';
                const clearButton = document.getElementById('clearReportHistory');
                if (clearButton) {
                    clearButton.classList.remove('hidden');
                }
            }

            const card = document.createElement('div');
            card.className = 'p-4 border border-border rounded-lg bg-secondary-50 space-y-3';

            const netPositive = Number(report.netProfit) >= 0;
            const trendBadgeClass = netPositive ? 'bg-success-100 text-success' : 'bg-error-100 text-error';
            const trendIcon = netPositive ? 'fa-arrow-up' : 'fa-arrow-down';

            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-text-secondary">${report.period || 'البيانات الحالية'}</p>
                        <h4 class="text-lg font-bold text-text-primary">${report.title}</h4>
                    </div>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${trendBadgeClass}">
                        <i class="fas ${trendIcon} ml-1"></i>
                        ${report.trend || '0%'}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-text-secondary">الإيرادات</span>
                        <span class="font-medium text-text-primary">${formatCurrency(report.revenue)}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-text-secondary">المصروفات</span>
                        <span class="font-medium text-text-primary">${formatCurrency(report.expenses)}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-text-secondary">الضريبة المستحقة</span>
                        <span class="font-medium text-text-primary">${formatCurrency(report.tax)}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-text-secondary">صافي الربح</span>
                        <span class="font-bold ${netPositive ? 'text-success' : 'text-error'}">${formatCurrency(report.netProfit)}</span>
                    </div>
                </div>
                <p class="text-xs text-text-secondary">تم التحديث في ${formatDateTime(report.generatedAt)}</p>
            `;

            list.prepend(card);

            while (list.children.length > 3) {
                list.removeChild(list.lastElementChild);
            }
        }

        function clearReportHistory() {
            const list = document.getElementById('reportResultsList');
            const clearButton = document.getElementById('clearReportHistory');
            if (!list) return;
            list.dataset.initialized = '';
            list.innerHTML = '<p class="text-sm text-text-secondary">لم يتم إنشاء تقارير بعد. استخدم زر "تقرير مالي" لعرض ملخص فوري.</p>';
            if (clearButton) {
                clearButton.classList.add('hidden');
            }
        }

        function createCustomReportSummary() {
            const totals = FINANCIAL_EXPORT_DATA.reduce((acc, item) => {
                acc.revenue += Number(item.revenue) || 0;
                acc.expenses += Number(item.expenses) || 0;
                acc.tax += Number(item.tax) || 0;
                return acc;
            }, { revenue: 0, expenses: 0, tax: 0 });

            const netProfit = totals.revenue - (totals.expenses + totals.tax);

            return {
                title: 'التقرير المالي المخصص',
                period: 'بيانات المشاريع الحالية',
                revenue: totals.revenue,
                expenses: totals.expenses,
                tax: totals.tax,
                netProfit,
                trend: netProfit >= 0 ? '+2.1%' : '-2.1%'
            };
        }

        function generateReport(type = 'custom') {
            const preset = REPORT_PRESETS[type] || createCustomReportSummary();
            const report = {
                ...preset,
                generatedAt: new Date().toISOString()
            };

            updateReportResults(report);

            addRecentActivity({
                title: report.title,
                subtitle: `الفترة: ${report.period || 'البيانات الحالية'}`,
                amount: `${formatCompactCurrency(report.netProfit)} ريال`,
                amountClass: report.netProfit >= 0 ? 'text-success' : 'text-error',
                badgeClass: 'bg-primary-100 text-primary',
                icon: 'fa-chart-line',
                timestamp: getNowTimestamp()
            });

            showActionFeedback(`تم إنشاء ${report.title} بنجاح.`, 'success', report.title);
        }

        function exportData() {
            const rows = [
                ['المشروع', 'الإيرادات', 'المصروفات', 'الضريبة المستحقة', 'صافي الربح']
            ];

            FINANCIAL_EXPORT_DATA.forEach((item) => {
                const net = (Number(item.revenue) || 0) - ((Number(item.expenses) || 0) + (Number(item.tax) || 0));
                rows.push([
                    item.project,
                    Number(item.revenue) || 0,
                    Number(item.expenses) || 0,
                    Number(item.tax) || 0,
                    net
                ]);
            });

            const csvContent = rows.map((row) => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `financial-summary-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            addRecentActivity({
                title: 'تصدير البيانات المالية',
                subtitle: 'تم إنشاء ملف CSV يحتوي على ملخص المشاريع النشطة',
                amount: '',
                amountClass: 'text-text-secondary',
                badgeClass: 'bg-secondary-200 text-secondary',
                icon: 'fa-download',
                timestamp: getNowTimestamp()
            });

            showActionFeedback('تم تصدير البيانات المالية بصيغة CSV بنجاح.', 'success', 'تصدير البيانات');
        }

        function openTaxSettings() {
            const modal = document.getElementById('taxSettingsModal');
            if (!modal) return;
            loadTaxSettingsForm();
            modal.classList.remove('hidden');

            window.setTimeout(() => {
                const vatInput = document.getElementById('vatRate');
                if (vatInput) {
                    vatInput.focus();
                }
            }, 100);
        }

        function closeTaxSettingsModal() {
            const modal = document.getElementById('taxSettingsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function loadTaxSettingsForm() {
            const stored = localStorage.getItem(TAX_SETTINGS_STORAGE_KEY);
            let settings = { ...DEFAULT_TAX_SETTINGS };

            if (stored) {
                try {
                    settings = { ...settings, ...JSON.parse(stored) };
                } catch (error) {
                    console.warn('تعذر قراءة إعدادات الضرائب المخزنة.', error);
                }
            }

            taxSettingsCache = settings;

            const form = document.getElementById('taxSettingsForm');
            if (form) {
                form.vatRate.value = settings.vatRate;
                form.withholdingRate.value = settings.withholdingRate;
                form.complianceScore.value = settings.complianceScore;
                form.taxPeriod.value = settings.taxPeriod;
                form.zakatStatus.value = settings.zakatStatus;
                form.taxNotes.value = settings.notes || '';
                form.autoReminder.checked = Boolean(settings.autoReminder);
            }

            updateTaxSettingsSummary(settings);
            applyTaxSettingsToUi(settings);
        }

        function updateTaxSettingsSummary(settings) {
            const summary = document.getElementById('taxSettingsSummary');
            const updatedAt = document.getElementById('taxSettingsUpdatedAt');

            if (summary) {
                summary.innerHTML = `
                    <li>نسبة ضريبة القيمة المضافة: <span class="font-medium text-text-primary">${settings.vatRate}%</span></li>
                    <li>نسبة الاستقطاع: <span class="font-medium text-text-primary">${settings.withholdingRate}%</span></li>
                    <li>دورية الإقرار: <span class="font-medium text-text-primary">${settings.taxPeriod === 'monthly' ? 'شهري' : settings.taxPeriod === 'quarterly' ? 'ربع سنوي' : 'سنوي'}</span></li>
                    <li>التذكير التلقائي: <span class="font-medium text-text-primary">${settings.autoReminder ? 'مفعل' : 'غير مفعل'}</span></li>
                `;
            }

            if (updatedAt) {
                updatedAt.textContent = `آخر تحديث محفوظ: ${settings.updatedAt ? formatDateTime(settings.updatedAt) : '—'}`;
            }
        }

        function applyTaxSettingsToUi(settings) {
            const complianceRate = document.getElementById('taxComplianceRate');
            const complianceNote = document.getElementById('taxComplianceNote');

            if (complianceRate) {
                complianceRate.textContent = `${settings.complianceScore}%`;
            }

            if (complianceNote) {
                complianceNote.classList.remove('text-success', 'text-warning', 'text-error');

                if (settings.zakatStatus === 'compliant') {
                    complianceNote.textContent = 'متوافق مع الزكاة';
                    complianceNote.classList.add('text-success');
                } else if (settings.zakatStatus === 'review') {
                    complianceNote.textContent = 'قيد المراجعة';
                    complianceNote.classList.add('text-warning');
                } else {
                    complianceNote.textContent = 'يتطلب متابعة عاجلة';
                    complianceNote.classList.add('text-error');
                }
            }
        }

        function saveTaxSettings(event) {
            event.preventDefault();

            const form = event.target;
            const settings = {
                vatRate: Number(form.vatRate.value) || 0,
                withholdingRate: Number(form.withholdingRate.value) || 0,
                complianceScore: Math.min(100, Math.max(0, Number(form.complianceScore.value) || 0)),
                taxPeriod: form.taxPeriod.value,
                zakatStatus: form.zakatStatus.value,
                notes: form.taxNotes.value.trim(),
                autoReminder: form.autoReminder.checked,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem(TAX_SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            taxSettingsCache = settings;

            updateTaxSettingsSummary(settings);
            applyTaxSettingsToUi(settings);

            addRecentActivity({
                title: 'تحديث إعدادات الضرائب',
                subtitle: settings.notes ? `ملاحظة: ${settings.notes}` : 'تم تحديث تفضيلات الامتثال الضريبي.',
                amount: '',
                amountClass: 'text-text-secondary',
                badgeClass: 'bg-error-100 text-error',
                icon: 'fa-shield-alt',
                timestamp: getNowTimestamp()
            });

            showActionFeedback('تم حفظ إعدادات الضرائب بنجاح.', 'success', 'حفظ الإعدادات');
            closeTaxSettingsModal();
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const footerTime = document.querySelector('footer p:last-child');
            if (footerTime) {
                footerTime.textContent = `آخر تحديث: ${timeString}`;
            }
        }

        setInterval(updateTime, 60000);

        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.shadow-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.15)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                });
            });

            const quotationModal = document.getElementById('quotationModal');
            if (quotationModal) {
                quotationModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeQuotationModal();
                    }
                });
            }

            const taxModal = document.getElementById('taxSettingsModal');
            if (taxModal) {
                taxModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeTaxSettingsModal();
                    }
                });
            }

            const taxForm = document.getElementById('taxSettingsForm');
            if (taxForm) {
                taxForm.addEventListener('submit', saveTaxSettings);
            }

            const clearButton = document.getElementById('clearReportHistory');
            if (clearButton) {
                clearButton.addEventListener('click', clearReportHistory);
            }

            loadTaxSettingsForm();
            updateTime();
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
    <script src="../js/session.js" data-login-path="../login.html"></script>
</body>
</html>