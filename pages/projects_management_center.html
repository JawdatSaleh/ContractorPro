<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مركز إدارة المشاريع - ContractorPro</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fcontractor7112back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
<script type="module" src="https://static.rocket.new/rocket-shot.js?v=0.0.1"></script>
</head>
<body class="bg-background font-arabic">
    <!-- Navigation Sidebar -->
    <div class="fixed right-0 top-0 h-full w-64 bg-surface shadow-modal z-50 transform transition-transform duration-300" id="sidebar">
        <div class="p-6 border-b border-border">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                    <i class="fas fa-hard-hat text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-text-primary">ContractorPro</h1>
                    <p class="text-sm text-text-secondary">نظام إدارة المقاولات</p>
                </div>
            </div>
        </div>
        
        <nav class="p-4 space-y-2">
            <!-- Dashboard -->
            <a href="main_dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-tachometer-alt w-5"></i>
                <span class="font-medium">الصفحة الرئيسية</span>
            </a>

            <!-- Projects Section -->
            <a href="projects_management_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary-50 text-primary border-r-4 border-primary">
                <i class="fas fa-building w-5"></i>
                <span>المشاريع</span>
                <i class="fas fa-chevron-left mr-auto text-xs"></i>
            </a>

            <!-- Finance Section -->
            <a href="financial_management_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-chart-line w-5"></i>
                <span>المالية</span>
                <i class="fas fa-chevron-left mr-auto text-xs"></i>
            </a>

            <!-- Employees Section -->
            <a href="employees_management_center.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-text-secondary hover:bg-secondary-100 transition-fast">
                <i class="fas fa-users w-5"></i>
                <span>الموظفين</span>
                <i class="fas fa-chevron-left mr-auto text-xs"></i>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="mr-64 min-h-screen">
        <!-- Top Header -->
        <header class="bg-surface shadow-card px-6 py-4 border-b border-border">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-text-primary">مركز إدارة المشاريع</h1>
                    <p class="text-text-secondary">إدارة شاملة لجميع المشاريع والعقود والمراحل</p>
                </div>
                
                <div class="flex items-center gap-4">
                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="window.location.href='project_creation_wizard.html'">
                        <i class="fas fa-plus"></i>
                        <span>مشروع جديد</span>
                    </button>
                    <button class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success-600 transition-fast flex items-center gap-2" onclick="exportProjectsData()">
                        <i class="fas fa-download"></i>
                        <span>تصدير البيانات</span>
                    </button>
                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="backToProjectsList()" id="backButton" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        <span>العودة للمشاريع</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-6">
            <!-- Projects List View (Default) -->
            <div id="projects-list" class="projects-view">
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-text-primary">جميع المشاريع</h2>
                        <div class="flex items-center gap-4">
                            <div class="bg-primary-50 px-4 py-2 rounded-lg">
                                <span class="text-primary font-bold text-lg">3</span>
                                <span class="text-primary text-sm mr-2">مشاريع نشطة</span>
                            </div>
                        </div>
                    </div>

                    <!-- Projects Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Project 1 -->
                        <div class="border border-border rounded-xl p-6 hover:shadow-lg transition-shadow cursor-pointer project-card" onclick="openProjectDetails('project-001', 'فيلا الرياض الحديثة')">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-text-primary">فيلا الرياض الحديثة</h3>
                                    <p class="text-sm text-text-secondary">العميل: محمد العبدالله</p>
                                </div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success-100 text-success">
                                    نشط
                                </span>
                            </div>
                            
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">قيمة المشروع:</span>
                                    <span class="font-bold text-text-primary">850,000 ريال</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">تاريخ البداية:</span>
                                    <span class="font-medium">1 يناير 2025</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">نسبة الإنجاز:</span>
                                    <span class="font-bold text-success">85%</span>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full bg-secondary-200 rounded-full h-2 mb-4">
                                <div class="bg-success h-2 rounded-full" style="width: 85%"></div>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm text-text-secondary">
                                <i class="fas fa-calendar-alt"></i>
                                <span>ينتهي في: 15 فبراير 2025</span>
                            </div>
                        </div>

                        <!-- Project 2 -->
                        <div class="border border-border rounded-xl p-6 hover:shadow-lg transition-shadow cursor-pointer project-card" onclick="openProjectDetails('project-002', 'مجمع تجاري جدة')">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-text-primary">مجمع تجاري جدة</h3>
                                    <p class="text-sm text-text-secondary">العميل: شركة الأندلس للاستثمار</p>
                                </div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-warning-100 text-warning">
                                    قيد التنفيذ
                                </span>
                            </div>
                            
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">قيمة المشروع:</span>
                                    <span class="font-bold text-text-primary">1,200,000 ريال</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">تاريخ البداية:</span>
                                    <span class="font-medium">10 يناير 2025</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">نسبة الإنجاز:</span>
                                    <span class="font-bold text-warning">45%</span>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full bg-secondary-200 rounded-full h-2 mb-4">
                                <div class="bg-warning h-2 rounded-full" style="width: 45%"></div>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm text-text-secondary">
                                <i class="fas fa-calendar-alt"></i>
                                <span>ينتهي في: 25 مارس 2025</span>
                            </div>
                        </div>

                        <!-- Project 3 -->
                        <div class="border border-border rounded-xl p-6 hover:shadow-lg transition-shadow cursor-pointer project-card" onclick="openProjectDetails('project-003', 'مشروع سكني الدمام')">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-text-primary">مشروع سكني الدمام</h3>
                                    <p class="text-sm text-text-secondary">العميل: فهد الخالدي</p>
                                </div>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-100 text-primary">
                                    بداية المشروع
                                </span>
                            </div>
                            
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">قيمة المشروع:</span>
                                    <span class="font-bold text-text-primary">650,000 ريال</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">تاريخ البداية:</span>
                                    <span class="font-medium">20 يناير 2025</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-secondary">نسبة الإنجاز:</span>
                                    <span class="font-bold text-primary">20%</span>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full bg-secondary-200 rounded-full h-2 mb-4">
                                <div class="bg-primary h-2 rounded-full" style="width: 20%"></div>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm text-text-secondary">
                                <i class="fas fa-calendar-alt"></i>
                                <span>ينتهي في: 15 أبريل 2025</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Details View (Hidden by default) -->
            <div id="project-details" class="projects-view hidden">
                <!-- Project Header -->
                <div class="bg-surface rounded-xl p-6 shadow-card border border-border mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-text-primary" id="currentProjectTitle">تفاصيل المشروع</h2>
                                <p class="text-text-secondary" id="currentProjectCode">#PRJ-001</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="openEditProjectModal()">
                                    <i class="fas fa-edit"></i>
                                    <span>تعديل المعلومات</span>
                                </button>
                                <button class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success-600 transition-fast flex items-center gap-2" onclick="openContractUploadModal()">
                                    <i class="fas fa-upload"></i>
                                    <span>رفع عقد العمل</span>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="bg-success-50 px-4 py-2 rounded-lg">
                                <span class="text-success font-bold text-lg" id="projectProgress">0%</span>
                                <span class="text-success text-sm mr-2">نسبة الإنجاز</span>
                            </div>
                        </div>
                    </div>
                </div>

<!-- Tabs Navigation -->
                <div class="bg-surface border-b border-border rounded-t-xl">
                    <div class="px-6">
                        <nav class="flex space-x-8 rtl:space-x-reverse" role="tablist">
                            <button class="tab-button active py-4 px-2 border-b-2 border-primary text-primary font-medium" onclick="switchProjectTab('project-information')" data-tab="project-information">
                                🧾 المعلومات
                            </button>
                            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-text-secondary hover:text-text-primary font-medium" onclick="switchProjectTab('project-phases')" data-tab="project-phases">
                                🧱 مراحل المشروع
                            </button>
                            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-text-secondary hover:text-text-primary font-medium" onclick="switchProjectTab('expenses-and-contracts')" data-tab="expenses-and-contracts">
                                💰 المصاريف والعقود
                            </button>
                            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-text-secondary hover:text-text-primary font-medium" onclick="switchProjectTab('project-payments')" data-tab="project-payments">
                                💳 دفعات المشروع
                            </button>
                            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-text-secondary hover:text-text-primary font-medium" onclick="switchProjectTab('daily-reports')" data-tab="daily-reports">
                                📅 التقارير اليومية
                            </button>
                            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-text-secondary hover:text-text-primary font-medium" onclick="switchProjectTab('financial-analysis')" data-tab="financial-analysis">
                                📊 التحليل المالي
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="bg-surface rounded-b-xl shadow-card border border-border border-t-0 p-6">
                    <!-- Project Information Tab (Default Active) -->
                    <div id="project-information" class="tab-content">
                        <!-- Project KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-error-50 rounded-xl p-6 border border-error-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-error text-sm font-medium">إجمالي المصاريف</p>
                                        <p class="text-2xl font-bold text-error mt-2" id="kpiTotalExpenses">0 ريال</p>
                                    </div>
                                    <div class="w-12 h-12 bg-error-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-receipt text-error text-lg"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-success-50 rounded-xl p-6 border border-success-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-success text-sm font-medium">الدفعات المستلمة</p>
                                        <p class="text-2xl font-bold text-success mt-2" id="kpiReceivedPayments">0 ريال</p>
                                    </div>
                                    <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-money-bill text-success text-lg"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-primary-50 rounded-xl p-6 border border-primary-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-primary text-sm font-medium">عقود الباطن</p>
                                        <p class="text-2xl font-bold text-primary mt-2" id="kpiSubcontracts">0 عقود</p>
                                    </div>
                                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-handshake text-primary text-lg"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-warning-50 rounded-xl p-6 border border-warning-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-warning text-sm font-medium">نسبة الصرف</p>
                                        <p class="text-2xl font-bold text-warning mt-2" id="kpiExpenseRatio">0%</p>
                                    </div>
                                    <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-chart-pie text-warning text-lg"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Project Basic Details -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-primary-50 rounded-xl p-6 border border-primary-200">
                                <h3 class="text-lg font-bold text-primary mb-4 flex items-center gap-2">
                                    <i class="fas fa-info-circle"></i>
                                    تفاصيل المشروع الأساسية
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                                        <span class="text-text-secondary">المدة الزمنية:</span>
                                        <span class="font-bold text-text-primary" id="projectDuration">120 يوم</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                                        <span class="text-text-secondary">قيمة المشروع:</span>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-primary" id="projectValue">500,000 ر.س</span>
                                            <button class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-600 transition-fast" onclick="editProjectValue()">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                                        <span class="text-text-secondary">الحالة:</span>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" id="projectStatusBadge">
                                            قيد التنفيذ
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contract File Section -->
                            <div class="bg-secondary-50 rounded-xl p-6 border border-border">
                                <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center gap-2">
                                    <i class="fas fa-file-contract"></i>
                                    عقد العمل الموقع
                                </h3>
                                <div id="contractFileSection">
                                    <div class="text-center py-8">
                                        <i class="fas fa-file-upload text-4xl text-text-secondary mb-4"></i>
                                        <p class="text-text-secondary mb-4">لم يتم رفع عقد العمل بعد</p>
                                        <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast" onclick="uploadContractFile()">
                                            رفع ملف العقد (PDF)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Contracts Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-text-primary flex items-center gap-2">
                                    <i class="fas fa-folder-open"></i>
                                    العقود الإضافية
                                </h3>
                                <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="openAddAdditionalContractModal()">
                                    <i class="fas fa-plus"></i>
                                    إضافة عقد
                                </button>
                            </div>
                            
                            <div class="bg-white rounded-xl border border-border overflow-hidden">
                                <table class="w-full" id="additionalContractsTable">
                                    <thead class="bg-secondary-50">
                                        <tr>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">رقم العقد</th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">الوصف</th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">القيمة</th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">تاريخ التوقيع</th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">الملف</th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">إجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="additionalContractsBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Payments Summary -->
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center gap-2">
                                <i class="fas fa-money-check-alt"></i>
                                الدفعات
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-success-50 rounded-xl p-6 border border-success-200">
                                    <div class="text-center">
                                        <p class="text-success text-sm font-medium mb-2">مستلمة</p>
                                        <p class="text-2xl font-bold text-success" id="receivedPayments">250,000 ر.س</p>
                                        <div class="mt-2 text-xs text-success">
                                            <span id="receivedPercentage">50%</span> من الإجمالي
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-warning-50 rounded-xl p-6 border border-warning-200">
                                    <div class="text-center">
                                        <p class="text-warning text-sm font-medium mb-2">متبقية</p>
                                        <p class="text-2xl font-bold text-warning" id="remainingPayments">250,000 ر.س</p>
                                        <div class="mt-2 text-xs text-warning">
                                            <span id="remainingPercentage">50%</span> من الإجمالي
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Phases Tab -->
                    <div id="project-phases" class="tab-content hidden">
                        <!-- Phases Sub-Tabs -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-text-primary">نظام إدارة مراحل المشروع</h3>
                                <div class="flex items-center gap-3">
                                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="openAddPhaseModal()" id="btnAddPhase">
                                        <i class="fas fa-plus"></i>
                                        <span>إضافة مرحلة</span>
                                    </button>
                                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="importPhasesCSV()" id="btnBulkImport">
                                        <i class="fas fa-upload"></i>
                                        <span>استيراد CSV</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Phase Sub-tabs -->
                            <div class="border-b border-border">
                                <nav class="flex space-x-6 rtl:space-x-reverse">
                                    <button class="phase-subtab-button active py-2 px-3 border-b-2 border-primary text-primary text-sm font-medium" onclick="switchPhaseSubTab('phases-main')" data-subtab="phases-main">
                                        المراحل
                                    </button>
                                    <button class="phase-subtab-button py-2 px-3 border-b-2 border-transparent text-text-secondary hover:text-text-primary text-sm font-medium" onclick="switchPhaseSubTab('phases-analytics')" data-subtab="phases-analytics">
                                        التقدم والمؤشرات
                                    </button>
                                    <button class="phase-subtab-button py-2 px-3 border-b-2 border-transparent text-text-secondary hover:text-text-primary text-sm font-medium" onclick="switchPhaseSubTab('phases-logs')" data-subtab="phases-logs">
                                        السجل والتنبيهات
                                    </button>
                                </nav>
                            </div>
                        </div>

                        <!-- Phases Main Tab -->
                        <div id="phases-main" class="phase-subtab-content">
                            <!-- Filters Section -->
                            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-secondary-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">الحالة:</label>
                                    <select id="filterStatus" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع الحالات</option>
                                        <option value="planned">مخططة</option>
                                        <option value="in_progress">جارية</option>
                                        <option value="delayed">متأخرة</option>
                                        <option value="done">منتهية</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">المسؤول:</label>
                                    <select id="filterAssignee" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع المسؤولين</option>
                                        <option value="احمد علي">احمد علي</option>
                                        <option value="فاطمة محمد">فاطمة محمد</option>
                                        <option value="عبدالله سعد">عبدالله سعد</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">الفترة:</label>
                                    <select id="filterPeriod" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع الفترات</option>
                                        <option value="this-week">هذا الأسبوع</option>
                                        <option value="this-month">هذا الشهر</option>
                                        <option value="next-month">الشهر القادم</option>
                                    </select>
                                </div>
                                <button class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="applyPhaseFilters()">
                                    تطبيق الفلاتر
                                </button>
                                <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="clearPhaseFilters()">
                                    مسح الفلاتر
                                </button>
                            </div>

                            <!-- Phases Table -->
                            <div class="bg-white rounded-lg border border-border overflow-hidden mb-6">
                                <table class="w-full" id="tblPhases">
                                    <thead class="bg-secondary-50">
                                        <tr>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('name')">
                                                اسم المرحلة <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('startDate')">
                                                البداية <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('endDate')">
                                                النهاية <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('durationDays')">
                                                المدة (أيام) <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('progressPercent')">
                                                % التقدم <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('status')">
                                                الحالة <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPhaseTable('assignee')">
                                                المسؤول <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                الاعتماديات
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                إجراءات
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="phasesTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Gantt Chart Section -->
                            <div class="bg-white rounded-lg border border-border p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-lg font-bold text-text-primary">مخطط جانت</h4>
                                    <div class="flex items-center gap-2">
                                        <button class="bg-secondary-200 text-text-primary px-3 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="zoomGanttIn()">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button class="bg-secondary-200 text-text-primary px-3 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="zoomGanttOut()">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <button class="bg-primary text-white px-3 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="refreshGantt()">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <div id="ganttContainer" class="min-h-80 border border-border rounded">
                                        <!-- Gantt chart will be rendered here -->
                                    </div>
                                </div>
                                <div class="mt-4 text-sm text-text-secondary">
                                    <p><i class="fas fa-info-circle mr-1"></i> اسحب أشرطة المراحل لتعديل التواريخ. الخطوط تمثل الاعتماديات بين المراحل.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Phases Analytics Tab -->
                        <div id="phases-analytics" class="phase-subtab-content hidden">
                            <!-- KPI Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-primary-50 rounded-xl p-6 border border-primary-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-primary text-sm font-medium">إجمالي المراحل</p>
                                            <p class="text-2xl font-bold text-primary mt-2" id="totalPhases">0</p>
                                        </div>
                                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-list text-primary text-lg"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-warning-50 rounded-xl p-6 border border-warning-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-warning text-sm font-medium">المراحل الجارية</p>
                                            <p class="text-2xl font-bold text-warning mt-2" id="inProgressPhases">0</p>
                                        </div>
                                        <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-play text-warning text-lg"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-error-50 rounded-xl p-6 border border-error-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-error text-sm font-medium">المراحل المتأخرة</p>
                                            <p class="text-2xl font-bold text-error mt-2" id="delayedPhases">0</p>
                                        </div>
                                        <div class="w-12 h-12 bg-error-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-exclamation-triangle text-error text-lg"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-success-50 rounded-xl p-6 border border-success-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-success text-sm font-medium">المراحل المكتملة</p>
                                            <p class="text-2xl font-bold text-success mt-2" id="completedPhases">0</p>
                                        </div>
                                        <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-check-circle text-success text-lg"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Overall Progress -->
                            <div class="bg-white rounded-xl p-6 border border-border mb-8">
                                <h4 class="text-lg font-bold text-text-primary mb-4">التقدم الإجمالي للمشروع</h4>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-text-secondary">نسبة الإنجاز العامة</span>
                                    <span class="font-bold text-text-primary" id="overallProgressPercent">0%</span>
                                </div>
                                <div class="w-full bg-secondary-200 rounded-full h-4 mb-4">
                                    <div class="bg-gradient-to-r from-primary to-success h-4 rounded-full transition-all duration-1000" style="width: 0%" id="overallProgressBar"></div>
                                </div>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div class="text-center">
                                        <p class="text-text-secondary">المدة الإجمالية</p>
                                        <p class="font-bold text-text-primary" id="totalDuration">0 يوم</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-text-secondary">المدة المنجزة</p>
                                        <p class="font-bold text-success" id="completedDuration">0 يوم</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-text-secondary">المدة المتبقية</p>
                                        <p class="font-bold text-warning" id="remainingDuration">0 يوم</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Weekly Progress Chart -->
                                <div class="bg-white rounded-xl p-6 border border-border">
                                    <h4 class="text-lg font-bold text-text-primary mb-4">التقدم الأسبوعي</h4>
                                    <canvas id="weeklyProgressChart" width="400" height="200"></canvas>
                                </div>

                                <!-- Phase Status Distribution -->
                                <div class="bg-white rounded-xl p-6 border border-border">
                                    <h4 class="text-lg font-bold text-text-primary mb-4">توزيع حالة المراحل</h4>
                                    <canvas id="phaseStatusChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Phases Logs Tab -->
                        <div id="phases-logs" class="phase-subtab-content hidden">
                            <!-- Log Actions -->
                            <div class="flex items-center justify-between mb-6">
                                <h4 class="text-lg font-bold text-text-primary">سجل العمليات والتنبيهات</h4>
                                <div class="flex items-center gap-3">
                                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="exportLogs()">
                                        <i class="fas fa-download"></i>
                                        <span>تصدير السجل</span>
                                    </button>
                                    <button class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning-600 transition-fast flex items-center gap-2" onclick="clearLogs()">
                                        <i class="fas fa-trash"></i>
                                        <span>مسح السجل</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Alerts Section -->
                            <div class="bg-warning-50 rounded-xl p-6 border border-warning-200 mb-6">
                                <h5 class="text-warning font-bold mb-4 flex items-center gap-2">
                                    <i class="fas fa-bell"></i>
                                    التنبيهات الحالية
                                </h5>
                                <div class="space-y-3" id="alertsContainer">
                                    <!-- Dynamic alerts will be loaded here -->
                                </div>
                            </div>

                            <!-- Logs Table -->
                            <div class="bg-white rounded-xl border border-border overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-secondary-50">
                                        <tr>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                التاريخ والوقت
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                المستخدم
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                الإجراء
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                المرحلة
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                التفاصيل
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="logsTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses and Contracts Unified Tab -->
                    <div id="expenses-and-contracts" class="tab-content hidden">
                        <!-- Unified System Header -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-text-primary">💰 المصاريف والعقود</h3>
                                <div class="flex items-center gap-3">
                                    <button class="bg-error text-white px-4 py-2 rounded-lg hover:bg-error-600 transition-fast flex items-center gap-2" onclick="openAddExpenseModal()">
                                        <i class="fas fa-plus"></i>
                                        <span>إضافة مصروف</span>
                                    </button>
                                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="openAddSubcontractModal()">
                                        <i class="fas fa-handshake"></i>
                                        <span>إضافة عقد باطن</span>
                                    </button>
                                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="exportUnifiedData()">
                                        <i class="fas fa-download"></i>
                                        <span>تصدير البيانات</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Unified Sub-tabs -->
                            <div class="border-b border-border">
                                <nav class="flex space-x-6 rtl:space-x-reverse">
                                    <button class="unified-subtab-button active py-2 px-3 border-b-2 border-primary text-primary text-sm font-medium" onclick="switchUnifiedSubTab('expenses-main')" data-subtab="expenses-main">
                                        🧾 مصاريف المشروع
                                    </button>
                                    <button class="unified-subtab-button py-2 px-3 border-b-2 border-transparent text-text-secondary hover:text-text-primary text-sm font-medium" onclick="switchUnifiedSubTab('subcontracts-main')" data-subtab="subcontracts-main">
                                        🤝 عقود الباطن
                                    </button>
                                    <button class="unified-subtab-button py-2 px-3 border-b-2 border-transparent text-text-secondary hover:text-text-primary text-sm font-medium" onclick="switchUnifiedSubTab('combined-analytics')" data-subtab="combined-analytics">
                                        📊 التحليل المالي
                                    </button>
                                </nav>
                            </div>
                        </div>

                        <!-- Project Expenses Sub-tab -->
                        <div id="expenses-main" class="unified-subtab-content">
                            <!-- Expenses KPI Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-error-50 rounded-xl p-4 border border-error-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-error text-sm font-medium">إجمالي المصاريف</p>
                                            <p class="text-xl font-bold text-error mt-1" id="expensesTotalAmount">0 ريال</p>
                                        </div>
                                        <div class="w-10 h-10 bg-error-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-receipt text-error"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-warning-50 rounded-xl p-4 border border-warning-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-warning text-sm font-medium">مصاريف هذا الشهر</p>
                                            <p class="text-xl font-bold text-warning mt-1" id="expensesMonthlyAmount">0 ريال</p>
                                        </div>
                                        <div class="w-10 h-10 bg-warning-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-calendar-alt text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-primary-50 rounded-xl p-4 border border-primary-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-primary text-sm font-medium">عدد المصاريف</p>
                                            <p class="text-xl font-bold text-primary mt-1" id="expensesCount">0</p>
                                        </div>
                                        <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-list text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-accent-50 rounded-xl p-4 border border-accent-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-accent text-sm font-medium">متوسط المصروف</p>
                                            <p class="text-xl font-bold text-accent mt-1" id="expensesAverage">0 ريال</p>
                                        </div>
                                        <div class="w-10 h-10 bg-accent-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-chart-bar text-accent"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Expenses Filters -->
                            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-secondary-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">التصنيف:</label>
                                    <select id="filterExpenseCategory" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع التصنيفات</option>
                                        <option value="مواد">🧱 مواد البناء</option>
                                        <option value="عمالة">👷 العمالة</option>
                                        <option value="معدات">🏗️ المعدات</option>
                                        <option value="نقل">🚚 النقل</option>
                                        <option value="ضيافة">☕ الضيافة</option>
                                        <option value="لوجستيات">📦 لوجستيات</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">وسيلة الدفع:</label>
                                    <select id="filterPaymentMethod" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع الوسائل</option>
                                        <option value="نقدي">نقدي</option>
                                        <option value="تحويل">تحويل بنكي</option>
                                        <option value="شيك">شيك</option>
                                        <option value="بطاقة">بطاقة ائتمان</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">التاريخ:</label>
                                    <input type="date" id="filterDateFrom" class="border border-border rounded-lg px-3 py-2 text-sm bg-white" />
                                    <span class="text-text-secondary">إلى</span>
                                    <input type="date" id="filterDateTo" class="border border-border rounded-lg px-3 py-2 text-sm bg-white" />
                                </div>
                                <button class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="applyExpenseFilters()">
                                    تطبيق الفلاتر
                                </button>
                                <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="clearExpenseFilters()">
                                    مسح الفلاتر
                                </button>
                            </div>

                            <!-- Search Bar -->
                            <div class="mb-6">
                                <div class="relative">
                                    <input type="text" id="searchExpenses" placeholder="البحث في المصاريف..." class="w-full border border-border rounded-lg px-4 py-3 pr-10 text-sm bg-white" />
                                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-text-secondary"></i>
                                </div>
                            </div>

                            <!-- Expenses Table -->
                            <div class="bg-white rounded-lg border border-border overflow-hidden mb-6">
                                <table class="w-full" id="tblExpenses">
                                    <thead class="bg-secondary-50">
                                        <tr>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('category')">
                                                التصنيف <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('description')">
                                                البيان <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('date')">
                                                التاريخ <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('amount')">
                                                المبلغ <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('vatPercent')">
                                                الضريبة (%) <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('total')">
                                                الإجمالي <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortExpenseTable('paymentMethod')">
                                                وسيلة الدفع <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                ملاحظات
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                إجراءات
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="expensesTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Subcontractor Contracts Sub-tab -->
                        <div id="subcontracts-main" class="unified-subtab-content hidden">
                            <!-- Subcontracts KPI Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-primary-50 rounded-xl p-4 border border-primary-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-primary text-sm font-medium">إجمالي العقود</p>
                                            <p class="text-xl font-bold text-primary mt-1" id="subcontractsCount">0</p>
                                        </div>
                                        <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-handshake text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-success-50 rounded-xl p-4 border border-success-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-success text-sm font-medium">إجمالي قيمة العقود</p>
                                            <p class="text-xl font-bold text-success mt-1" id="subcontractsTotalValue">0 ريال</p>
                                        </div>
                                        <div class="w-10 h-10 bg-success-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-dollar-sign text-success"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-warning-50 rounded-xl p-4 border border-warning-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-warning text-sm font-medium">المدفوع</p>
                                            <p class="text-xl font-bold text-warning mt-1" id="subcontractsPaidAmount">0 ريال</p>
                                        </div>
                                        <div class="w-10 h-10 bg-warning-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-money-check text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-error-50 rounded-xl p-4 border border-error-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-error text-sm font-medium">المتبقي</p>
                                            <p class="text-xl font-bold text-error mt-1" id="subcontractsRemainingAmount">0 ريال</p>
                                        </div>
                                        <div class="w-10 h-10 bg-error-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-clock text-error"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Subcontracts Filters -->
                            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-secondary-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">المقاول:</label>
                                    <select id="filterContractor" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع المقاولين</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">الحالة:</label>
                                    <select id="filterContractStatus" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>كل الحالات</option>
                                        <option value="active">نشط</option>
                                        <option value="completed">مكتمل</option>
                                        <option value="pending">معلق</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">تاريخ البدء:</label>
                                    <input type="date" id="filterContractStartDate" class="border border-border rounded-lg px-3 py-2 text-sm bg-white" />
                                    <span class="text-text-secondary">إلى</span>
                                    <input type="date" id="filterContractEndDate" class="border border-border rounded-lg px-3 py-2 text-sm bg-white" />
                                </div>
                                <button class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="applySubcontractFilters()">
                                    تطبيق الفلاتر
                                </button>
                                <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="clearSubcontractFilters()">
                                    مسح الفلاتر
                                </button>
                            </div>

                            <!-- Subcontracts Table -->
                            <div class="bg-white rounded-lg border border-border overflow-hidden mb-6">
                                <table class="w-full" id="tblSubcontracts">
                                    <thead class="bg-secondary-50">
                                        <tr>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('contractorName')">
                                                اسم المقاول <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('contractTitle')">
                                                عنوان العقد <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('value')">
                                                قيمة العقد <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('startDate')">
                                                تاريخ البدء <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('endDate')">
                                                تاريخ الانتهاء <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('paidAmount')">
                                                المدفوع <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('remainingAmount')">
                                                المتبقي <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortSubcontractTable('status')">
                                                الحالة <i class="fas fa-sort text-xs mr-1"></i>
                                            </th>
                                            <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                                إجراءات
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="subcontractsTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Combined Analytics Sub-tab -->
                        <div id="combined-analytics" class="unified-subtab-content hidden">
                            <!-- Combined KPI Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-error-50 rounded-xl p-6 border border-error-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-error text-sm font-medium">إجمالي المصاريف</p>
                                            <p class="text-2xl font-bold text-error mt-2" id="combinedExpensesTotal">0 ريال</p>
                                        </div>
                                        <div class="w-12 h-12 bg-error-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-receipt text-error text-lg"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-primary-50 rounded-xl p-6 border border-primary-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-primary text-sm font-medium">إجمالي عقود الباطن</p>
                                            <p class="text-2xl font-bold text-primary mt-2" id="combinedContractsTotal">0 ريال</p>
                                        </div>
                                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-handshake text-primary text-lg"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-success-50 rounded-xl p-6 border border-success-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-success text-sm font-medium">نسبة العقود إلى المصاريف</p>
                                            <p class="text-2xl font-bold text-success mt-2" id="combinedRatio">0%</p>
                                        </div>
                                        <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-chart-pie text-success text-lg"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-warning-50 rounded-xl p-6 border border-warning-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-warning text-sm font-medium">إجمالي الإنفاق الكلي</p>
                                            <p class="text-2xl font-bold text-warning mt-2" id="combinedTotalSpend">0 ريال</p>
                                        </div>
                                        <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-calculator text-warning text-lg"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Combined Charts Section -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                <!-- Monthly Comparison Chart -->
                                <div class="bg-white rounded-xl p-6 border border-border">
                                    <h4 class="text-lg font-bold text-text-primary mb-4">مقارنة المصاريف والعقود الشهرية</h4>
                                    <canvas id="monthlyComparisonChart" width="400" height="300"></canvas>
                                </div>

                                <!-- Expense vs Contracts Pie Chart -->
                                <div class="bg-white rounded-xl p-6 border border-border">
                                    <h4 class="text-lg font-bold text-text-primary mb-4">توزيع الإنفاق (مصاريف مقابل عقود)</h4>
                                    <canvas id="expenseVsContractsPieChart" width="400" height="300"></canvas>
                                </div>
                            </div>

                            <!-- Timeline Analysis -->
                            <div class="bg-white rounded-xl p-6 border border-border">
                                <h4 class="text-lg font-bold text-text-primary mb-4">الخط الزمني للمصاريف والعقود</h4>
                                <div class="mb-4 flex items-center gap-4">
                                    <button class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="switchTimelineView('monthly')">
                                        عرض شهري
                                    </button>
                                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="switchTimelineView('quarterly')">
                                        عرض ربع سنوي
                                    </button>
                                </div>
                                <canvas id="timelineChart" width="800" height="300"></canvas>
                                <div class="mt-4 flex items-center justify-center gap-8 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-error rounded"></div>
                                        <span>المصاريف</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-primary rounded"></div>
                                        <span>عقود الباطن</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Payments Tab -->
                    <div id="project-payments" class="tab-content hidden">
                        <!-- Payments System Header -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-text-primary">💳 دفعات المشروع</h3>
                                <div class="flex items-center gap-3">
                                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="openAddPaymentModal()" id="btnAddPayment">
                                        <i class="fas fa-plus"></i>
                                        <span>إضافة دفعة جديدة</span>
                                    </button>
                                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="importPaymentsCSV()" id="btnImportCSV">
                                        <i class="fas fa-upload"></i>
                                        <span>استيراد من ملف CSV</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Payments Filters -->
                            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-secondary-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">نوع الدفعة:</label>
                                    <select id="filterPaymentType" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>الكل</option>
                                        <option value="incoming">من العميل</option>
                                        <option value="outgoing">لمقاول باطن</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">الحالة:</label>
                                    <select id="filterPaymentStatus" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>كل الحالات</option>
                                        <option value="received">مستلمة</option>
                                        <option value="pending">مستحقة</option>
                                        <option value="overdue">متأخرة</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">الفترة:</label>
                                    <select id="filterPaymentPeriod" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع الفترات</option>
                                        <option value="this-month">هذا الشهر</option>
                                        <option value="this-quarter">هذا الربع</option>
                                        <option value="this-year">هذا العام</option>
                                    </select>
                                </div>
                                <button class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="applyPaymentFilters()">
                                    تطبيق الفلاتر
                                </button>
                                <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="clearPaymentFilters()">
                                    مسح الفلاتر
                                </button>
                            </div>
                        </div>

                        <!-- Payment KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-success-50 rounded-xl p-6 border border-success-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-success text-sm font-medium">إجمالي الدفعات المستلمة</p>
                                        <p class="text-2xl font-bold text-success mt-2" id="kpiReceivedPaymentsTotal">0 ريال</p>
                                    </div>
                                    <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-money-bill text-success text-lg"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-warning-50 rounded-xl p-6 border border-warning-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-warning text-sm font-medium">الدفعات المتبقية</p>
                                        <p class="text-2xl font-bold text-warning mt-2" id="kpiRemainingPayments">0 ريال</p>
                                    </div>
                                    <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-clock text-warning text-lg"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-primary-50 rounded-xl p-6 border border-primary-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-primary text-sm font-medium">إجمالي دفعات عقود الباطن</p>
                                        <p class="text-2xl font-bold text-primary mt-2" id="kpiSubcontractorPayments">0 ريال</p>
                                    </div>
                                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-handshake text-primary text-lg"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-accent-50 rounded-xl p-6 border border-accent-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-accent text-sm font-medium">نسبة التحصيل</p>
                                        <p class="text-2xl font-bold text-accent mt-2" id="kpiCollectionRatio">0%</p>
                                    </div>
                                    <div class="w-12 h-12 bg-accent-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-chart-pie text-accent text-lg"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Table -->
                        <div class="bg-white rounded-lg border border-border overflow-hidden mb-8">
                            <table class="w-full" id="tblPayments">
                                <thead class="bg-secondary-50">
                                    <tr>
                                        <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPaymentTable('paymentNumber')">
                                            رقم الدفعة <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPaymentTable('party')">
                                            الجهة <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPaymentTable('dueDate')">
                                            التاريخ <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPaymentTable('amount')">
                                            المبلغ <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortPaymentTable('status')">
                                            الحالة <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                            نسبة من الإجمالي
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                            مرفق
                                        </th>
                                        <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary">
                                            ملاحظات
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                            الإجراءات
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Timeline View Section -->
                        <div class="bg-white rounded-lg border border-border p-6 mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-bold text-text-primary">التحليل الزمني للدفعات</h4>
                                <div class="flex items-center gap-2">
                                    <button class="bg-secondary-200 text-text-primary px-3 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="switchTimelineView('monthly')">
                                        شهري
                                    </button>
                                    <button class="bg-secondary-200 text-text-primary px-3 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="switchTimelineView('quarterly')">
                                        ربع سنوي
                                    </button>
                                    <button class="bg-primary text-white px-3 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="refreshTimeline()">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <div id="paymentsTimeline" class="min-h-40 border border-border rounded p-4">
                                    <!-- Timeline will be rendered here -->
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-text-secondary">
                                <div class="flex items-center gap-6">
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-success rounded"></div>
                                        <span>مستلمة</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-warning rounded"></div>
                                        <span>مستحقة قريباً</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-error rounded"></div>
                                        <span>متأخرة</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Bar Chart for Monthly Payments -->
                            <div class="bg-white rounded-xl p-6 border border-border">
                                <h4 class="text-lg font-bold text-text-primary mb-4">مجموع الدفعات الشهرية</h4>
                                <canvas id="monthlyPaymentsChart" width="400" height="300"></canvas>
                            </div>

                            <!-- Pie Chart for Payment Status Distribution -->
                            <div class="bg-white rounded-xl p-6 border border-border">
                                <h4 class="text-lg font-bold text-text-primary mb-4">توزيع حالة الدفعات</h4>
                                <canvas id="paymentStatusChart" width="400" height="300"></canvas>
                            </div>
                        </div>

                        <!-- Payment Progress Bar -->
                        <div class="bg-white rounded-xl p-6 border border-border">
                            <h4 class="text-lg font-bold text-text-primary mb-4">نسبة الإنجاز المالي للمشروع</h4>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-text-secondary">التقدم المالي</span>
                                <span class="font-bold text-text-primary" id="financialProgressPercent">0%</span>
                            </div>
                            <div class="w-full bg-secondary-200 rounded-full h-6 mb-4">
                                <div class="bg-gradient-to-r from-success to-primary h-6 rounded-full transition-all duration-1000 flex items-center justify-center" style="width: 0%" id="financialProgressBar">
                                    <span class="text-white text-xs font-medium" id="financialProgressText">0%</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="text-center">
                                    <p class="text-text-secondary">القيمة الإجمالية</p>
                                    <p class="font-bold text-text-primary" id="totalProjectValue">0 ريال</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-text-secondary">المبلغ المحصل</p>
                                    <p class="font-bold text-success" id="collectedAmount">0 ريال</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-text-secondary">المبلغ المتبقي</p>
                                    <p class="font-bold text-warning" id="remainingCollectionAmount">0 ريال</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Analysis Tab -->
                    <div id="financial-analysis" class="tab-content hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-text-primary">التحليل المالي</h3>
                            <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="exportFinancialReport()">
                                <i class="fas fa-download"></i>
                                <span>تصدير التقرير</span>
                            </button>
                        </div>
                        
                        <div class="text-center py-12">
                            <i class="fas fa-chart-line text-6xl text-text-secondary mb-4"></i>
                            <p class="text-xl text-text-secondary">سيتم تطوير التحليل المالي قريباً</p>
                        </div>
                    </div>

<!-- Daily Reports Tab -->
                    <div id="daily-reports" class="tab-content hidden">
                        <!-- Daily Reports Header -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-text-primary">📅 التقارير اليومية</h3>
                                <div class="flex items-center gap-3">
                                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-fast flex items-center gap-2" onclick="openAddDailyReportModal()" id="btnAddDailyReport">
                                        <i class="fas fa-plus"></i>
                                        <span>إضافة تقرير يومي جديد</span>
                                    </button>
                                    <button class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success-600 transition-fast flex items-center gap-2" onclick="openUploadTodayPhotosModal()" id="btnUploadPhotos">
                                        <i class="fas fa-camera"></i>
                                        <span>رفع صور اليوم</span>
                                    </button>
                                    <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast flex items-center gap-2" onclick="viewPreviousReports()" id="btnViewPrevious">
                                        <i class="fas fa-history"></i>
                                        <span>عرض التقارير السابقة</span>
                                    </button>
                                    <button class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-accent-600 transition-fast flex items-center gap-2" onclick="updateCumulativeProgress()" id="btnUpdateProgress">
                                        <i class="fas fa-sync"></i>
                                        <span>تحديث التقدّم التراكمي</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Daily Reports Filters -->
                            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-secondary-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">المرحلة:</label>
                                    <select id="filterReportPhase" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>جميع المراحل</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">الحالة:</label>
                                    <select id="filterReportStatus" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value>كل الحالات</option>
                                        <option value="in_progress">جاري التنفيذ</option>
                                        <option value="completed">منجز</option>
                                        <option value="delayed">متأخر</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-text-primary">التاريخ:</label>
                                    <input type="date" id="filterReportDateFrom" class="border border-border rounded-lg px-3 py-2 text-sm bg-white" />
                                    <span class="text-text-secondary">إلى</span>
                                    <input type="date" id="filterReportDateTo" class="border border-border rounded-lg px-3 py-2 text-sm bg-white" />
                                </div>
                                <button class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="applyDailyReportFilters()">
                                    تطبيق الفلاتر
                                </button>
                                <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="clearDailyReportFilters()">
                                    مسح الفلاتر
                                </button>
                            </div>
                        </div>

                        <!-- Daily Reports KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-primary-50 rounded-xl p-6 border border-primary-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-primary text-sm font-medium">إجمالي التقارير</p>
                                        <p class="text-2xl font-bold text-primary mt-2" id="kpiTotalReports">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-alt text-primary text-lg"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-success-50 rounded-xl p-6 border border-success-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-success text-sm font-medium">التقارير هذا الأسبوع</p>
                                        <p class="text-2xl font-bold text-success mt-2" id="kpiWeeklyReports">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar-week text-success text-lg"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-warning-50 rounded-xl p-6 border border-warning-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-warning text-sm font-medium">إجمالي الصور المرفوعة</p>
                                        <p class="text-2xl font-bold text-warning mt-2" id="kpiTotalPhotos">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-images text-warning text-lg"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-accent-50 rounded-xl p-6 border border-accent-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-accent text-sm font-medium">متوسط التقدم اليومي</p>
                                        <p class="text-2xl font-bold text-accent mt-2" id="kpiAverageProgress">0%</p>
                                    </div>
                                    <div class="w-12 h-12 bg-accent-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-chart-line text-accent text-lg"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Reports Table -->
                        <div class="bg-white rounded-lg border border-border overflow-hidden mb-8">
                            <table class="w-full" id="tblDailyReports">
                                <thead class="bg-secondary-50">
                                    <tr>
                                        <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortDailyReportTable('date')">
                                            التاريخ <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortDailyReportTable('phase')">
                                            المرحلة <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortDailyReportTable('progressPercent')">
                                            النسبة الحالية <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-right p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortDailyReportTable('workDone')">
                                            تفاصيل العمل المنفذ <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortDailyReportTable('photoCount')">
                                            عدد الصور <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary cursor-pointer hover:bg-secondary-100" onclick="sortDailyReportTable('status')">
                                            الحالة <i class="fas fa-sort text-xs mr-1"></i>
                                        </th>
                                        <th class="text-center p-4 border-b border-border text-sm font-semibold text-text-primary">
                                            الإجراءات
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="dailyReportsTableBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Progress Chart Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Daily Progress Line Chart -->
                            <div class="bg-white rounded-xl p-6 border border-border">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-lg font-bold text-text-primary">منحنى التقدم اليومي</h4>
                                    <div class="flex items-center gap-2">
                                        <select id="progressChartPhase" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                            <option value="all">جميع المراحل</option>
                                            <option value="overall">الإجمالي العام</option>
                                            <!-- Phase options will be populated dynamically -->
                                        </select>
                                        <button class="bg-secondary-200 text-text-primary px-3 py-2 rounded-lg text-sm hover:bg-secondary-300 transition-fast" onclick="refreshProgressChart()">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </div>
                                </div>
                                <canvas id="dailyProgressChart" width="400" height="300"></canvas>
                            </div>

                            <!-- Photos Per Phase Chart -->
                            <div class="bg-white rounded-xl p-6 border border-border">
                                <h4 class="text-lg font-bold text-text-primary mb-4">توزيع الصور حسب المرحلة</h4>
                                <canvas id="photosPerPhaseChart" width="400" height="300"></canvas>
                            </div>
                        </div>

                        <!-- Photo Gallery Section -->
                        <div class="bg-white rounded-xl p-6 border border-border mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-bold text-text-primary">معرض الصور اليومية</h4>
                                <div class="flex items-center gap-2">
                                    <select id="galleryFilter" class="border border-border rounded-lg px-3 py-2 text-sm bg-white">
                                        <option value="date">تصنيف حسب التاريخ</option>
                                        <option value="phase">تصنيف حسب المرحلة</option>
                                    </select>
                                    <button class="bg-primary text-white px-3 py-2 rounded-lg text-sm hover:bg-primary-600 transition-fast" onclick="openFullScreenGallery()">
                                        <i class="fas fa-expand"></i> عرض كامل
                                    </button>
                                </div>
                            </div>
                            <div id="photoGallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- Dynamic photo gallery will be loaded here -->
                            </div>
                            <div class="mt-4 text-center">
                                <button class="bg-secondary-200 text-text-primary px-4 py-2 rounded-lg hover:bg-secondary-300 transition-fast" onclick="loadMorePhotos()">
                                    <i class="fas fa-download"></i> عرض المزيد
                                </button>
                            </div>
                        </div>

                        <!-- Weekly Summary Section -->
                        <div class="bg-white rounded-xl p-6 border border-border">
                            <h4 class="text-lg font-bold text-text-primary mb-4">ملخص الأسبوع</h4>
                            
                            <!-- Weekly KPIs -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-primary-50 rounded-lg p-4 border border-primary-200">
                                    <div class="text-center">
                                        <p class="text-primary text-sm font-medium mb-1">معدل الإنجاز الأسبوعي</p>
                                        <p class="text-xl font-bold text-primary" id="weeklyProgressRate">0%</p>
                                    </div>
                                </div>
                                <div class="bg-success-50 rounded-lg p-4 border border-success-200">
                                    <div class="text-center">
                                        <p class="text-success text-sm font-medium mb-1">عدد التقارير المضافة</p>
                                        <p class="text-xl font-bold text-success" id="weeklyReportsAdded">0</p>
                                    </div>
                                </div>
                                <div class="bg-warning-50 rounded-lg p-4 border border-warning-200">
                                    <div class="text-center">
                                        <p class="text-warning text-sm font-medium mb-1">عدد الصور والمرفقات</p>
                                        <p class="text-xl font-bold text-warning" id="weeklyAttachments">0</p>
                                    </div>
                                </div>
                                <div class="bg-accent-50 rounded-lg p-4 border border-accent-200">
                                    <div class="text-center">
                                        <p class="text-accent text-sm font-medium mb-1">التأخير المتوقع</p>
                                        <p class="text-xl font-bold text-accent" id="expectedDelay">0 أيام</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Phase Performance Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-secondary-50">
                                        <tr>
                                            <th class="text-right p-3 border-b border-border text-sm font-semibold text-text-primary">المرحلة</th>
                                            <th class="text-center p-3 border-b border-border text-sm font-semibold text-text-primary">التقدم هذا الأسبوع</th>
                                            <th class="text-center p-3 border-b border-border text-sm font-semibold text-text-primary">الأداء</th>
                                            <th class="text-center p-3 border-b border-border text-sm font-semibold text-text-primary">الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="weeklyPerformanceBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Edit Project Modal -->
    <div id="modalEditProject" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary">تعديل معلومات المشروع</h3>
                <button onclick="closeEditProjectModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editProjectForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">اسم المشروع *</label>
                        <input type="text" name="projectName" id="editProjectName" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اسم المشروع" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">رمز المشروع *</label>
                        <input type="text" name="projectCode" id="editProjectCode" class="w-full border border-border rounded-lg px-3 py-2" placeholder="#PRJ-001" required />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">المالك / العميل *</label>
                    <input type="text" name="clientName" id="editClientName" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اسم العميل" required />
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ البداية *</label>
                        <input type="date" name="startDate" id="editStartDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ النهاية *</label>
                        <input type="date" name="endDate" id="editEndDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">قيمة المشروع *</label>
                        <input type="number" name="projectValue" id="editProjectValue" class="w-full border border-border rounded-lg px-3 py-2" placeholder="500000" step="0.01" min="0" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الحالة</label>
                        <select name="status" id="editProjectStatus" class="w-full border border-border rounded-lg px-3 py-2">
                            <option value="active">نشط</option>
                            <option value="paused">متوقف</option>
                            <option value="completed">منتهي</option>
                            <option value="pending">تحت التنفيذ</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملاحظات عامة</label>
                    <textarea name="notes" id="editProjectNotes" rows="4" class="w-full border border-border rounded-lg px-3 py-2" placeholder="ملاحظات عامة حول المشروع..."></textarea>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeEditProjectModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ التغييرات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Additional Contract Modal -->
    <div id="modalAdditionalContract" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary" id="modalAdditionalContractTitle">إضافة عقد إضافي</h3>
                <button onclick="closeAdditionalContractModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="additionalContractForm" class="space-y-4">
                <input type="hidden" id="additionalContractId" name="id" />
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">رقم العقد *</label>
                    <input type="text" name="contractNumber" id="contractNumber" class="w-full border border-border rounded-lg px-3 py-2" placeholder="AC-001" required />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">وصف العقد *</label>
                    <textarea name="description" id="contractDescription" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="وصف مفصل للعقد..." required></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">قيمة العقد *</label>
                        <input type="number" name="value" id="contractValue" class="w-full border border-border rounded-lg px-3 py-2" placeholder="25000" step="0.01" min="0" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ التوقيع *</label>
                        <input type="date" name="signedDate" id="contractSignedDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملف العقد (PDF)</label>
                    <input type="file" name="file" id="contractFile" class="w-full border border-border rounded-lg px-3 py-2" accept=".pdf" />
                    <p class="text-xs text-text-secondary mt-1">ارفع ملف العقد بصيغة PDF</p>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeAdditionalContractModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ العقد
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contract Upload Modal -->
    <div id="modalContractUpload" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary">رفع عقد العمل</h3>
                <button onclick="closeContractUploadModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="contractUploadForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملف العقد (PDF) *</label>
                    <input type="file" name="contractFile" id="mainContractFile" class="w-full border border-border rounded-lg px-3 py-2" accept=".pdf" required />
                    <p class="text-xs text-text-secondary mt-1">ارفع ملف عقد العمل الأساسي بصيغة PDF</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملاحظات</label>
                    <textarea name="notes" id="contractNotes" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="ملاحظات حول العقد..."></textarea>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeContractUploadModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        رفع العقد
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Phase Form Modal -->
    <div id="modalPhaseForm" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary" id="modalPhaseTitle">إضافة مرحلة جديدة</h3>
                <button onclick="closePhaseModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="phaseForm" class="space-y-4">
                <input type="hidden" id="phaseId" name="id" />
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">اسم المرحلة *</label>
                        <input type="text" name="name" id="phaseName" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اسم المرحلة" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الأولوية</label>
                        <select name="priority" id="phasePriority" class="w-full border border-border rounded-lg px-3 py-2">
                            <option value="low">منخفضة</option>
                            <option value="medium" selected>متوسطة</option>
                            <option value="high">عالية</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">الوصف</label>
                    <textarea name="description" id="phaseDescription" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="وصف المرحلة (اختياري)"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ البداية *</label>
                        <input type="date" name="startDate" id="phaseStartDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ النهاية *</label>
                        <input type="date" name="endDate" id="phaseEndDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">نسبة التقدم</label>
                        <div class="flex items-center gap-2">
                            <input type="range" name="progressPercent" id="phaseProgress" min="0" max="100" value="0" class="flex-1" />
                            <span id="progressDisplay" class="text-sm font-medium text-text-primary min-w-12">0%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الحالة</label>
                        <select name="status" id="phaseStatus" class="w-full border border-border rounded-lg px-3 py-2">
                            <option value="planned">مخططة</option>
                            <option value="in_progress">جارية</option>
                            <option value="delayed">متأخرة</option>
                            <option value="done">منتهية</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">المسؤول</label>
                    <select name="assignee" id="phaseAssignee" class="w-full border border-border rounded-lg px-3 py-2">
                        <option value>اختر المسؤول</option>
                        <option value="احمد علي">احمد علي</option>
                        <option value="فاطمة محمد">فاطمة محمد</option>
                        <option value="عبدالله سعد">عبدالله سعد</option>
                        <option value="نوره أحمد">نوره أحمد</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">الاعتماديات</label>
                    <select name="dependencies" id="phaseDependencies" class="w-full border border-border rounded-lg px-3 py-2" multiple>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <p class="text-xs text-text-secondary mt-1">اختر المراحل التي يجب إنجازها قبل البدء في هذه المرحلة</p>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closePhaseModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ المرحلة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Form Modal -->
    <div id="modalExpenseForm" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary" id="modalExpenseTitle">إضافة مصروف جديد</h3>
                <button onclick="closeExpenseModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="expenseForm" class="space-y-4">
                <input type="hidden" id="expenseId" name="id" />
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">التصنيف *</label>
                        <select name="category" id="expenseCategory" class="w-full border border-border rounded-lg px-3 py-2" required>
                            <option value>اختر التصنيف</option>
                            <option value="مواد">🧱 مواد البناء</option>
                            <option value="عمالة">👷 العمالة</option>
                            <option value="معدات">🏗️ المعدات</option>
                            <option value="نقل">🚚 النقل</option>
                            <option value="ضيافة">☕ الضيافة</option>
                            <option value="لوجستيات">📦 لوجستيات</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">التاريخ *</label>
                        <input type="date" name="date" id="expenseDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">البيان *</label>
                    <input type="text" name="description" id="expenseDescription" class="w-full border border-border rounded-lg px-3 py-2" placeholder="وصف مختصر للمصروف" required />
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المبلغ *</label>
                        <input type="number" name="amount" id="expenseAmount" class="w-full border border-border rounded-lg px-3 py-2" placeholder="0.00" step="0.01" min="0" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الضريبة VAT (%)</label>
                        <input type="number" name="vatPercent" id="expenseVAT" class="w-full border border-border rounded-lg px-3 py-2" placeholder="15" step="0.01" min="0" max="100" value="15" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الإجمالي</label>
                        <input type="number" name="total" id="expenseTotal" class="w-full border border-border rounded-lg px-3 py-2 bg-secondary-50" readonly />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">وسيلة الدفع *</label>
                    <select name="paymentMethod" id="expensePaymentMethod" class="w-full border border-border rounded-lg px-3 py-2" required>
                        <option value>اختر وسيلة الدفع</option>
                        <option value="نقدي">نقدي</option>
                        <option value="تحويل">تحويل بنكي</option>
                        <option value="شيك">شيك</option>
                        <option value="بطاقة">بطاقة ائتمان</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملاحظات</label>
                    <textarea name="notes" id="expenseNotes" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="ملاحظات إضافية (اختياري)"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">مرفقات</label>
                    <input type="file" name="attachment" id="expenseAttachment" class="w-full border border-border rounded-lg px-3 py-2" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                    <p class="text-xs text-text-secondary mt-1">يمكنك رفع الفواتير أو صور المتعلقة بالمصروف</p>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeExpenseModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ المصروف
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subcontract Modal -->
    <div id="modalSubcontractForm" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary" id="modalSubcontractTitle">إضافة عقد باطن جديد</h3>
                <button onclick="closeSubcontractModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="subcontractForm" class="space-y-4">
                <input type="hidden" id="subcontractId" name="id" />
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">اسم المقاول *</label>
                        <input type="text" name="contractorName" id="contractorName" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اسم المقاول" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">عنوان العقد *</label>
                        <input type="text" name="contractTitle" id="contractTitle" class="w-full border border-border rounded-lg px-3 py-2" placeholder="عنوان العقد" required />
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">قيمة العقد *</label>
                        <input type="number" name="value" id="subcontractValue" class="w-full border border-border rounded-lg px-3 py-2" placeholder="0.00" step="0.01" min="0" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المبلغ المدفوع</label>
                        <input type="number" name="paidAmount" id="subcontractPaidAmount" class="w-full border border-border rounded-lg px-3 py-2" placeholder="0.00" step="0.01" min="0" />
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ البدء *</label>
                        <input type="date" name="startDate" id="subcontractStartDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ الانتهاء *</label>
                        <input type="date" name="endDate" id="subcontractEndDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">الحالة</label>
                    <select name="status" id="subcontractStatus" class="w-full border border-border rounded-lg px-3 py-2">
                        <option value="active">نشط</option>
                        <option value="completed">مكتمل</option>
                        <option value="pending">معلق</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملف العقد</label>
                    <input type="file" name="contractFile" id="subcontractFile" class="w-full border border-border rounded-lg px-3 py-2" accept=".pdf" />
                    <p class="text-xs text-text-secondary mt-1">ارفع ملف العقد بصيغة PDF</p>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeSubcontractModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ العقد
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="modalPaymentForm" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary" id="modalPaymentTitle">إضافة دفعة جديدة</h3>
                <button onclick="closePaymentModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="paymentForm" class="space-y-4">
                <input type="hidden" id="paymentId" name="id" />
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">نوع الدفعة *</label>
                        <select name="type" id="paymentType" class="w-full border border-border rounded-lg px-3 py-2" required>
                            <option value>اختر نوع الدفعة</option>
                            <option value="incoming">من العميل</option>
                            <option value="outgoing">لمقاول باطن</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الجهة *</label>
                        <select name="party" id="paymentParty" class="w-full border border-border rounded-lg px-3 py-2" required>
                            <option value>اختر الجهة</option>
                            <!-- Options will be populated dynamically based on type -->
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">رقم الدفعة / اسمها *</label>
                        <input type="text" name="name" id="paymentName" class="w-full border border-border rounded-lg px-3 py-2" placeholder="رقم أو اسم الدفعة" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المبلغ *</label>
                        <input type="number" name="amount" id="paymentAmount" class="w-full border border-border rounded-lg px-3 py-2" placeholder="0.00" step="0.01" min="0" required />
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ الاستحقاق *</label>
                        <input type="date" name="dueDate" id="paymentDueDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ السداد</label>
                        <input type="date" name="paidDate" id="paymentPaidDate" class="w-full border border-border rounded-lg px-3 py-2" />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">حالة الدفعة *</label>
                    <select name="status" id="paymentStatus" class="w-full border border-border rounded-lg px-3 py-2" required>
                        <option value>اختر الحالة</option>
                        <option value="received">مستلمة</option>
                        <option value="pending">مستحقة</option>
                        <option value="overdue">متأخرة</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">مرفق PDF</label>
                    <input type="file" name="attachment" id="paymentAttachment" class="w-full border border-border rounded-lg px-3 py-2" accept=".pdf" />
                    <p class="text-xs text-text-secondary mt-1">ارفع إشعار تحويل أو فاتورة (PDF)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملاحظات إضافية</label>
                    <textarea name="notes" id="paymentNotes" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="ملاحظات حول الدفعة..."></textarea>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closePaymentModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ الدفعة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="modalConfirmDelete" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-error-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-error text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-text-primary mb-2">تأكيد الحذف</h3>
                <p class="text-text-secondary mb-6" id="deleteConfirmText">هل أنت متأكد من حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
                <div class="flex items-center justify-center gap-3">
                    <button onclick="closeDeleteModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button onclick="confirmDelete()" class="bg-error text-white px-6 py-2 rounded-lg hover:bg-error-600 transition-fast" id="confirmDeleteBtn">
                        حذف
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Daily Report Form Modal -->
    <div id="modalDailyReportForm" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-4xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary" id="modalDailyReportTitle">إضافة تقرير يومي جديد</h3>
                <button onclick="closeDailyReportModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="dailyReportForm" class="space-y-6">
                <input type="hidden" id="dailyReportId" name="id" />
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">اسم المشروع</label>
                        <input type="text" id="reportProjectName" class="w-full border border-border rounded-lg px-3 py-2 bg-secondary-50" readonly />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">تاريخ التقرير *</label>
                        <input type="date" name="date" id="reportDate" class="w-full border border-border rounded-lg px-3 py-2" required />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المرحلة المرتبطة *</label>
                        <select name="phaseId" id="reportPhaseId" class="w-full border border-border rounded-lg px-3 py-2" required>
                            <option value>اختر المرحلة</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">نسبة الإنجاز الحالية (%)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" name="progressPercent" id="reportProgress" min="0" max="100" value="0" class="flex-1" />
                            <span id="reportProgressDisplay" class="text-sm font-medium text-text-primary min-w-12">0%</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">الوصف التفصيلي لما تم تنفيذه *</label>
                    <textarea name="workDescription" id="reportWorkDescription" rows="4" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اكتب تفاصيل العمل المنفذ اليوم..." required></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المشاكل أو الملاحظات الميدانية</label>
                        <textarea name="issues" id="reportIssues" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اذكر أي مشاكل أو ملاحظات (اختياري)"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">الطقس (اختياري)</label>
                        <select name="weather" id="reportWeather" class="w-full border border-border rounded-lg px-3 py-2">
                            <option value>اختر حالة الطقس</option>
                            <option value="مشمس">☀️ مشمس</option>
                            <option value="غائم">☁️ غائم</option>
                            <option value="ماطر">🌧️ ماطر</option>
                            <option value="عاصف">💨 عاصف</option>
                            <option value="بارد">❄️ بارد</option>
                            <option value="حار">🔥 حار</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">عدد العمال المستخدمة</label>
                        <input type="number" name="workersCount" id="reportWorkersCount" class="w-full border border-border rounded-lg px-3 py-2" min="0" placeholder="0" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">المعدات المستخدمة</label>
                        <input type="text" name="equipmentUsed" id="reportEquipmentUsed" class="w-full border border-border rounded-lg px-3 py-2" placeholder="اذكر المعدات المستخدمة" />
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="border border-border rounded-lg p-4">
                    <label class="block text-sm font-medium text-text-primary mb-3">رفع الصور / الملفات (يدعم سحب وإفلات)</label>
                    <div id="fileDropZone" class="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-fast cursor-pointer">
                        <div class="space-y-2">
                            <i class="fas fa-cloud-upload-alt text-4xl text-text-secondary"></i>
                            <p class="text-text-secondary">اسحب الملفات هنا أو انقر للتصفح</p>
                            <p class="text-xs text-text-secondary">يدعم: JPG, PNG, MP4, PDF (حد أقصى 10MB لكل ملف)</p>
                        </div>
                        <input type="file" id="reportFiles" name="files[]" multiple accept=".jpg,.jpeg,.png,.mp4,.pdf" class="hidden" />
                    </div>
                    
                    <!-- File Preview Area -->
                    <div id="filePreview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                        <!-- Dynamic file previews will be added here -->
                    </div>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeDailyReportModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-600 transition-fast">
                        حفظ التقرير
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Today Photos Modal -->
    <div id="modalUploadPhotos" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-90vh overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-text-primary">رفع صور اليوم</h3>
                <button onclick="closeUploadPhotosModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="uploadPhotosForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">المرحلة</label>
                    <select name="phaseId" id="photoPhaseId" class="w-full border border-border rounded-lg px-3 py-2" required>
                        <option value>اختر المرحلة</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <div class="border border-border rounded-lg p-4">
                    <label class="block text-sm font-medium text-text-primary mb-3">الصور والفيديوهات</label>
                    <div id="photoDropZone" class="border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary transition-fast cursor-pointer">
                        <div class="space-y-2">
                            <i class="fas fa-images text-3xl text-text-secondary"></i>
                            <p class="text-text-secondary">اسحب الصور والفيديوهات هنا</p>
                            <p class="text-xs text-text-secondary">JPG, PNG, MP4 (حد أقصى 10MB لكل ملف)</p>
                        </div>
                        <input type="file" id="photosInput" name="photos[]" multiple accept=".jpg,.jpeg,.png,.mp4" class="hidden" />
                    </div>
                    
                    <div id="photoPreviewGrid" class="mt-4 grid grid-cols-3 gap-4 hidden">
                        <!-- Photo previews will be added here -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">ملاحظات</label>
                    <textarea name="notes" id="photoNotes" rows="3" class="w-full border border-border rounded-lg px-3 py-2" placeholder="ملاحظات حول الصور المرفوعة (اختياري)"></textarea>
                </div>
                
                <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeUploadPhotosModal()" class="bg-secondary-200 text-text-primary px-6 py-2 rounded-lg hover:bg-secondary-300 transition-fast">
                        إلغاء
                    </button>
                    <button type="submit" class="bg-success text-white px-6 py-2 rounded-lg hover:bg-success-600 transition-fast">
                        رفع الصور
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Full Screen Gallery Modal -->
    <div id="modalFullScreenGallery" class="modal fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50">
        <div class="w-full h-full max-w-6xl mx-4 py-4 flex flex-col">
            <div class="flex items-center justify-between mb-4 px-4">
                <h3 class="text-xl font-bold text-white">معرض الصور</h3>
                <button onclick="closeFullScreenGallery()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-auto">
                <div id="fullScreenGalleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-4">
                    <!-- Full screen gallery will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Lightbox Modal -->
    <div id="modalPhotoLightbox" class="modal fixed inset-0 bg-black bg-opacity-95 hidden flex items-center justify-center z-60">
        <div class="relative w-full h-full flex items-center justify-center p-4">
            <button onclick="closePhotoLightbox()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            
            <button onclick="previousPhoto()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 z-10">
                <i class="fas fa-chevron-left text-3xl"></i>
            </button>
            
            <button onclick="nextPhoto()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 z-10">
                <i class="fas fa-chevron-right text-3xl"></i>
            </button>
            
            <div id="lightboxContent" class="max-w-full max-h-full">
                <!-- Photo content will be loaded here -->
            </div>
            
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-center">
                <p id="photoInfo" class="text-sm"></p>
                <div class="flex items-center justify-center gap-4 mt-2">
                    <button onclick="downloadPhoto()" class="bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary-600">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Global variables
let currentProjectId = null;
let currentProjectData = null;
let itemToDelete = null;
let deleteCallback = null;
let phasesStore = null;

// Daily Reports Store
class DailyReportsStore {
    constructor() {
        this.dailyReports = this.loadDailyReports();
        this.attachments = this.loadAttachments();
    }

    // Daily Reports CRUD operations
    listDailyReports(projectId, filters = {}) {
        let reports = this.dailyReports.filter(report => report.projectId === projectId);
        
        if (filters.phaseId) {
            reports = reports.filter(report => report.phaseId === filters.phaseId);
        }
        if (filters.status) {
            reports = reports.filter(report => report.status === filters.status);
        }
        if (filters.dateFrom) {
            reports = reports.filter(report => report.date >= filters.dateFrom);
        }
        if (filters.dateTo) {
            reports = reports.filter(report => report.date <= filters.dateTo);
        }
        
        // Sort by date descending (newest first)
        return reports.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    getDailyReport(id) {
        return this.dailyReports.find(report => report.id === id);
    }

    createDailyReport(projectId, data) {
        const report = {
            id: 'daily-report-' + Date.now(),
            projectId: projectId,
            phaseId: data.phaseId,
            date: data.date,
            workDescription: data.workDescription,
            progressPercent: parseFloat(data.progressPercent || 0),
            issues: data.issues || '',
            weather: data.weather || '',
            workersCount: parseInt(data.workersCount || 0),
            equipmentUsed: data.equipmentUsed || '',
            status: this.determineReportStatus(data.progressPercent),
            createdBy: 'المستخدم الحالي',
            createdAt: new Date().toISOString()
        };

        this.dailyReports.push(report);
        this.saveDailyReports();
        
        // Update phase progress if linked to phases store
        if (phasesStore && data.phaseId) {
            this.updatePhaseProgress(data.phaseId, data.progressPercent);
        }
        
        return report;
    }

    updateDailyReport(id, data) {
        const reportIndex = this.dailyReports.findIndex(report => report.id === id);
        if (reportIndex === -1) return null;

        Object.keys(data).forEach(key => {
            if (data[key] !== undefined) {
                this.dailyReports[reportIndex][key] = data[key];
            }
        });

        // Update status based on progress
        this.dailyReports[reportIndex].status = this.determineReportStatus(this.dailyReports[reportIndex].progressPercent);

        this.saveDailyReports();
        
        // Update phase progress
        if (phasesStore && this.dailyReports[reportIndex].phaseId) {
            this.updatePhaseProgress(this.dailyReports[reportIndex].phaseId, this.dailyReports[reportIndex].progressPercent);
        }
        
        return this.dailyReports[reportIndex];
    }

    deleteDailyReport(id) {
        const reportIndex = this.dailyReports.findIndex(report => report.id === id);
        if (reportIndex === -1) return false;

        // Delete associated attachments
        this.attachments = this.attachments.filter(att => att.reportId !== id);
        
        this.dailyReports.splice(reportIndex, 1);
        this.saveDailyReports();
        this.saveAttachments();
        return true;
    }

    // Attachment management
    uploadAttachment(reportId, file, type) {
        const attachment = {
            id: 'attachment-' + Date.now(),
            reportId: reportId,
            fileName: file.name,
            fileSize: file.size,
            fileType: type, // 'image', 'video', 'pdf'
            fileUrl: URL.createObjectURL(file), // In real app, this would be uploaded to server
            uploadedAt: new Date().toISOString()
        };

        this.attachments.push(attachment);
        this.saveAttachments();
        return attachment;
    }

    listAttachments(reportId) {
        return this.attachments.filter(att => att.reportId === reportId);
    }

    // Analytics and computed data
    computeProgressOverTime(projectId) {
        const reports = this.listDailyReports(projectId);
        const progressData = {};

        reports.forEach(report => {
            const date = report.date;
            if (!progressData[date]) {
                progressData[date] = { date, phases: {} };
            }
            
            if (!progressData[date].phases[report.phaseId]) {
                progressData[date].phases[report.phaseId] = 0;
            }
            
            progressData[date].phases[report.phaseId] = Math.max(
                progressData[date].phases[report.phaseId], 
                report.progressPercent
            );
        });

        return Object.values(progressData).sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    computeDailyReportStats(projectId) {
        const reports = this.listDailyReports(projectId);
        const totalReports = reports.length;
        
        // Weekly reports (last 7 days)
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const weeklyReports = reports.filter(r => new Date(r.date) >= oneWeekAgo).length;
        
        // Total photos
        const totalPhotos = this.attachments.filter(att => 
            reports.some(r => r.id === att.reportId) && att.fileType === 'image'
        ).length;
        
        // Average progress
        const averageProgress = totalReports > 0 ? 
            reports.reduce((sum, r) => sum + r.progressPercent, 0) / totalReports : 0;

        return {
            totalReports,
            weeklyReports,
            totalPhotos,
            averageProgress: Math.round(averageProgress)
        };
    }

    computeWeeklySummary(projectId) {
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        
        const weeklyReports = this.listDailyReports(projectId).filter(r => 
            new Date(r.date) >= oneWeekAgo
        );

        const progressRate = weeklyReports.length > 0 ?
            weeklyReports.reduce((sum, r) => sum + r.progressPercent, 0) / weeklyReports.length : 0;

        const attachmentCount = this.attachments.filter(att =>
            weeklyReports.some(r => r.id === att.reportId)
        ).length;

        return {
            progressRate: Math.round(progressRate),
            reportsAdded: weeklyReports.length,
            attachments: attachmentCount,
            expectedDelay: 0 // Calculate based on project timeline
        };
    }

    // Helper methods
    determineReportStatus(progressPercent) {
        if (progressPercent >= 100) return 'completed';
        if (progressPercent >= 1) return 'in_progress';
        return 'delayed';
    }

    updatePhaseProgress(phaseId, progressPercent) {
        if (phasesStore) {
            phasesStore.updatePhase(phaseId, { progressPercent: progressPercent });
        }
    }

    // Storage methods
    saveDailyReports() {
        localStorage.setItem('daily_reports', JSON.stringify(this.dailyReports));
    }

    loadDailyReports() {
        const saved = localStorage.getItem('daily_reports');
        return saved ? JSON.parse(saved) : this.getDefaultDailyReports();
    }

    saveAttachments() {
        localStorage.setItem('daily_report_attachments', JSON.stringify(this.attachments));
    }

    loadAttachments() {
        const saved = localStorage.getItem('daily_report_attachments');
        return saved ? JSON.parse(saved) : this.getDefaultAttachments();
    }

    getDefaultDailyReports() {
        return [
            {
                id: 'daily-report-001',
                projectId: 'project-001',
                phaseId: 'phase-002',
                date: '2025-01-05',
                workDescription: 'صب 6 قواعد رئيسية للفيلا، تم الانتهاء من تركيب الحديد والخرسانة',
                progressPercent: 45,
                issues: 'تأخر في وصول الخرسانة الجاهزة بسبب الازدحام',
                weather: 'مشمس',
                workersCount: 12,
                equipmentUsed: 'خلاطة خرسانة، رافعة شوكية',
                status: 'in_progress',
                createdBy: 'المستخدم الحالي',
                createdAt: '2025-01-05T14:30:00.000Z'
            },
            {
                id: 'daily-report-002',
                projectId: 'project-001',
                phaseId: 'phase-001',
                date: '2025-01-04',
                workDescription: 'إنهاء كامل لأعمال الحفر والتسوية، تم تنظيف الموقع',
                progressPercent: 100,
                issues: '',
                weather: 'غائم',
                workersCount: 8,
                equipmentUsed: 'حفارة، جرافة',
                status: 'completed',
                createdBy: 'المستخدم الحالي',
                createdAt: '2025-01-04T16:00:00.000Z'
            },
            {
                id: 'daily-report-003',
                projectId: 'project-002',
                phaseId: 'phase-005',
                date: '2025-01-05',
                workDescription: 'تنظيف وتهيئة الموقع، إزالة الأنقاض والمواد القديمة',
                progressPercent: 80,
                issues: 'صعوبة في الوصول لبعض الزوايا بسبب ضيق المساحة',
                weather: 'مشمس',
                workersCount: 15,
                equipmentUsed: 'شاحنات، أدوات التنظيف',
                status: 'in_progress',
                createdBy: 'المستخدم الحالي',
                createdAt: '2025-01-05T13:15:00.000Z'
            }
        ];
    }

    getDefaultAttachments() {
        return [
            {
                id: 'attachment-001',
                reportId: 'daily-report-001',
                fileName: 'قواعد_الفيلا_1.jpg',
                fileSize: 2048000,
                fileType: 'image',
                fileUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect width="300" height="200" fill="%23f0f0f0"/><text x="150" y="100" text-anchor="middle" fill="%23666">صورة قواعد الفيلا</text></svg>',
                uploadedAt: '2025-01-05T14:35:00.000Z'
            },
            {
                id: 'attachment-002',
                reportId: 'daily-report-001',
                fileName: 'قواعد_الفيلا_2.jpg',
                fileSize: 1856000,
                fileType: 'image',
                fileUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect width="300" height="200" fill="%23e0e0e0"/><text x="150" y="100" text-anchor="middle" fill="%23666">صورة العمل المكتمل</text></svg>',
                uploadedAt: '2025-01-05T14:36:00.000Z'
            }
        ];
    }
}

// Initialize daily reports store
let dailyReportsStore = null;

// Project Data Store
class ProjectStore {
    constructor() {
        this.projects = this.loadProjects();
        this.additionalContracts = this.loadAdditionalContracts();
        this.phases = this.loadPhases();
        this.expenses = this.loadExpenses();
        this.subcontracts = this.loadSubcontracts();
    }

    // Project CRUD operations
    getProject(id) {
        return this.projects.find(project => project.id === id);
    }

    updateProject(id, data) {
        const projectIndex = this.projects.findIndex(project => project.id === id);
        if (projectIndex === -1) return null;

        Object.keys(data).forEach(key => {
            if (data[key] !== undefined) {
                this.projects[projectIndex][key] = data[key];
            }
        });

        this.saveProjects();
        return this.projects[projectIndex];
    }

    // Additional contracts management
    listAdditionalContracts(projectId) {
        return this.additionalContracts.filter(contract => contract.projectId === projectId);
    }

    createAdditionalContract(projectId, data) {
        const contract = {
            id: 'contract-' + Date.now(),
            projectId: projectId,
            contractNumber: data.contractNumber,
            description: data.description,
            value: parseFloat(data.value),
            signedDate: data.signedDate,
            file: data.file || null,
            createdAt: new Date().toISOString()
        };

        this.additionalContracts.push(contract);
        this.saveAdditionalContracts();
        return contract;
    }

    updateAdditionalContract(id, data) {
        const contractIndex = this.additionalContracts.findIndex(contract => contract.id === id);
        if (contractIndex === -1) return null;

        Object.keys(data).forEach(key => {
            if (data[key] !== undefined) {
                this.additionalContracts[contractIndex][key] = data[key];
            }
        });

        this.saveAdditionalContracts();
        return this.additionalContracts[contractIndex];
    }

    deleteAdditionalContract(id) {
        const contractIndex = this.additionalContracts.findIndex(contract => contract.id === id);
        if (contractIndex === -1) return false;

        this.additionalContracts.splice(contractIndex, 1);
        this.saveAdditionalContracts();
        return true;
    }

    // Expenses management
    listExpenses(projectId, filters = {}) {
        let expenses = this.expenses.filter(expense => expense.projectId === projectId);
        
        if (filters.category) {
            expenses = expenses.filter(expense => expense.category === filters.category);
        }
        if (filters.paymentMethod) {
            expenses = expenses.filter(expense => expense.paymentMethod === filters.paymentMethod);
        }
        if (filters.dateFrom) {
            expenses = expenses.filter(expense => expense.date >= filters.dateFrom);
        }
        if (filters.dateTo) {
            expenses = expenses.filter(expense => expense.date <= filters.dateTo);
        }
        
        return expenses;
    }

    createExpense(projectId, data) {
        const expense = {
            id: 'expense-' + Date.now(),
            projectId: projectId,
            category: data.category,
            description: data.description,
            date: data.date,
            amount: parseFloat(data.amount),
            vatPercent: parseFloat(data.vatPercent || 0),
            total: parseFloat(data.amount) * (1 + parseFloat(data.vatPercent || 0) / 100),
            paymentMethod: data.paymentMethod,
            notes: data.notes || '',
            attachment: data.attachment || null,
            createdAt: new Date().toISOString()
        };

        this.expenses.push(expense);
        this.saveExpenses();
        return expense;
    }

    updateExpense(id, data) {
        const expenseIndex = this.expenses.findIndex(expense => expense.id === id);
        if (expenseIndex === -1) return null;

        Object.keys(data).forEach(key => {
            if (data[key] !== undefined) {
                this.expenses[expenseIndex][key] = data[key];
            }
        });

        // Recalculate total
        this.expenses[expenseIndex].total = this.expenses[expenseIndex].amount * (1 + this.expenses[expenseIndex].vatPercent / 100);

        this.saveExpenses();
        return this.expenses[expenseIndex];
    }

    deleteExpense(id) {
        const expenseIndex = this.expenses.findIndex(expense => expense.id === id);
        if (expenseIndex === -1) return false;

        this.expenses.splice(expenseIndex, 1);
        this.saveExpenses();
        return true;
    }

    computeExpenseTotals(projectId) {
        const expenses = this.listExpenses(projectId);
        return {
            totalAmount: expenses.reduce((sum, exp) => sum + exp.amount, 0),
            totalVAT: expenses.reduce((sum, exp) => sum + (exp.amount * exp.vatPercent / 100), 0),
            totalWithVAT: expenses.reduce((sum, exp) => sum + exp.total, 0),
            count: expenses.length,
            monthlyAmount: this.getMonthlyExpenseAmount(projectId),
            averageAmount: expenses.length > 0 ? expenses.reduce((sum, exp) => sum + exp.amount, 0) / expenses.length : 0
        };
    }

    getMonthlyExpenseAmount(projectId) {
        const currentMonth = new Date().toISOString().slice(0, 7);
        const expenses = this.listExpenses(projectId);
        return expenses
            .filter(exp => exp.date.startsWith(currentMonth))
            .reduce((sum, exp) => sum + exp.amount, 0);
    }

    // Subcontracts management
    listSubcontracts(projectId, filters = {}) {
        let subcontracts = this.subcontracts.filter(contract => contract.projectId === projectId);
        
        if (filters.contractorName) {
            subcontracts = subcontracts.filter(contract => 
                contract.contractorName.toLowerCase().includes(filters.contractorName.toLowerCase()));
        }
        if (filters.status) {
            subcontracts = subcontracts.filter(contract => contract.status === filters.status);
        }
        if (filters.startDate) {
            subcontracts = subcontracts.filter(contract => contract.startDate >= filters.startDate);
        }
        if (filters.endDate) {
            subcontracts = subcontracts.filter(contract => contract.endDate <= filters.endDate);
        }
        
        return subcontracts;
    }

    createSubcontract(projectId, data) {
        const subcontract = {
            id: 'subcontract-' + Date.now(),
            projectId: projectId,
            contractorName: data.contractorName,
            contractTitle: data.contractTitle,
            value: parseFloat(data.value),
            startDate: data.startDate,
            endDate: data.endDate,
            paidAmount: parseFloat(data.paidAmount || 0),
            remainingAmount: parseFloat(data.value) - parseFloat(data.paidAmount || 0),
            status: data.status || 'active',
            contractFile: data.contractFile || null,
            createdAt: new Date().toISOString()
        };

        this.subcontracts.push(subcontract);
        this.saveSubcontracts();
        return subcontract;
    }

    updateSubcontract(id, data) {
        const contractIndex = this.subcontracts.findIndex(contract => contract.id === id);
        if (contractIndex === -1) return null;

        Object.keys(data).forEach(key => {
            if (data[key] !== undefined) {
                this.subcontracts[contractIndex][key] = data[key];
            }
        });

        // Recalculate remaining amount
        this.subcontracts[contractIndex].remainingAmount = 
            this.subcontracts[contractIndex].value - this.subcontracts[contractIndex].paidAmount;

        this.saveSubcontracts();
        return this.subcontracts[contractIndex];
    }

    deleteSubcontract(id) {
        const contractIndex = this.subcontracts.findIndex(contract => contract.id === id);
        if (contractIndex === -1) return false;

        this.subcontracts.splice(contractIndex, 1);
        this.saveSubcontracts();
        return true;
    }

    computeSubcontractTotals(projectId) {
        const subcontracts = this.listSubcontracts(projectId);
        return {
            count: subcontracts.length,
            totalValue: subcontracts.reduce((sum, contract) => sum + contract.value, 0),
            totalPaid: subcontracts.reduce((sum, contract) => sum + contract.paidAmount, 0),
            totalRemaining: subcontracts.reduce((sum, contract) => sum + contract.remainingAmount, 0),
            activeCount: subcontracts.filter(c => c.status === 'active').length,
            completedCount: subcontracts.filter(c => c.status === 'completed').length
        };
    }

    // Combined analytics
    computeCombinedStats(projectId) {
        const expenseStats = this.computeExpenseTotals(projectId);
        const contractStats = this.computeSubcontractTotals(projectId);
        
        const totalSpend = expenseStats.totalWithVAT + contractStats.totalValue;
        const contractsToExpensesRatio = expenseStats.totalWithVAT > 0 ? 
            (contractStats.totalValue / expenseStats.totalWithVAT) * 100 : 0;
        
        return {
            expenses: expenseStats,
            contracts: contractStats,
            totalSpend,
            contractsToExpensesRatio
        };
    }

    // Storage methods
    saveProjects() {
        localStorage.setItem('projects', JSON.stringify(this.projects));
    }

    loadProjects() {
        const saved = localStorage.getItem('projects');
        return saved ? JSON.parse(saved) : this.getDefaultProjects();
    }

    saveAdditionalContracts() {
        localStorage.setItem('additional_contracts', JSON.stringify(this.additionalContracts));
    }

    loadAdditionalContracts() {
        const saved = localStorage.getItem('additional_contracts');
        return saved ? JSON.parse(saved) : this.getDefaultAdditionalContracts();
    }

    savePhases() {
        localStorage.setItem('phases', JSON.stringify(this.phases));
    }

    loadPhases() {
        const saved = localStorage.getItem('phases');
        return saved ? JSON.parse(saved) : this.getDefaultPhases();
    }

    saveExpenses() {
        localStorage.setItem('project_expenses', JSON.stringify(this.expenses));
    }

    loadExpenses() {
        const saved = localStorage.getItem('project_expenses');
        return saved ? JSON.parse(saved) : this.getDefaultExpenses();
    }

    saveSubcontracts() {
        localStorage.setItem('subcontracts', JSON.stringify(this.subcontracts));
    }

    loadSubcontracts() {
        const saved = localStorage.getItem('subcontracts');
        return saved ? JSON.parse(saved) : this.getDefaultSubcontracts();
    }

    getDefaultProjects() {
        return [
            {
                id: 'project-001',
                name: 'فيلا الرياض الحديثة',
                code: '#PRJ-001',
                client: 'محمد العبدالله',
                value: 850000,
                startDate: '2025-01-01',
                endDate: '2025-02-15',
                progress: 85,
                status: 'active',
                notes: 'مشروع فيلا سكنية حديثة في شمال الرياض'
            },
            {
                id: 'project-002',
                name: 'مجمع تجاري جدة',
                code: '#PRJ-002',
                client: 'شركة الأندلس للاستثمار',
                value: 1200000,
                startDate: '2025-01-10',
                endDate: '2025-03-25',
                progress: 45,
                status: 'active',
                notes: 'مجمع تجاري متعدد الطوابق في وسط جدة'
            },
            {
                id: 'project-003',
                name: 'مشروع سكني الدمام',
                code: '#PRJ-003',
                client: 'فهد الخالدي',
                value: 650000,
                startDate: '2025-01-20',
                endDate: '2025-04-15',
                progress: 20,
                status: 'active',
                notes: 'مجمع سكني للعائلات في الدمام'
            }
        ];
    }

    getDefaultAdditionalContracts() {
        return [
            {
                id: 'additional-001',
                projectId: 'project-001',
                contractNumber: 'AC-001',
                description: 'أعمال التكييف المركزي',
                value: 45000,
                signedDate: '2025-01-08',
                file: 'hvac-contract.pdf',
                createdAt: '2025-01-08T10:00:00.000Z'
            },
            {
                id: 'additional-002',
                projectId: 'project-001',
                contractNumber: 'AC-002',
                description: 'أعمال الحدائق والمناظر الطبيعية',
                value: 25000,
                signedDate: '2025-01-12',
                file: 'landscaping-contract.pdf',
                createdAt: '2025-01-12T14:30:00.000Z'
            },
            {
                id: 'additional-003',
                projectId: 'project-002',
                contractNumber: 'AC-003',
                description: 'أنظمة الأمان والمراقبة',
                value: 85000,
                signedDate: '2025-01-15',
                file: 'security-contract.pdf',
                createdAt: '2025-01-15T09:20:00.000Z'
            }
        ];
    }

    getDefaultPhases() {
        return [
            {
                id: 'phase-001',
                projectId: 'project-001',
                name: 'أعمال الحفر والأساسات',
                description: 'حفر الأساسات وصب الخرسانة العادية والمسلحة',
                startDate: '2025-01-01',
                endDate: '2025-01-15',
                durationDays: 14,
                progressPercent: 100,
                status: 'done',
                assignee: 'احمد علي',
                dependencies: [],
                priority: 'high',
                createdAt: '2025-01-01T08:00:00.000Z'
            },
            {
                id: 'phase-002',
                projectId: 'project-001',
                name: 'بناء الجدران والأعمدة',
                description: 'بناء الهيكل الإنشائي الأساسي للفيلا',
                startDate: '2025-01-16',
                endDate: '2025-01-30',
                durationDays: 14,
                progressPercent: 85,
                status: 'in_progress',
                assignee: 'فاطمة محمد',
                dependencies: ['phase-001'],
                priority: 'high',
                createdAt: '2025-01-16T08:00:00.000Z'
            },
            {
                id: 'phase-003',
                projectId: 'project-001',
                name: 'أعمال السباكة والكهرباء',
                description: 'تمديد أنابيب المياه والأسلاك الكهربائية',
                startDate: '2025-01-31',
                endDate: '2025-02-10',
                durationDays: 10,
                progressPercent: 25,
                status: 'planned',
                assignee: 'عبدالله سعد',
                dependencies: ['phase-002'],
                priority: 'medium',
                createdAt: '2025-01-31T08:00:00.000Z'
            },
            {
                id: 'phase-004',
                projectId: 'project-001',
                name: 'التشطيبات النهائية',
                description: 'أعمال البلاط والدهان والتشطيبات الداخلية',
                startDate: '2025-02-11',
                endDate: '2025-02-15',
                durationDays: 4,
                progressPercent: 0,
                status: 'planned',
                assignee: 'نوره أحمد',
                dependencies: ['phase-003'],
                priority: 'medium',
                createdAt: '2025-02-11T08:00:00.000Z'
            },
            {
                id: 'phase-005',
                projectId: 'project-002',
                name: 'إعداد موقع البناء',
                description: 'تنظيف وتهيئة الموقع للبناء',
                startDate: '2025-01-10',
                endDate: '2025-01-20',
                durationDays: 10,
                progressPercent: 80,
                status: 'in_progress',
                assignee: 'احمد علي',
                dependencies: [],
                priority: 'high',
                createdAt: '2025-01-10T08:00:00.000Z'
            },
            {
                id: 'phase-006',
                projectId: 'project-002',
                name: 'الهيكل الإنشائي',
                description: 'بناء الهيكل الخرساني للمجمع',
                startDate: '2025-01-21',
                endDate: '2025-02-15',
                durationDays: 25,
                progressPercent: 15,
                status: 'planned',
                assignee: 'فاطمة محمد',
                dependencies: ['phase-005'],
                priority: 'high',
                createdAt: '2025-01-21T08:00:00.000Z'
            },
            {
                id: 'phase-007',
                projectId: 'project-003',
                name: 'التخطيط والتصاميم',
                description: 'وضع التصاميم النهائية والموافقات',
                startDate: '2025-01-20',
                endDate: '2025-02-05',
                durationDays: 16,
                progressPercent: 40,
                status: 'in_progress',
                assignee: 'نوره أحمد',
                dependencies: [],
                priority: 'high',
                createdAt: '2025-01-20T08:00:00.000Z'
            },
            {
                id: 'phase-008',
                projectId: 'project-003',
                name: 'أعمال الهدم والإزالة',
                description: 'إزالة المباني القديمة وتنظيف الموقع',
                startDate: '2025-02-06',
                endDate: '2025-02-15',
                durationDays: 9,
                progressPercent: 0,
                status: 'planned',
                assignee: 'احمد علي',
                dependencies: ['phase-007'],
                priority: 'medium',
                createdAt: '2025-02-06T08:00:00.000Z'
            }
        ];
    }

    getDefaultExpenses() {
        return [
            {
                id: 'expense-001',
                projectId: 'project-001',
                category: 'مواد',
                description: 'أسمنت ومواد بناء أساسية',
                date: '2025-01-05',
                amount: 25000,
                vatPercent: 15,
                total: 28750,
                paymentMethod: 'تحويل',
                notes: 'دفعة للموزع الرئيسي',
                attachment: null,
                createdAt: '2025-01-05T10:00:00.000Z'
            },
            {
                id: 'expense-002',
                projectId: 'project-001',
                category: 'عمالة',
                description: 'رواتب العمال - الأسبوع الأول',
                date: '2025-01-08',
                amount: 15000,
                vatPercent: 0,
                total: 15000,
                paymentMethod: 'نقدي',
                notes: 'رواتب أسبوعية للعمال',
                attachment: null,
                createdAt: '2025-01-08T14:30:00.000Z'
            },
            {
                id: 'expense-003',
                projectId: 'project-001',
                category: 'معدات',
                description: 'إيجار معدات حفر',
                date: '2025-01-10',
                amount: 8000,
                vatPercent: 15,
                total: 9200,
                paymentMethod: 'شيك',
                notes: 'إيجار لمدة أسبوع',
                attachment: null,
                createdAt: '2025-01-10T11:15:00.000Z'
            },
            {
                id: 'expense-004',
                projectId: 'project-002',
                category: 'معدات',
                description: 'إيجار حفارة لأسبوعين',
                date: '2025-01-12',
                amount: 18000,
                vatPercent: 15,
                total: 20700,
                paymentMethod: 'شيك',
                notes: 'إيجار معدات حفر',
                attachment: null,
                createdAt: '2025-01-12T09:15:00.000Z'
            },
            {
                id: 'expense-005',
                projectId: 'project-002',
                category: 'مواد',
                description: 'حديد التسليح',
                date: '2025-01-15',
                amount: 35000,
                vatPercent: 15,
                total: 40250,
                paymentMethod: 'تحويل',
                notes: 'حديد للهيكل الإنشائي',
                attachment: null,
                createdAt: '2025-01-15T13:20:00.000Z'
            }
        ];
    }

    getDefaultSubcontracts() {
        return [
            {
                id: 'subcontract-001',
                projectId: 'project-001',
                contractorName: 'شركة التشطيبات المتقدمة',
                contractTitle: 'أعمال التشطيبات الداخلية',
                value: 120000,
                startDate: '2025-01-15',
                endDate: '2025-02-10',
                paidAmount: 60000,
                remainingAmount: 60000,
                status: 'active',
                contractFile: 'finishing-contract.pdf',
                createdAt: '2025-01-10T11:20:00.000Z'
            },
            {
                id: 'subcontract-002',
                projectId: 'project-001',
                contractorName: 'مقاول الكهرباء والسباكة',
                contractTitle: 'التمديدات الكهربائية والصحية',
                value: 85000,
                startDate: '2025-01-20',
                endDate: '2025-02-05',
                paidAmount: 25000,
                remainingAmount: 60000,
                status: 'active',
                contractFile: 'electrical-contract.pdf',
                createdAt: '2025-01-18T16:45:00.000Z'
            },
            {
                id: 'subcontract-003',
                projectId: 'project-002',
                contractorName: 'شركة الحديد والخرسانة',
                contractTitle: 'أعمال الهيكل الإنشائي',
                value: 450000,
                startDate: '2025-01-25',
                endDate: '2025-03-15',
                paidAmount: 150000,
                remainingAmount: 300000,
                status: 'active',
                contractFile: 'structure-contract.pdf',
                createdAt: '2025-01-22T13:10:00.000Z'
            },
            {
                id: 'subcontract-004',
                projectId: 'project-003',
                contractorName: 'شركة الخرسانة الجاهزة',
                contractTitle: 'توريد وصب الخرسانة',
                value: 180000,
                startDate: '2025-02-01',
                endDate: '2025-03-20',
                paidAmount: 50000,
                remainingAmount: 130000,
                status: 'pending',
                contractFile: 'concrete-contract.pdf',
                createdAt: '2025-01-28T10:30:00.000Z'
            }
        ];
    }
}

// Phases Management Store
class PhasesStore {
    constructor() {
        this.phases = this.loadAllPhases();
        this.logs = this.loadPhasesLogs();
    }

    // Phase CRUD operations
    listPhases(projectId, filters = {}) {
        let phases = this.phases.filter(phase => phase.projectId === projectId);
        
        if (filters.status) {
            phases = phases.filter(phase => phase.status === filters.status);
        }
        if (filters.assignee) {
            phases = phases.filter(phase => phase.assignee === filters.assignee);
        }
        if (filters.period) {
            const now = new Date();
            const startDate = this.getPeriodStartDate(filters.period, now);
            phases = phases.filter(phase => new Date(phase.startDate) >= startDate);
        }
        
        return phases;
    }

    createPhase(projectId, data) {
        const phase = {
            id: 'phase-' + Date.now(),
            projectId: projectId,
            name: data.name,
            description: data.description || '',
            startDate: data.startDate,
            endDate: data.endDate,
            durationDays: this.calculateDurationDays(data.startDate, data.endDate),
            progressPercent: parseFloat(data.progressPercent || 0),
            status: data.status || 'planned',
            assignee: data.assignee || '',
            dependencies: data.dependencies || [],
            priority: data.priority || 'medium',
            createdAt: new Date().toISOString()
        };

        this.phases.push(phase);
        this.saveAllPhases();
        
        // Log the action
        this.logPhaseAction({
            type: 'create',
            phaseId: phase.id,
            after: phase,
            actor: 'المستخدم الحالي'
        });

        return phase;
    }

    updatePhase(id, data) {
        const phaseIndex = this.phases.findIndex(phase => phase.id === id);
        if (phaseIndex === -1) return null;

        const beforePhase = {...this.phases[phaseIndex]};
        
        // Update fields
        Object.keys(data).forEach(key => {
            if (data[key] !== undefined) {
                this.phases[phaseIndex][key] = data[key];
            }
        });

        // Recalculate duration if dates changed
        if (data.startDate || data.endDate) {
            this.phases[phaseIndex].durationDays = this.calculateDurationDays(
                this.phases[phaseIndex].startDate,
                this.phases[phaseIndex].endDate
            );
        }

        const updatedPhase = this.phases[phaseIndex];
        this.saveAllPhases();
        
        // Log the action
        this.logPhaseAction({
            type: 'update',
            phaseId: id,
            before: beforePhase,
            after: updatedPhase,
            actor: 'المستخدم الحالي'
        });

        return updatedPhase;
    }

    deletePhase(id) {
        const phaseIndex = this.phases.findIndex(phase => phase.id === id);
        if (phaseIndex === -1) return false;

        const deletedPhase = this.phases[phaseIndex];
        this.phases.splice(phaseIndex, 1);
        this.saveAllPhases();
        
        // Log the action
        this.logPhaseAction({
            type: 'delete',
            phaseId: id,
            before: deletedPhase,
            actor: 'المستخدم الحالي'
        });

        return true;
    }

    computePhaseStats(projectId) {
        const phases = this.listPhases(projectId);
        
        const totalPhases = phases.length;
        const inProgressPhases = phases.filter(p => p.status === 'in_progress').length;
        const delayedPhases = phases.filter(p => p.status === 'delayed').length;
        const completedPhases = phases.filter(p => p.status === 'done').length;
        
        const totalDuration = phases.reduce((sum, p) => sum + p.durationDays, 0);
        const completedDuration = phases.filter(p => p.status === 'done').reduce((sum, p) => sum + p.durationDays, 0);
        const remainingDuration = totalDuration - completedDuration;
        
        const overallProgress = totalPhases > 0 ? phases.reduce((sum, p) => sum + p.progressPercent, 0) / totalPhases : 0;
        
        return {
            totalPhases,
            inProgressPhases,
            delayedPhases,
            completedPhases,
            totalDuration,
            completedDuration,
            remainingDuration,
            overallProgress
        };
    }

    calculateDurationDays(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        return diffDays;
    }

    getPeriodStartDate(period, baseDate) {
        const date = new Date(baseDate);
        switch (period) {
            case 'this-week':
                const dayOfWeek = date.getDay();
                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - dayOfWeek);
                return startOfWeek;
            case 'this-month':
                return new Date(date.getFullYear(), date.getMonth(), 1);
            case 'next-month':
                return new Date(date.getFullYear(), date.getMonth() + 1, 1);
            default:
                return new Date(0);
        }
    }

    // Logging functions
    logPhaseAction({type, phaseId, before = null, after = null, actor}) {
        const logEntry = {
            id: 'phase-log-' + Date.now(),
            timestamp: new Date().toISOString(),
            type,
            phaseId,
            phaseName: after?.name || before?.name || 'غير معروف',
            before,
            after,
            actor,
            description: this.getPhaseActionDescription(type, before, after)
        };

        this.logs.unshift(logEntry);
        
        // Keep only last 500 entries
        if (this.logs.length > 500) {
            this.logs = this.logs.slice(0, 500);
        }
        
        this.savePhasesLogs();
    }

    getPhaseActionDescription(type, before, after) {
        switch (type) {
            case 'create':
                return `تم إضافة مرحلة جديدة: ${after.name}`;
            case 'update':
                return `تم تحديث المرحلة: ${after.name}`;
            case 'delete':
                return `تم حذف المرحلة: ${before.name}`;
            default:
                return 'عملية غير محددة';
        }
    }

    getAlerts(projectId) {
        const phases = this.listPhases(projectId);
        const alerts = [];
        const now = new Date();

        phases.forEach(phase => {
            // Check for overdue phases
            if (phase.status !== 'done' && new Date(phase.endDate) < now) {
                alerts.push({
                    type: 'overdue',
                    severity: 'error',
                    message: `المرحلة "${phase.name}" متأخرة عن الموعد المحدد`,
                    phaseId: phase.id
                });
            }

            // Check for phases starting soon
            const startDate = new Date(phase.startDate);
            const daysDiff = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
            if (phase.status === 'planned' && daysDiff <= 3 && daysDiff >= 0) {
                alerts.push({
                    type: 'upcoming',
                    severity: 'warning',
                    message: `المرحلة "${phase.name}" ستبدأ خلال ${daysDiff} أيام`,
                    phaseId: phase.id
                });
            }
        });

        return alerts;
    }

    // Storage functions
    saveAllPhases() {
        localStorage.setItem('project_phases_all', JSON.stringify(this.phases));
    }

    loadAllPhases() {
        const saved = localStorage.getItem('project_phases_all');
        if (saved) {
            return JSON.parse(saved);
        }
        
        // If no saved phases, load default phases
        if (typeof projectStore !== 'undefined' && projectStore) {
            return projectStore.getDefaultPhases();
        }
        
        // Fallback default phases
        return [
            {
                id: 'phase-001',
                projectId: 'project-001',
                name: 'أعمال الحفر والأساسات',
                description: 'حفر الأساسات وصب الخرسانة العادية والمسلحة',
                startDate: '2025-01-01',
                endDate: '2025-01-15',
                durationDays: 14,
                progressPercent: 100,
                status: 'done',
                assignee: 'احمد علي',
                dependencies: [],
                priority: 'high',
                createdAt: '2025-01-01T08:00:00.000Z'
            }
        ];
    }

    savePhasesLogs() {
        localStorage.setItem('phases_logs', JSON.stringify(this.logs));
    }

    loadPhasesLogs() {
        const saved = localStorage.getItem('phases_logs');
        return saved ? JSON.parse(saved) : [];
    }
}

// Initialize project store first
let projectStore = new ProjectStore();

// Daily Reports Functions
function loadDailyReports(projectId) {
    console.log('Loading daily reports for project:', projectId);
    
    if (!dailyReportsStore) {
        dailyReportsStore = new DailyReportsStore();
    }
    
    // Load daily reports data
    loadDailyReportsTable();
    updateDailyReportKPIs();
    loadPhotoGallery();
    loadWeeklySummary();
    renderDailyReportCharts();
    
    // Populate phase dropdowns
    populatePhasesInDailyReports();
}

function loadDailyReportsTable() {
    if (!dailyReportsStore || !currentProjectId) {
        console.error('Daily reports store or current project ID not available');
        return;
    }

    const reports = dailyReportsStore.listDailyReports(currentProjectId);
    const tbody = document.getElementById('dailyReportsTableBody');
    
    if (reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-text-secondary">لا توجد تقارير يومية مسجلة</td></tr>';
        return;
    }

    tbody.innerHTML = reports.map(report => {
        const phase = phasesStore ? phasesStore.listPhases(currentProjectId).find(p => p.id === report.phaseId) : null;
        const phaseName = phase ? phase.name : 'مرحلة محذوفة';
        const attachmentCount = dailyReportsStore.listAttachments(report.id).length;
        
        return `
        <tr class="hover:bg-secondary-50 transition-fast cursor-pointer" onclick="viewDailyReportDetails('${report.id}')">
            <td class="p-4 border-b border-border">
                <span class="font-medium text-text-primary">${formatDate(report.date)}</span>
            </td>
            <td class="p-4 border-b border-border">
                <span class="text-sm text-text-primary">${phaseName}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-12 bg-secondary-200 rounded-full h-2">
                        <div class="bg-${getReportStatusColor(report.status)} h-2 rounded-full" style="width: ${report.progressPercent}%"></div>
                    </div>
                    <span class="text-sm font-medium">${report.progressPercent}%</span>
                </div>
            </td>
            <td class="p-4 border-b border-border">
                <div class="text-sm text-text-primary">
                    ${report.workDescription.length > 50 ? report.workDescription.substring(0, 50) + '...' : report.workDescription}
                </div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="inline-flex items-center gap-1 text-sm text-text-primary">
                    <i class="fas fa-images text-warning"></i>
                    ${attachmentCount}
                </span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${getReportStatusColor(report.status)}-100 text-${getReportStatusColor(report.status)}">
                    ${getReportStatusText(report.status)}
                </span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="event.stopPropagation(); viewDailyReportDetails('${report.id}')" class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-primary-600 transition-fast" title="عرض">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="event.stopPropagation(); editDailyReport('${report.id}')" class="bg-warning text-white px-2 py-1 rounded text-xs hover:bg-warning-600 transition-fast" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteDailyReport('${report.id}')" class="bg-error text-white px-2 py-1 rounded text-xs hover:bg-error-600 transition-fast" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `}).join('');
}

function updateDailyReportKPIs() {
    if (!dailyReportsStore || !currentProjectId) return;

    const stats = dailyReportsStore.computeDailyReportStats(currentProjectId);
    
    document.getElementById('kpiTotalReports').textContent = stats.totalReports;
    document.getElementById('kpiWeeklyReports').textContent = stats.weeklyReports;
    document.getElementById('kpiTotalPhotos').textContent = stats.totalPhotos;
    document.getElementById('kpiAverageProgress').textContent = stats.averageProgress + '%';
}

function loadPhotoGallery() {
    if (!dailyReportsStore || !currentProjectId) return;

    const reports = dailyReportsStore.listDailyReports(currentProjectId);
    const gallery = document.getElementById('photoGallery');
    let photos = [];

    // Collect all photos from all reports
    reports.forEach(report => {
        const attachments = dailyReportsStore.listAttachments(report.id)
            .filter(att => att.fileType === 'image');
        
        attachments.forEach(att => {
            photos.push({
                ...att,
                reportDate: report.date,
                phaseId: report.phaseId
            });
        });
    });

    if (photos.length === 0) {
        gallery.innerHTML = '<div class="col-span-full text-center p-8 text-text-secondary">لا توجد صور مرفوعة بعد</div>';
        return;
    }

    // Sort photos by date (newest first)
    photos.sort((a, b) => new Date(b.reportDate) - new Date(a.reportDate));

    // Show only first 8 photos initially
    const displayPhotos = photos.slice(0, 8);
    
    gallery.innerHTML = displayPhotos.map((photo, index) => `
        <div class="aspect-square bg-secondary-100 rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition-all" onclick="openPhotoLightbox(${index}, '${photo.id}')">
            <img src="${photo.fileUrl}" alt="${photo.fileName}" class="w-full h-full object-cover" />
            <div class="p-2">
                <p class="text-xs text-text-secondary truncate">${photo.fileName}</p>
                <p class="text-xs text-text-secondary">${formatDate(photo.reportDate)}</p>
            </div>
        </div>
    `).join('');
}

function loadWeeklySummary() {
    if (!dailyReportsStore || !currentProjectId) return;

    const weeklySummary = dailyReportsStore.computeWeeklySummary(currentProjectId);
    
    document.getElementById('weeklyProgressRate').textContent = weeklySummary.progressRate + '%';
    document.getElementById('weeklyReportsAdded').textContent = weeklySummary.reportsAdded;
    document.getElementById('weeklyAttachments').textContent = weeklySummary.attachments;
    document.getElementById('expectedDelay').textContent = weeklySummary.expectedDelay + ' أيام';

    // Load phase performance
    if (phasesStore) {
        const phases = phasesStore.listPhases(currentProjectId);
        const tbody = document.getElementById('weeklyPerformanceBody');
        
        if (phases.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-text-secondary">لا توجد مراحل</td></tr>';
            return;
        }

        tbody.innerHTML = phases.map(phase => `
            <tr class="hover:bg-secondary-50">
                <td class="p-3 border-b border-border text-sm">${phase.name}</td>
                <td class="p-3 border-b border-border text-center text-sm">${phase.progressPercent}%</td>
                <td class="p-3 border-b border-border text-center">
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-${getPerformanceColor(phase.progressPercent)}-100 text-${getPerformanceColor(phase.progressPercent)}">
                        ${getPerformanceText(phase.progressPercent)}
                    </span>
                </td>
                <td class="p-3 border-b border-border text-center">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${getPhaseStatusColor(phase.status)}-100 text-${getPhaseStatusColor(phase.status)}">
                        ${getPhaseStatusText(phase.status)}
                    </span>
                </td>
            </tr>
        `).join('');
    }
}

function renderDailyReportCharts() {
    // Daily Progress Chart
    const progressCtx = document.getElementById('dailyProgressChart');
    if (progressCtx && dailyReportsStore && currentProjectId) {
        const progressData = dailyReportsStore.computeProgressOverTime(currentProjectId);
        
        // Simple chart representation (in real app would use Chart.js)
        progressCtx.innerHTML = '<div class="flex items-center justify-center h-full text-text-secondary">مخطط التقدم اليومي<br><small>سيتم تطويره لاحقاً</small></div>';
    }

    // Photos Per Phase Chart
    const photosCtx = document.getElementById('photosPerPhaseChart');
    if (photosCtx && dailyReportsStore && phasesStore && currentProjectId) {
        photosCtx.innerHTML = '<div class="flex items-center justify-center h-full text-text-secondary">مخطط توزيع الصور<br><small>سيتم تطويره لاحقاً</small></div>';
    }
}

function populatePhasesInDailyReports() {
    if (!phasesStore || !currentProjectId) return;

    const phases = phasesStore.listPhases(currentProjectId);
    
    // Populate filter dropdown
    const filterSelect = document.getElementById('filterReportPhase');
    if (filterSelect) {
        filterSelect.innerHTML = '<option value="">جميع المراحل</option>' + 
            phases.map(phase => `<option value="${phase.id}">${phase.name}</option>`).join('');
    }

    // Populate report form dropdown
    const reportPhaseSelect = document.getElementById('reportPhaseId');
    if (reportPhaseSelect) {
        reportPhaseSelect.innerHTML = '<option value="">اختر المرحلة</option>' + 
            phases.map(phase => `<option value="${phase.id}">${phase.name}</option>`).join('');
    }

    // Populate photo upload dropdown
    const photoPhaseSelect = document.getElementById('photoPhaseId');
    if (photoPhaseSelect) {
        photoPhaseSelect.innerHTML = '<option value="">اختر المرحلة</option>' + 
            phases.map(phase => `<option value="${phase.id}">${phase.name}</option>`).join('');
    }

    // Populate progress chart dropdown
    const chartPhaseSelect = document.getElementById('progressChartPhase');
    if (chartPhaseSelect) {
        chartPhaseSelect.innerHTML = '<option value="all">جميع المراحل</option>' +
            '<option value="overall">الإجمالي العام</option>' +
            phases.map(phase => `<option value="${phase.id}">${phase.name}</option>`).join('');
    }
}

// Daily Reports Modal Functions
function openAddDailyReportModal() {
    document.getElementById('modalDailyReportTitle').textContent = 'إضافة تقرير يومي جديد';
    document.getElementById('dailyReportForm').reset();
    document.getElementById('dailyReportId').value = '';
    document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('reportProgressDisplay').textContent = '0%';
    
    // Set project name
    if (currentProjectData) {
        document.getElementById('reportProjectName').value = currentProjectData.name;
    }
    
    // Clear file preview
    document.getElementById('filePreview').classList.add('hidden');
    
    document.getElementById('modalDailyReportForm').classList.remove('hidden');
}

function closeDailyReportModal() {
    document.getElementById('modalDailyReportForm').classList.add('hidden');
}

function openUploadTodayPhotosModal() {
    document.getElementById('uploadPhotosForm').reset();
    document.getElementById('photoPreviewGrid').classList.add('hidden');
    document.getElementById('modalUploadPhotos').classList.remove('hidden');
}

function closeUploadPhotosModal() {
    document.getElementById('modalUploadPhotos').classList.add('hidden');
}

function editDailyReport(reportId) {
    if (!dailyReportsStore) return;
    
    const report = dailyReportsStore.getDailyReport(reportId);
    if (!report) return;

    document.getElementById('modalDailyReportTitle').textContent = 'تعديل التقرير اليومي';
    document.getElementById('dailyReportId').value = report.id;
    document.getElementById('reportDate').value = report.date;
    document.getElementById('reportPhaseId').value = report.phaseId;
    document.getElementById('reportProgress').value = report.progressPercent;
    document.getElementById('reportProgressDisplay').textContent = report.progressPercent + '%';
    document.getElementById('reportWorkDescription').value = report.workDescription;
    document.getElementById('reportIssues').value = report.issues;
    document.getElementById('reportWeather').value = report.weather;
    document.getElementById('reportWorkersCount').value = report.workersCount;
    document.getElementById('reportEquipmentUsed').value = report.equipmentUsed;

    if (currentProjectData) {
        document.getElementById('reportProjectName').value = currentProjectData.name;
    }

    document.getElementById('modalDailyReportForm').classList.remove('hidden');
}

function deleteDailyReport(reportId) {
    if (!dailyReportsStore) return;
    
    const report = dailyReportsStore.getDailyReport(reportId);
    if (!report) return;

    itemToDelete = reportId;
    deleteCallback = () => {
        dailyReportsStore.deleteDailyReport(reportId);
        loadDailyReportsTable();
        updateDailyReportKPIs();
        loadPhotoGallery();
        loadWeeklySummary();
    };
    
    document.getElementById('deleteConfirmText').textContent = `هل أنت متأكد من حذف التقرير اليومي بتاريخ "${formatDate(report.date)}"؟`;
    document.getElementById('confirmDeleteBtn').textContent = 'حذف التقرير';
    document.getElementById('modalConfirmDelete').classList.remove('hidden');
}

function viewDailyReportDetails(reportId) {
    // Open detailed view modal (would be implemented as separate modal)
    console.log('Viewing daily report details for:', reportId);
    alert('عرض تفاصيل التقرير - قيد التطوير');
}

// Photo Gallery Functions
function openFullScreenGallery() {
    document.getElementById('modalFullScreenGallery').classList.remove('hidden');
    // Load full gallery
    loadFullScreenGallery();
}

function closeFullScreenGallery() {
    document.getElementById('modalFullScreenGallery').classList.add('hidden');
}

function loadFullScreenGallery() {
    const gallery = document.getElementById('fullScreenGalleryGrid');
    // Load all photos in full screen mode
    gallery.innerHTML = '<div class="col-span-full text-center p-8 text-white">معرض الصور الكامل - قيد التطوير</div>';
}

function openPhotoLightbox(index, photoId) {
    document.getElementById('modalPhotoLightbox').classList.remove('hidden');
    // Load photo in lightbox
    const lightboxContent = document.getElementById('lightboxContent');
    lightboxContent.innerHTML = '<div class="text-white text-center">عرض الصورة - قيد التطوير</div>';
}

function closePhotoLightbox() {
    document.getElementById('modalPhotoLightbox').classList.add('hidden');
}

function previousPhoto() {
    console.log('Previous photo');
}

function nextPhoto() {
    console.log('Next photo');
}

function downloadPhoto() {
    console.log('Download photo');
}

// Filter and Search Functions
function applyDailyReportFilters() {
    const filters = {
        phaseId: document.getElementById('filterReportPhase').value,
        status: document.getElementById('filterReportStatus').value,
        dateFrom: document.getElementById('filterReportDateFrom').value,
        dateTo: document.getElementById('filterReportDateTo').value
    };
    
    console.log('Applying daily report filters:', filters);
    loadDailyReportsTable();
}

function clearDailyReportFilters() {
    document.getElementById('filterReportPhase').value = '';
    document.getElementById('filterReportStatus').value = '';
    document.getElementById('filterReportDateFrom').value = '';
    document.getElementById('filterReportDateTo').value = '';
    
    loadDailyReportsTable();
}

function sortDailyReportTable(field) {
    console.log('Sorting daily reports by:', field);
}

// Chart and Analytics Functions
function refreshProgressChart() {
    console.log('Refreshing progress chart');
    renderDailyReportCharts();
}

function loadMorePhotos() {
    console.log('Loading more photos');
}

// Utility Functions for Daily Reports
function getReportStatusColor(status) {
    const colorMap = {
        'in_progress': 'warning',
        'completed': 'success',
        'delayed': 'error'
    };
    return colorMap[status] || 'secondary';
}

function getReportStatusText(status) {
    const textMap = {
        'in_progress': 'جاري التنفيذ',
        'completed': 'منجز',
        'delayed': 'متأخر'
    };
    return textMap[status] || status;
}

function getPerformanceColor(progressPercent) {
    if (progressPercent >= 80) return 'success';
    if (progressPercent >= 50) return 'warning';
    return 'error';
}

function getPerformanceText(progressPercent) {
    if (progressPercent >= 80) return 'ممتاز';
    if (progressPercent >= 50) return 'جيد';
    return 'يحتاج تحسين';
}

// Placeholder functions for other features
function viewPreviousReports() {
    alert('عرض التقارير السابقة - قيد التطوير');
}

function updateCumulativeProgress() {
    if (confirm('هل تريد تحديث التقدم التراكمي لجميع المراحل من التقارير اليومية؟')) {
        alert('تم تحديث التقدم التراكمي بنجاح');
        if (phasesStore) {
            loadProjectPhases(currentProjectId);
        }
    }
}

// Main functions for project management
function openProjectDetails(projectId, projectName) {
    try {
        currentProjectId = projectId;
        currentProjectData = projectStore.getProject(projectId);
        
        if (!currentProjectData) {
            console.error('Project not found:', projectId);
            alert('لم يتم العثور على بيانات المشروع');
            return;
        }

        console.log('Loading project:', currentProjectData);

        // Initialize phases store
        phasesStore = new PhasesStore();

        // Initialize daily reports store
        dailyReportsStore = new DailyReportsStore();

        // Hide projects list and show project details
        document.getElementById('projects-list').classList.add('hidden');
        document.getElementById('project-details').classList.remove('hidden');
        document.getElementById('backButton').style.display = 'block';

        // Update project header
        document.getElementById('currentProjectTitle').textContent = projectName;
        document.getElementById('currentProjectCode').textContent = currentProjectData.code || '#PRJ-001';
        document.getElementById('projectProgress').textContent = currentProjectData.progress + '%';

        // Load project information tab by default
        switchProjectTab('project-information');
        
        // Update project details
        updateProjectInformation();
        
    } catch (error) {
        console.error('Error opening project details:', error);
        alert('حدث خطأ أثناء فتح تفاصيل المشروع');
    }
}

function backToProjectsList() {
    currentProjectId = null;
    currentProjectData = null;
    phasesStore = null;
    dailyReportsStore = null;
    
    document.getElementById('project-details').classList.add('hidden');
    document.getElementById('projects-list').classList.remove('hidden');
    document.getElementById('backButton').style.display = 'none';
}

function switchProjectTab(tabName) {
    console.log('Switching to tab:', tabName);
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-primary', 'text-primary');
        button.classList.add('border-transparent', 'text-text-secondary');
    });

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Activate selected tab
    const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeButton) {
        activeButton.classList.add('active', 'border-primary', 'text-primary');
        activeButton.classList.remove('border-transparent', 'text-text-secondary');
    }

    // Show selected tab content
    const activeContent = document.getElementById(tabName);
    if (activeContent) {
        activeContent.classList.remove('hidden');
    }

    // Load specific tab content
    switch (tabName) {
        case 'project-information':
            updateProjectInformation();
            break;
        case 'project-phases':
            loadProjectPhases(currentProjectId);
            break;
        case 'expenses-and-contracts':
            loadExpensesAndContracts(currentProjectId);
            break;
        case 'project-payments':
            loadProjectPayments(currentProjectId);
            break;
        case 'daily-reports':
            loadDailyReports(currentProjectId);
            break;
        case 'financial-analysis':
            loadFinancialAnalysis(currentProjectId);
            break;
    }
}

function updateProjectInformation() {
    if (!currentProjectData) {
        console.error('No current project data available');
        return;
    }

    console.log('Updating project information for:', currentProjectData);

    // Update basic project details
    document.getElementById('projectDuration').textContent = calculateDuration(currentProjectData.startDate, currentProjectData.endDate) + ' يوم';
    document.getElementById('projectValue').textContent = formatCurrency(currentProjectData.value);
    
    // Update status badge
    const statusBadge = document.getElementById('projectStatusBadge');
    statusBadge.textContent = getStatusText(currentProjectData.status);
    statusBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-${getStatusColor(currentProjectData.status)}-100 text-${getStatusColor(currentProjectData.status)}`;

    // Load additional contracts
    loadAdditionalContracts();
    
    // Update KPIs with real data
    updateProjectKPIs();
}

function updateProjectKPIs() {
    if (!currentProjectId) return;

    const combinedStats = projectStore.computeCombinedStats(currentProjectId);
    
    document.getElementById('kpiTotalExpenses').textContent = formatCurrency(combinedStats.expenses.totalWithVAT);
    document.getElementById('kpiReceivedPayments').textContent = '425,000 ريال'; // Placeholder
    document.getElementById('kpiSubcontracts').textContent = combinedStats.contracts.count + ' عقود';
    
    const expenseRatio = currentProjectData.value > 0 ? 
        (combinedStats.expenses.totalWithVAT / currentProjectData.value * 100).toFixed(1) : 0;
    document.getElementById('kpiExpenseRatio').textContent = expenseRatio + '%';
    
    document.getElementById('receivedPayments').textContent = '425,000 ر.س';
    document.getElementById('remainingPayments').textContent = (currentProjectData.value - 425000).toLocaleString() + ' ر.س';
    document.getElementById('receivedPercentage').textContent = Math.round((425000 / currentProjectData.value) * 100) + '%';
    document.getElementById('remainingPercentage').textContent = Math.round(((currentProjectData.value - 425000) / currentProjectData.value) * 100) + '%';
}

function loadAdditionalContracts() {
    const contracts = projectStore.listAdditionalContracts(currentProjectId);
    const tbody = document.getElementById('additionalContractsBody');
    
    if (contracts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-text-secondary">لا توجد عقود إضافية</td></tr>';
        return;
    }

    tbody.innerHTML = contracts.map(contract => `
        <tr class="hover:bg-secondary-50">
            <td class="p-4 border-b border-border font-medium">${contract.contractNumber}</td>
            <td class="p-4 border-b border-border">${contract.description}</td>
            <td class="p-4 border-b border-border text-center font-bold">${formatCurrency(contract.value)}</td>
            <td class="p-4 border-b border-border text-center">${formatDate(contract.signedDate)}</td>
            <td class="p-4 border-b border-border text-center">
                ${contract.file ? 
                    `<span class="text-xs bg-success text-white px-2 py-1 rounded">PDF</span>` : 
                    '<span class="text-xs text-text-secondary">لا يوجد</span>'
                }
            </td>
            <td class="p-4 border-b border-border text-center">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editAdditionalContract('${contract.id}')" class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-primary-600 transition-fast">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteAdditionalContract('${contract.id}')" class="bg-error text-white px-2 py-1 rounded text-xs hover:bg-error-600 transition-fast">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Project Phases Management Functions
function loadProjectPhases(projectId) {
    console.log('Loading phases for project:', projectId);
    
    if (!phasesStore) {
        phasesStore = new PhasesStore();
    }
    
    // Initialize with phases main sub-tab active
    switchPhaseSubTab('phases-main');
    
    // Load phases data
    loadPhasesMainTab();
    updatePhasesAnalytics();
    loadPhasesLogs();
}

function loadPhasesMainTab() {
    if (!phasesStore || !currentProjectId) {
        console.error('Phases store or current project ID not available');
        return;
    }

    const phases = phasesStore.listPhases(currentProjectId);
    console.log('Loading phases for project:', currentProjectId, 'Found phases:', phases);
    
    const tbody = document.getElementById('phasesTableBody');
    
    if (phases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-text-secondary">لا توجد مراحل مسجلة للمشروع</td></tr>';
        renderGanttChart([]);
        return;
    }

    tbody.innerHTML = phases.map(phase => `
        <tr class="hover:bg-secondary-50 transition-fast">
            <td class="p-4 border-b border-border">
                <div class="font-medium text-text-primary">${phase.name}</div>
                <div class="text-xs text-text-secondary">${phase.description || ''}</div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(phase.startDate)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(phase.endDate)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-medium">${phase.durationDays}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-16 bg-secondary-200 rounded-full h-2">
                        <div class="bg-${getPhaseStatusColor(phase.status)} h-2 rounded-full" style="width: ${phase.progressPercent}%"></div>
                    </div>
                    <span class="text-sm font-medium">${phase.progressPercent}%</span>
                </div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${getPhaseStatusColor(phase.status)}-100 text-${getPhaseStatusColor(phase.status)}">
                    ${getPhaseStatusText(phase.status)}
                </span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${phase.assignee || '-'}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-xs text-text-secondary">${phase.dependencies.length} اعتماديات</span>
            </td>
            <td class="p-4 border-b border-border">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editPhase('${phase.id}')" class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-primary-600 transition-fast" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deletePhase('${phase.id}')" class="bg-error text-white px-2 py-1 rounded text-xs hover:bg-error-600 transition-fast" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    // Render Gantt chart
    renderGanttChart(phases);
}

function updatePhasesAnalytics() {
    if (!phasesStore || !currentProjectId) return;

    const stats = phasesStore.computePhaseStats(currentProjectId);
    console.log('Phase stats:', stats);
    
    // Update KPI cards
    document.getElementById('totalPhases').textContent = stats.totalPhases;
    document.getElementById('inProgressPhases').textContent = stats.inProgressPhases;
    document.getElementById('delayedPhases').textContent = stats.delayedPhases;
    document.getElementById('completedPhases').textContent = stats.completedPhases;
    
    // Update progress section
    document.getElementById('overallProgressPercent').textContent = Math.round(stats.overallProgress) + '%';
    document.getElementById('overallProgressBar').style.width = stats.overallProgress + '%';
    document.getElementById('totalDuration').textContent = stats.totalDuration + ' يوم';
    document.getElementById('completedDuration').textContent = stats.completedDuration + ' يوم';
    document.getElementById('remainingDuration').textContent = stats.remainingDuration + ' يوم';
}

function loadPhasesLogs() {
    if (!phasesStore) return;

    const logs = phasesStore.logs;
    const tbody = document.getElementById('logsTableBody');
    const alertsContainer = document.getElementById('alertsContainer');
    
    // Load alerts
    const alerts = phasesStore.getAlerts(currentProjectId);
    
    if (alerts.length === 0) {
        alertsContainer.innerHTML = '<p class="text-text-secondary text-sm">لا توجد تنبيهات حالياً</p>';
    } else {
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="bg-${alert.severity === 'error' ? 'error' : 'warning'}-50 border border-${alert.severity === 'error' ? 'error' : 'warning'}-200 rounded-lg p-3">
                <p class="text-${alert.severity === 'error' ? 'error' : 'warning'} text-sm">${alert.message}</p>
            </div>
        `).join('');
    }
    
    // Load logs
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-text-secondary">لا توجد سجلات</td></tr>';
        return;
    }

    tbody.innerHTML = logs.slice(0, 50).map(log => `
        <tr class="hover:bg-secondary-50">
            <td class="p-4 border-b border-border text-sm">
                ${formatDateTime(log.timestamp)}
            </td>
            <td class="p-4 border-b border-border text-sm">
                ${log.actor}
            </td>
            <td class="p-4 border-b border-border text-sm">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-${getLogTypeColor(log.type)}-100 text-${getLogTypeColor(log.type)}">
                    ${getLogTypeText(log.type)}
                </span>
            </td>
            <td class="p-4 border-b border-border text-sm">
                ${log.phaseName}
            </td>
            <td class="p-4 border-b border-border text-sm">
                ${log.description}
            </td>
        </tr>
    `).join('');
}

function renderGanttChart(phases) {
    const container = document.getElementById('ganttContainer');
    
    if (phases.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-text-secondary">لا توجد مراحل لعرضها في مخطط جانت</div>';
        return;
    }

    // Simple Gantt chart representation
    let ganttHTML = '<div class="gantt-chart p-4">';
    ganttHTML += '<div class="text-sm font-medium text-text-primary mb-4">مخطط جانت للمراحل</div>';
    
    phases.forEach(phase => {
        const progress = phase.progressPercent;
        const statusColor = getPhaseStatusColor(phase.status);
        
        ganttHTML += `
            <div class="gantt-row mb-3 p-3 bg-secondary-50 rounded">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-text-primary">${phase.name}</span>
                    <span class="text-xs text-text-secondary">${formatDate(phase.startDate)} - ${formatDate(phase.endDate)}</span>
                </div>
                <div class="w-full bg-secondary-200 rounded-full h-4">
                    <div class="bg-${statusColor} h-4 rounded-full flex items-center justify-center" style="width: ${progress}%">
                        ${progress > 20 ? `<span class="text-white text-xs font-medium">${progress}%</span>` : ''}
                    </div>
                </div>
                <div class="mt-1 text-xs text-text-secondary">
                    المسؤول: ${phase.assignee || 'غير محدد'} • المدة: ${phase.durationDays} يوم • الحالة: ${getPhaseStatusText(phase.status)}
                </div>
            </div>
        `;
    });
    
    ganttHTML += '</div>';
    container.innerHTML = ganttHTML;
}

function switchPhaseSubTab(tabName) {
    console.log('Switching to phase sub-tab:', tabName);
    
    // Update sub-tab buttons
    document.querySelectorAll('.phase-subtab-button').forEach(button => {
        button.classList.remove('active', 'border-primary', 'text-primary');
        button.classList.add('border-transparent', 'text-text-secondary');
    });

    // Hide all sub-tab contents
    document.querySelectorAll('.phase-subtab-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Activate selected sub-tab
    const activeButton = document.querySelector(`[data-subtab="${tabName}"]`);
    if (activeButton) {
        activeButton.classList.add('active', 'border-primary', 'text-primary');
        activeButton.classList.remove('border-transparent', 'text-text-secondary');
    }

    // Show selected sub-tab content
    const activeContent = document.getElementById(tabName);
    if (activeContent) {
        activeContent.classList.remove('hidden');
    }

    // Load specific content
    switch (tabName) {
        case 'phases-main':
            loadPhasesMainTab();
            break;
        case 'phases-analytics':
            updatePhasesAnalytics();
            break;
        case 'phases-logs':
            loadPhasesLogs();
            break;
    }
}

// Phase Modal Functions
function openAddPhaseModal() {
    document.getElementById('modalPhaseTitle').textContent = 'إضافة مرحلة جديدة';
    document.getElementById('phaseForm').reset();
    document.getElementById('phaseId').value = '';
    document.getElementById('phaseStartDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('progressDisplay').textContent = '0%';
    
    // Populate dependencies dropdown
    populatePhaseDependencies();
    
    document.getElementById('modalPhaseForm').classList.remove('hidden');
}

function closePhaseModal() {
    document.getElementById('modalPhaseForm').classList.add('hidden');
}

function editPhase(phaseId) {
    if (!phasesStore) return;
    
    const phases = phasesStore.listPhases(currentProjectId);
    const phase = phases.find(p => p.id === phaseId);
    if (!phase) return;

    document.getElementById('modalPhaseTitle').textContent = 'تعديل المرحلة';
    document.getElementById('phaseId').value = phase.id;
    document.getElementById('phaseName').value = phase.name;
    document.getElementById('phaseDescription').value = phase.description;
    document.getElementById('phaseStartDate').value = phase.startDate;
    document.getElementById('phaseEndDate').value = phase.endDate;
    document.getElementById('phaseProgress').value = phase.progressPercent;
    document.getElementById('progressDisplay').textContent = phase.progressPercent + '%';
    document.getElementById('phaseStatus').value = phase.status;
    document.getElementById('phaseAssignee').value = phase.assignee;
    document.getElementById('phasePriority').value = phase.priority;

    populatePhaseDependencies(phase.dependencies);
    document.getElementById('modalPhaseForm').classList.remove('hidden');
}

function deletePhase(phaseId) {
    if (!phasesStore) return;
    
    const phases = phasesStore.listPhases(currentProjectId);
    const phase = phases.find(p => p.id === phaseId);
    if (!phase) return;

    itemToDelete = phaseId;
    deleteCallback = () => {
        phasesStore.deletePhase(phaseId);
        loadPhasesMainTab();
        updatePhasesAnalytics();
    };
    
    document.getElementById('deleteConfirmText').textContent = `هل أنت متأكد من حذف المرحلة "${phase.name}"؟`;
    document.getElementById('confirmDeleteBtn').textContent = 'حذف المرحلة';
    document.getElementById('modalConfirmDelete').classList.remove('hidden');
}

function populatePhaseDependencies(selectedDeps = []) {
    if (!phasesStore) return;
    
    const phases = phasesStore.listPhases(currentProjectId);
    const select = document.getElementById('phaseDependencies');
    
    select.innerHTML = phases.map(phase => `
        <option value="${phase.id}" ${selectedDeps.includes(phase.id) ? 'selected' : ''}>
            ${phase.name}
        </option>
    `).join('');
}

// Phase Filter and Utility Functions
function applyPhaseFilters() {
    if (!phasesStore) return;

    const filters = {
        status: document.getElementById('filterStatus').value,
        assignee: document.getElementById('filterAssignee').value,
        period: document.getElementById('filterPeriod').value
    };
    
    const filteredPhases = phasesStore.listPhases(currentProjectId, filters);
    renderFilteredPhases(filteredPhases);
}

function clearPhaseFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterAssignee').value = '';
    document.getElementById('filterPeriod').value = '';
    
    loadPhasesMainTab();
}

function renderFilteredPhases(phases) {
    const tbody = document.getElementById('phasesTableBody');
    
    if (phases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-text-secondary">لا توجد مراحل تطابق الفلاتر المحددة</td></tr>';
        return;
    }

    tbody.innerHTML = phases.map(phase => `
        <tr class="hover:bg-secondary-50 transition-fast">
            <td class="p-4 border-b border-border">
                <div class="font-medium text-text-primary">${phase.name}</div>
                <div class="text-xs text-text-secondary">${phase.description || ''}</div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(phase.startDate)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(phase.endDate)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-medium">${phase.durationDays}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-16 bg-secondary-200 rounded-full h-2">
                        <div class="bg-${getPhaseStatusColor(phase.status)} h-2 rounded-full" style="width: ${phase.progressPercent}%"></div>
                    </div>
                    <span class="text-sm font-medium">${phase.progressPercent}%</span>
                </div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${getPhaseStatusColor(phase.status)}-100 text-${getPhaseStatusColor(phase.status)}">
                    ${getPhaseStatusText(phase.status)}
                </span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${phase.assignee || '-'}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-xs text-text-secondary">${phase.dependencies.length} اعتماديات</span>
            </td>
            <td class="p-4 border-b border-border">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editPhase('${phase.id}')" class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-primary-600 transition-fast" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deletePhase('${phase.id}')" class="bg-error text-white px-2 py-1 rounded text-xs hover:bg-error-600 transition-fast" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function sortPhaseTable(field) {
    if (!phasesStore) return;
    
    console.log('Sorting phases by:', field);
    // Implement sorting logic if needed
}

// Phase utility functions
function getPhaseStatusColor(status) {
    const colorMap = {
        'planned': 'secondary',
        'in_progress': 'warning', 
        'delayed': 'error',
        'done': 'success'
    };
    return colorMap[status] || 'secondary';
}

function getPhaseStatusText(status) {
    const textMap = {
        'planned': 'مخططة',
        'in_progress': 'جارية',
        'delayed': 'متأخرة',
        'done': 'منتهية'
    };
    return textMap[status] || status;
}

function getLogTypeColor(type) {
    const colorMap = {
        'create': 'success',
        'update': 'warning',
        'delete': 'error'
    };
    return colorMap[type] || 'secondary';
}

function getLogTypeText(type) {
    const textMap = {
        'create': 'إضافة',
        'update': 'تحديث', 
        'delete': 'حذف'
    };
    return textMap[type] || type;
}

function formatDateTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('ar-SA') + ' ' + date.toLocaleTimeString('ar-SA', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Gantt chart functions
function zoomGanttIn() {
    console.log('Zooming Gantt chart in');
}

function zoomGanttOut() {
    console.log('Zooming Gantt chart out');
}

function refreshGantt() {
    if (phasesStore) {
        const phases = phasesStore.listPhases(currentProjectId);
        renderGanttChart(phases);
    }
}

// Expenses and Contracts Management Functions
function loadExpensesAndContracts(projectId) {
    // Initialize with expenses sub-tab active
    switchUnifiedSubTab('expenses-main');
    updateUnifiedKPIs();
}

function switchUnifiedSubTab(tabName) {
    // Update sub-tab buttons
    document.querySelectorAll('.unified-subtab-button').forEach(button => {
        button.classList.remove('active', 'border-primary', 'text-primary');
        button.classList.add('border-transparent', 'text-text-secondary');
    });

    // Hide all sub-tab contents
    document.querySelectorAll('.unified-subtab-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Activate selected sub-tab
    const activeButton = document.querySelector(`[data-subtab="${tabName}"]`);
    if (activeButton) {
        activeButton.classList.add('active', 'border-primary', 'text-primary');
        activeButton.classList.remove('border-transparent', 'text-text-secondary');
    }

    // Show selected sub-tab content
    const activeContent = document.getElementById(tabName);
    if (activeContent) {
        activeContent.classList.remove('hidden');
    }

    // Load specific content
    switch (tabName) {
        case 'expenses-main':
            loadExpensesSubTab();
            break;
        case 'subcontracts-main':
            loadSubcontractsSubTab();
            break;
        case 'combined-analytics':
            loadCombinedAnalytics();
            break;
    }
}

function updateUnifiedKPIs() {
    if (!currentProjectId) return;
    
    const combinedStats = projectStore.computeCombinedStats(currentProjectId);
    
    // Update expenses KPIs
    document.getElementById('expensesTotalAmount').textContent = formatCurrency(combinedStats.expenses.totalWithVAT);
    document.getElementById('expensesMonthlyAmount').textContent = formatCurrency(combinedStats.expenses.monthlyAmount);
    document.getElementById('expensesCount').textContent = combinedStats.expenses.count;
    document.getElementById('expensesAverage').textContent = formatCurrency(combinedStats.expenses.averageAmount);

    // Update subcontracts KPIs
    document.getElementById('subcontractsCount').textContent = combinedStats.contracts.count;
    document.getElementById('subcontractsTotalValue').textContent = formatCurrency(combinedStats.contracts.totalValue);
    document.getElementById('subcontractsPaidAmount').textContent = formatCurrency(combinedStats.contracts.totalPaid);
    document.getElementById('subcontractsRemainingAmount').textContent = formatCurrency(combinedStats.contracts.totalRemaining);

    // Update combined analytics KPIs
    document.getElementById('combinedExpensesTotal').textContent = formatCurrency(combinedStats.expenses.totalWithVAT);
    document.getElementById('combinedContractsTotal').textContent = formatCurrency(combinedStats.contracts.totalValue);
    document.getElementById('combinedRatio').textContent = combinedStats.contractsToExpensesRatio.toFixed(1) + '%';
    document.getElementById('combinedTotalSpend').textContent = formatCurrency(combinedStats.totalSpend);
}

function loadExpensesSubTab() {
    const expenses = projectStore.listExpenses(currentProjectId);
    const tbody = document.getElementById('expensesTableBody');
    
    if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-text-secondary">لا توجد مصاريف مسجلة</td></tr>';
        return;
    }

    tbody.innerHTML = expenses.map(expense => `
        <tr class="hover:bg-secondary-50 transition-fast">
            <td class="p-4 border-b border-border">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-${getCategoryColor(expense.category)}-100 text-${getCategoryColor(expense.category)}">
                    ${getCategoryIcon(expense.category)} ${expense.category}
                </span>
            </td>
            <td class="p-4 border-b border-border">
                <div class="font-medium text-text-primary">${expense.description}</div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(expense.date)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-bold text-text-primary">${formatCurrency(expense.amount)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${expense.vatPercent}%</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-bold text-primary">${formatCurrency(expense.total)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${expense.paymentMethod}</span>
            </td>
            <td class="p-4 border-b border-border">
                <span class="text-sm text-text-secondary">${expense.notes || '-'}</span>
            </td>
            <td class="p-4 border-b border-border">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editExpense('${expense.id}')" class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-primary-600 transition-fast" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteExpense('${expense.id}')" class="bg-error text-white px-2 py-1 rounded text-xs hover:bg-error-600 transition-fast" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function loadSubcontractsSubTab() {
    const subcontracts = projectStore.listSubcontracts(currentProjectId);
    const tbody = document.getElementById('subcontractsTableBody');
    
    if (subcontracts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-text-secondary">لا توجد عقود باطن مسجلة</td></tr>';
        return;
    }

    tbody.innerHTML = subcontracts.map(contract => `
        <tr class="hover:bg-secondary-50 transition-fast">
            <td class="p-4 border-b border-border">
                <div class="font-medium text-text-primary">${contract.contractorName}</div>
            </td>
            <td class="p-4 border-b border-border">
                <div class="font-medium text-text-primary">${contract.contractTitle}</div>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-bold text-primary">${formatCurrency(contract.value)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(contract.startDate)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="text-sm">${formatDate(contract.endDate)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-bold text-success">${formatCurrency(contract.paidAmount)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="font-bold text-warning">${formatCurrency(contract.remainingAmount)}</span>
            </td>
            <td class="p-4 border-b border-border text-center">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${getContractStatusColor(contract.status)}-100 text-${getContractStatusColor(contract.status)}">
                    ${getContractStatusText(contract.status)}
                </span>
            </td>
            <td class="p-4 border-b border-border">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editSubcontract('${contract.id}')" class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-primary-600 transition-fast" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteSubcontract('${contract.id}')" class="bg-error text-white px-2 py-1 rounded text-xs hover:bg-error-600 transition-fast" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function loadCombinedAnalytics() {
    console.log('Loading combined analytics...');
    updateUnifiedKPIs();
    // Render charts would go here
    renderCombinedCharts();
}

function renderCombinedCharts() {
    // Placeholder for chart rendering
    console.log('Rendering combined charts...');
}

// Modal functions
function openEditProjectModal() {
    if (!currentProjectData) return;
    
    document.getElementById('editProjectName').value = currentProjectData.name;
    document.getElementById('editProjectCode').value = currentProjectData.code;
    document.getElementById('editClientName').value = currentProjectData.client;
    document.getElementById('editStartDate').value = currentProjectData.startDate;
    document.getElementById('editEndDate').value = currentProjectData.endDate;
    document.getElementById('editProjectValue').value = currentProjectData.value;
    document.getElementById('editProjectStatus').value = currentProjectData.status;
    document.getElementById('editProjectNotes').value = currentProjectData.notes || '';
    
    document.getElementById('modalEditProject').classList.remove('hidden');
}

function closeEditProjectModal() {
    document.getElementById('modalEditProject').classList.add('hidden');
}

function openContractUploadModal() {
    document.getElementById('modalContractUpload').classList.remove('hidden');
}

function closeContractUploadModal() {
    document.getElementById('modalContractUpload').classList.add('hidden');
}

function openAddAdditionalContractModal() {
    document.getElementById('modalAdditionalContractTitle').textContent = 'إضافة عقد إضافي';
    document.getElementById('additionalContractForm').reset();
    document.getElementById('additionalContractId').value = '';
    document.getElementById('contractSignedDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('modalAdditionalContract').classList.remove('hidden');
}

function closeAdditionalContractModal() {
    document.getElementById('modalAdditionalContract').classList.add('hidden');
}

function editAdditionalContract(contractId) {
    const contracts = projectStore.listAdditionalContracts(currentProjectId);
    const contract = contracts.find(c => c.id === contractId);
    if (!contract) return;

    document.getElementById('modalAdditionalContractTitle').textContent = 'تعديل العقد الإضافي';
    document.getElementById('additionalContractId').value = contract.id;
    document.getElementById('contractNumber').value = contract.contractNumber;
    document.getElementById('contractDescription').value = contract.description;
    document.getElementById('contractValue').value = contract.value;
    document.getElementById('contractSignedDate').value = contract.signedDate;

    document.getElementById('modalAdditionalContract').classList.remove('hidden');
}

function deleteAdditionalContract(contractId) {
    const contracts = projectStore.listAdditionalContracts(currentProjectId);
    const contract = contracts.find(c => c.id === contractId);
    if (!contract) return;

    itemToDelete = contractId;
    deleteCallback = () => {
        projectStore.deleteAdditionalContract(contractId);
        loadAdditionalContracts();
        updateProjectKPIs();
    };
    
    document.getElementById('deleteConfirmText').textContent = `هل أنت متأكد من حذف العقد "${contract.contractNumber}"؟`;
    document.getElementById('confirmDeleteBtn').textContent = 'حذف العقد';
    document.getElementById('modalConfirmDelete').classList.remove('hidden');
}

// Expense Modal Functions
function openAddExpenseModal() {
    document.getElementById('modalExpenseTitle').textContent = 'إضافة مصروف جديد';
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseId').value = '';
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('expenseVAT').value = 15;
    document.getElementById('modalExpenseForm').classList.remove('hidden');
}

function closeExpenseModal() {
    document.getElementById('modalExpenseForm').classList.add('hidden');
}

function editExpense(expenseId) {
    const expenses = projectStore.listExpenses(currentProjectId);
    const expense = expenses.find(e => e.id === expenseId);
    if (!expense) return;

    document.getElementById('modalExpenseTitle').textContent = 'تعديل المصروف';
    document.getElementById('expenseId').value = expense.id;
    document.getElementById('expenseCategory').value = expense.category;
    document.getElementById('expenseDescription').value = expense.description;
    document.getElementById('expenseDate').value = expense.date;
    document.getElementById('expenseAmount').value = expense.amount;
    document.getElementById('expenseVAT').value = expense.vatPercent;
    document.getElementById('expenseTotal').value = expense.total;
    document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
    document.getElementById('expenseNotes').value = expense.notes;

    document.getElementById('modalExpenseForm').classList.remove('hidden');
}

function deleteExpense(expenseId) {
    const expenses = projectStore.listExpenses(currentProjectId);
    const expense = expenses.find(e => e.id === expenseId);
    if (!expense) return;

    itemToDelete = expenseId;
    deleteCallback = () => {
        projectStore.deleteExpense(expenseId);
        loadExpensesSubTab();
        updateUnifiedKPIs();
        updateProjectKPIs();
    };
    
    document.getElementById('deleteConfirmText').textContent = `هل أنت متأكد من حذف المصروف "${expense.description}"؟`;
    document.getElementById('confirmDeleteBtn').textContent = 'حذف المصروف';
    document.getElementById('modalConfirmDelete').classList.remove('hidden');
}

// Subcontract Modal Functions
function openAddSubcontractModal() {
    document.getElementById('modalSubcontractTitle').textContent = 'إضافة عقد باطن جديد';
    document.getElementById('subcontractForm').reset();
    document.getElementById('subcontractId').value = '';
    document.getElementById('subcontractStartDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('modalSubcontractForm').classList.remove('hidden');
}

function closeSubcontractModal() {
    document.getElementById('modalSubcontractForm').classList.add('hidden');
}

function editSubcontract(contractId) {
    const subcontracts = projectStore.listSubcontracts(currentProjectId);
    const contract = subcontracts.find(c => c.id === contractId);
    if (!contract) return;

    document.getElementById('modalSubcontractTitle').textContent = 'تعديل عقد الباطن';
    document.getElementById('subcontractId').value = contract.id;
    document.getElementById('contractorName').value = contract.contractorName;
    document.getElementById('contractTitle').value = contract.contractTitle;
    document.getElementById('subcontractValue').value = contract.value;
    document.getElementById('subcontractPaidAmount').value = contract.paidAmount;
    document.getElementById('subcontractStartDate').value = contract.startDate;
    document.getElementById('subcontractEndDate').value = contract.endDate;
    document.getElementById('subcontractStatus').value = contract.status;

    document.getElementById('modalSubcontractForm').classList.remove('hidden');
}

function deleteSubcontract(contractId) {
    const subcontracts = projectStore.listSubcontracts(currentProjectId);
    const contract = subcontracts.find(c => c.id === contractId);
    if (!contract) return;

    itemToDelete = contractId;
    deleteCallback = () => {
        projectStore.deleteSubcontract(contractId);
        loadSubcontractsSubTab();
        updateUnifiedKPIs();
        updateProjectKPIs();
    };
    
    document.getElementById('deleteConfirmText').textContent = `هل أنت متأكد من حذف عقد "${contract.contractTitle}"؟`;
    document.getElementById('confirmDeleteBtn').textContent = 'حذف العقد';
    document.getElementById('modalConfirmDelete').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('modalConfirmDelete').classList.add('hidden');
    itemToDelete = null;
    deleteCallback = null;
}

function confirmDelete() {
    if (deleteCallback) {
        deleteCallback();
    }
    closeDeleteModal();
}

// Utility functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-SA', {
        style: 'decimal',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount) + ' ريال';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function calculateDuration(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return diffDays;
}

function getStatusColor(status) {
    const colorMap = {
        'active': 'success',
        'paused': 'warning',
        'completed': 'primary',
        'pending': 'secondary'
    };
    return colorMap[status] || 'secondary';
}

function getStatusText(status) {
    const textMap = {
        'active': 'نشط',
        'paused': 'متوقف',
        'completed': 'منتهي',
        'pending': 'قيد التنفيذ'
    };
    return textMap[status] || status;
}

function getCategoryColor(category) {
    const colorMap = {
        'مواد': 'primary',
        'عمالة': 'warning',
        'معدات': 'success',
        'نقل': 'accent',
        'ضيافة': 'secondary',
        'لوجستيات': 'error'
    };
    return colorMap[category] || 'primary';
}

function getCategoryIcon(category) {
    const iconMap = {
        'مواد': '🧱',
        'عمالة': '👷',
        'معدات': '🏗️',
        'نقل': '🚚',
        'ضيافة': '☕',
        'لوجستيات': '📦'
    };
    return iconMap[category] || '📄';
}

function getContractStatusColor(status) {
    const colorMap = {
        'active': 'success',
        'completed': 'primary',
        'pending': 'warning'
    };
    return colorMap[status] || 'secondary';
}

function getContractStatusText(status) {
    const textMap = {
        'active': 'نشط',
        'completed': 'مكتمل',
        'pending': 'معلق'
    };
    return textMap[status] || status;
}

// Form submission handlers
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing project management center...');
    
    // Daily Report form
    const dailyReportForm = document.getElementById('dailyReportForm');
    if (dailyReportForm) {
        dailyReportForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!dailyReportsStore) return;
            
            const formData = new FormData(e.target);
            const reportData = {
                phaseId: formData.get('phaseId'),
                date: formData.get('date'),
                progressPercent: formData.get('progressPercent'),
                workDescription: formData.get('workDescription'),
                issues: formData.get('issues'),
                weather: formData.get('weather'),
                workersCount: formData.get('workersCount'),
                equipmentUsed: formData.get('equipmentUsed')
            };
            
            const reportId = document.getElementById('dailyReportId').value;
            
            if (reportId) {
                dailyReportsStore.updateDailyReport(reportId, reportData);
            } else {
                dailyReportsStore.createDailyReport(currentProjectId, reportData);
            }
            
            loadDailyReportsTable();
            updateDailyReportKPIs();
            loadPhotoGallery();
            loadWeeklySummary();
            
            // Update phases if linked
            if (phasesStore) {
                loadPhasesMainTab();
                updatePhasesAnalytics();
            }
            
            closeDailyReportModal();
        });

        // Progress slider update
        const reportProgressSlider = document.getElementById('reportProgress');
        const reportProgressDisplay = document.getElementById('reportProgressDisplay');
        if (reportProgressSlider && reportProgressDisplay) {
            reportProgressSlider.addEventListener('input', function() {
                reportProgressDisplay.textContent = this.value + '%';
            });
        }
    }

    // Upload photos form
    const uploadPhotosForm = document.getElementById('uploadPhotosForm');
    if (uploadPhotosForm) {
        uploadPhotosForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const phaseId = formData.get('phaseId');
            const notes = formData.get('notes');
            const files = document.getElementById('photosInput').files;
            
            if (files.length > 0 && phaseId) {
                // In real app, would upload files to server
                console.log('Uploading photos for phase:', phaseId, 'Files:', files.length);
                alert('تم رفع الصور بنجاح!');
                
                loadPhotoGallery();
                updateDailyReportKPIs();
                closeUploadPhotosModal();
            } else {
                alert('يرجى اختيار المرحلة والصور');
            }
        });
    }

    // File drop zone handlers
    const fileDropZone = document.getElementById('fileDropZone');
    const photoDropZone = document.getElementById('photoDropZone');
    
    if (fileDropZone) {
        fileDropZone.addEventListener('click', () => {
            document.getElementById('reportFiles').click();
        });
        
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('border-primary');
        });
        
        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('border-primary');
        });
        
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('border-primary');
            
            const files = e.dataTransfer.files;
            handleFileSelection(files);
        });
    }
    
    if (photoDropZone) {
        photoDropZone.addEventListener('click', () => {
            document.getElementById('photosInput').click();
        });
        
        photoDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoDropZone.classList.add('border-primary');
        });
        
        photoDropZone.addEventListener('dragleave', () => {
            photoDropZone.classList.remove('border-primary');
        });
        
        photoDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            photoDropZone.classList.remove('border-primary');
            
            const files = e.dataTransfer.files;
            handlePhotoSelection(files);
        });
    }

    // Edit project form
    const editProjectForm = document.getElementById('editProjectForm');
    if (editProjectForm) {
        editProjectForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const projectData = {
                name: formData.get('projectName'),
                code: formData.get('projectCode'),
                client: formData.get('clientName'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                value: parseFloat(formData.get('projectValue')),
                status: formData.get('status'),
                notes: formData.get('notes')
            };
            
            const updatedProject = projectStore.updateProject(currentProjectId, projectData);
            if (updatedProject) {
                currentProjectData = updatedProject;
                updateProjectInformation();
                closeEditProjectModal();
                
                // Update header
                document.getElementById('currentProjectTitle').textContent = updatedProject.name;
                document.getElementById('currentProjectCode').textContent = updatedProject.code;
            }
        });
    }

    // Additional contract form
    const additionalContractForm = document.getElementById('additionalContractForm');
    if (additionalContractForm) {
        additionalContractForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const contractData = {
                contractNumber: formData.get('contractNumber'),
                description: formData.get('description'),
                value: formData.get('value'),
                signedDate: formData.get('signedDate'),
                file: formData.get('file')?.name || null
            };
            
            const contractId = document.getElementById('additionalContractId').value;
            
            if (contractId) {
                projectStore.updateAdditionalContract(contractId, contractData);
            } else {
                projectStore.createAdditionalContract(currentProjectId, contractData);
            }
            
            loadAdditionalContracts();
            closeAdditionalContractModal();
        });
    }

    // Phase form
    const phaseForm = document.getElementById('phaseForm');
    if (phaseForm) {
        phaseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!phasesStore) return;
            
            const formData = new FormData(e.target);
            const dependencies = Array.from(document.getElementById('phaseDependencies').selectedOptions).map(option => option.value);
            
            const phaseData = {
                name: formData.get('name'),
                description: formData.get('description'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                progressPercent: formData.get('progressPercent'),
                status: formData.get('status'),
                assignee: formData.get('assignee'),
                priority: formData.get('priority'),
                dependencies: dependencies
            };
            
            const phaseId = document.getElementById('phaseId').value;
            
            if (phaseId) {
                phasesStore.updatePhase(phaseId, phaseData);
            } else {
                phasesStore.createPhase(currentProjectId, phaseData);
            }
            
            loadPhasesMainTab();
            updatePhasesAnalytics();
            closePhaseModal();
        });

        // Progress slider update
        const progressSlider = document.getElementById('phaseProgress');
        const progressDisplay = document.getElementById('progressDisplay');
        if (progressSlider && progressDisplay) {
            progressSlider.addEventListener('input', function() {
                progressDisplay.textContent = this.value + '%';
            });
        }
    }

    // Expense form
    const expenseForm = document.getElementById('expenseForm');
    if (expenseForm) {
        expenseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const expenseData = {
                category: formData.get('category'),
                description: formData.get('description'),
                date: formData.get('date'),
                amount: formData.get('amount'),
                vatPercent: formData.get('vatPercent'),
                paymentMethod: formData.get('paymentMethod'),
                notes: formData.get('notes'),
                attachment: formData.get('attachment')?.name || null
            };
            
            const expenseId = document.getElementById('expenseId').value;
            
            if (expenseId) {
                projectStore.updateExpense(expenseId, expenseData);
            } else {
                projectStore.createExpense(currentProjectId, expenseData);
            }
            
            loadExpensesSubTab();
            updateUnifiedKPIs();
            updateProjectKPIs();
            closeExpenseModal();
        });

        // Auto-calculate total when amount or VAT changes
        const amountInput = document.getElementById('expenseAmount');
        const vatInput = document.getElementById('expenseVAT');
        const totalInput = document.getElementById('expenseTotal');

        function updateTotal() {
            const amount = parseFloat(amountInput.value) || 0;
            const vatPercent = parseFloat(vatInput.value) || 0;
            const total = amount * (1 + vatPercent / 100);
            totalInput.value = total.toFixed(2);
        }

        if (amountInput && vatInput) {
            amountInput.addEventListener('input', updateTotal);
            vatInput.addEventListener('input', updateTotal);
        }
    }

    // Subcontract form
    const subcontractForm = document.getElementById('subcontractForm');
    if (subcontractForm) {
        subcontractForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const contractData = {
                contractorName: formData.get('contractorName'),
                contractTitle: formData.get('contractTitle'),
                value: formData.get('value'),
                paidAmount: formData.get('paidAmount'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                status: formData.get('status'),
                contractFile: formData.get('contractFile')?.name || null
            };
            
            const contractId = document.getElementById('subcontractId').value;
            
            if (contractId) {
                projectStore.updateSubcontract(contractId, contractData);
            } else {
                projectStore.createSubcontract(currentProjectId, contractData);
            }
            
            loadSubcontractsSubTab();
            updateUnifiedKPIs();
            updateProjectKPIs();
            closeSubcontractModal();
        });
    }
    
    console.log('Project management center initialized successfully');
});

// File handling functions
function handleFileSelection(files) {
    const filePreview = document.getElementById('filePreview');
    filePreview.classList.remove('hidden');
    filePreview.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'relative bg-secondary-100 rounded-lg p-3';
        
        let content = '';
        if (file.type.startsWith('image/')) {
            const url = URL.createObjectURL(file);
            content = `<img src="${url}" alt="${file.name}" class="w-full h-20 object-cover rounded mb-2" />`;
        } else {
            content = '<div class="w-full h-20 bg-secondary-200 rounded mb-2 flex items-center justify-center"><i class="fas fa-file text-text-secondary text-2xl"></i></div>';
        }
        
        fileDiv.innerHTML = `
            ${content}
            <p class="text-xs text-text-secondary truncate">${file.name}</p>
            <p class="text-xs text-text-secondary">${(file.size / 1024 / 1024).toFixed(1)} MB</p>
            <button type="button" class="absolute top-1 right-1 bg-error text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" onclick="removeFile(${index})">
                ×
            </button>
        `;
        
        filePreview.appendChild(fileDiv);
    });
}

function handlePhotoSelection(files) {
    const photoPreview = document.getElementById('photoPreviewGrid');
    photoPreview.classList.remove('hidden');
    photoPreview.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
        if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'relative aspect-square bg-secondary-100 rounded-lg overflow-hidden';
            
            const url = URL.createObjectURL(file);
            let content = '';
            
            if (file.type.startsWith('image/')) {
                content = `<img src="${url}" alt="${file.name}" class="w-full h-full object-cover" />`;
            } else {
                content = `<video src="${url}" class="w-full h-full object-cover" controls></video>`;
            }
            
            photoDiv.innerHTML = `
                ${content}
                <button type="button" class="absolute top-1 right-1 bg-error text-white rounded-full w-6 h-6 flex items-center justify-center text-sm" onclick="removePhoto(${index})">
                    ×
                </button>
            `;
            
            photoPreview.appendChild(photoDiv);
        }
    });
}

function removeFile(index) {
    console.log('Removing file at index:', index);
}

function removePhoto(index) {
    console.log('Removing photo at index:', index);
}

// Placeholder functions for other features
function openNewProjectModal(){ window.location.href = 'project_creation_wizard.INTEGRATED.html'; }

function exportProjectsData() {
    alert('تصدير البيانات - قيد التطوير');
}

function editProjectValue() {
    const newValue = prompt('أدخل القيمة الجديدة للمشروع:', currentProjectData.value);
    if (newValue && !isNaN(newValue)) {
        projectStore.updateProject(currentProjectId, { value: parseFloat(newValue) });
        currentProjectData.value = parseFloat(newValue);
        updateProjectInformation();
        updateUnifiedKPIs();
    }
}

function uploadContractFile() {
    openContractUploadModal();
}

function loadProjectPayments(projectId) {
    console.log('Loading payments for project:', projectId);
    // Initialize payments system here
}

function loadFinancialAnalysis(projectId) {
    console.log('Loading financial analysis for project:', projectId);
}

// Filter functions
function applyExpenseFilters() {
    const filters = {
        category: document.getElementById('filterExpenseCategory').value,
        paymentMethod: document.getElementById('filterPaymentMethod').value,
        dateFrom: document.getElementById('filterDateFrom').value,
        dateTo: document.getElementById('filterDateTo').value
    };
    
    console.log('Applying expense filters:', filters);
    loadExpensesSubTab();
}

function clearExpenseFilters() {
    document.getElementById('filterExpenseCategory').value = '';
    document.getElementById('filterPaymentMethod').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    
    loadExpensesSubTab();
}

function applySubcontractFilters() {
    const filters = {
        contractorName: document.getElementById('filterContractor').value,
        status: document.getElementById('filterContractStatus').value,
        startDate: document.getElementById('filterContractStartDate').value,
        endDate: document.getElementById('filterContractEndDate').value
    };
    
    console.log('Applying subcontract filters:', filters);
    loadSubcontractsSubTab();
}

function clearSubcontractFilters() {
    document.getElementById('filterContractor').value = '';
    document.getElementById('filterContractStatus').value = '';
    document.getElementById('filterContractStartDate').value = '';
    document.getElementById('filterContractEndDate').value = '';
    
    loadSubcontractsSubTab();
}

function sortExpenseTable(field) {
    console.log('Sorting expenses by:', field);
}

function sortSubcontractTable(field) {
    console.log('Sorting subcontracts by:', field);
}

function exportUnifiedData() {
    alert('تصدير بيانات المصاريف والعقود - قيد التطوير');
}

function exportFinancialReport() {
    alert('تصدير التقرير المالي - قيد التطوير');
}

function switchTimelineView(viewType) {
    console.log('Switching timeline view to:', viewType);
}

// Phase management placeholder functions for CSV import
function importPhasesCSV() {
    alert('استيراد مراحل من CSV - قيد التطوير');
}

function exportLogs() {
    alert('تصدير السجل - قيد التطوير');
}

function clearLogs() {
    if (confirm('هل أنت متأكد من حذف جميع السجلات؟')) {
        if (phasesStore) {
            phasesStore.logs = [];
            phasesStore.savePhasesLogs();
            loadPhasesLogs();
            alert('تم حذف السجلات بنجاح');
        }
    }
}

// Payment management placeholder functions
function openAddPaymentModal() {
    alert('إضافة دفعة جديدة - قيد التطوير');
}

function closePaymentModal() {
    alert('إغلاق مودال الدفعة - قيد التطوير');
}

function applyPaymentFilters() {
    alert('تطبيق فلاتر الدفعات - قيد التطوير');
}

function clearPaymentFilters() {
    alert('مسح فلاتر الدفعات - قيد التطوير');
}

function sortPaymentTable(field) {
    console.log('Sorting payments by:', field);
}

function importPaymentsCSV() {
    alert('استيراد دفعات من CSV - قيد التطوير');
}

function refreshTimeline() {
    alert('تحديث الخط الزمني - قيد التطوير');
}
</script>


<script>
(() => {
  const STORAGE_KEY = 'contractorPro.projects';

  function getProjects(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch(e){ return []; }
  }
  function saveProjects(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

  function statusArabic(s){
    return ({active:'نشط', in_progress:'قيد التنفيذ', planned:'بداية المشروع', paused:'موقوف', done:'مكتمل'}[s] || 'قيد التنفيذ');
  }
  function statusBadgeClass(s){
    if(s==='active' || s==='done') return 'bg-success-100 text-success';
    if(s==='planned') return 'bg-primary-100 text-primary';
    if(s==='paused') return 'bg-secondary-200 text-text-secondary';
    return 'bg-warning-100 text-warning';
  }
  function progressColor(p){
    p = Number(p||0);
    if(p>=80) return 'text-success';
    if(p>=40) return 'text-warning';
    return 'text-primary';
  }
  function progressBarColor(p){
    p = Number(p||0);
    if(p>=80) return 'bg-success';
    if(p>=40) return 'bg-warning';
    return 'bg-primary';
  }
  function formatCurrency(v){
    if(v === undefined || v === null || v === '') return '-';
    const num = Number(v);
    if (Number.isFinite(num)) {
      return num.toLocaleString('ar-EG', {minimumFractionDigits: 0}) + ' ر.س';
    }
    return v;
  }

  function renderStoredProjects(){
    const grid = document.querySelector('#projects-list .grid');
    if(!grid) return;

    const projects = getProjects();
    projects.forEach(p => {
      // avoid duplicates if already rendered
      if (grid.querySelector(`[data-proj-id="${p.id}"]`)) return;

      const card = document.createElement('div');
      card.className = 'border border-border rounded-xl p-6 hover:shadow-lg transition-shadow cursor-pointer project-card';
      card.setAttribute('data-proj-id', p.id);
      card.onclick = () => {
        if (typeof openProjectDetails === 'function') {
          openProjectDetails(p.id, p.name || 'مشروع');
        }
      };

      const progress = Number(p.progress || 0);
      card.innerHTML = `
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-lg font-bold text-text-primary">${p.name || 'مشروع جديد'}</h3>
            <p class="text-sm text-text-secondary">العميل: ${(p.client && p.client.name) ? p.client.name : 'غير محدد'}</p>
          </div>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusBadgeClass(p.status)}">
            ${statusArabic(p.status)}
          </span>
        </div>

        <div class="space-y-3 mb-4">
          <div class="flex justify-between">
            <span class="text-text-secondary">قيمة المشروع:</span>
            <span class="font-bold text-text-primary">${formatCurrency(p.budget && p.budget.contractValue)}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">تاريخ البداية:</span>
            <span class="font-medium">${(p.timeline && p.timeline.startDate) ? p.timeline.startDate : '-'}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">نسبة الإنجاز:</span>
            <span class="font-bold ${progressColor(progress)}">${progress}%</span>
          </div>
        </div>

        <div class="w-full bg-secondary-200 rounded-full h-2 mb-4">
          <div class="${progressBarColor(progress)} h-2 rounded-full" style="width: ${progress}%"></div>
        </div>

        <div class="flex items-center gap-2 text-sm text-text-secondary">
          <i class="fas fa-calendar-alt"></i>
          <span>ينتهي في: ${(p.timeline && p.timeline.endDate) ? p.timeline.endDate : '-'}</span>
        </div>
      `;

      // Prepend new projects so they appear first
      grid.prepend(card);
    });

    // Update "active projects" counter if such element exists
    const activeCounter = document.querySelector('#projects-list .text-primary.font-bold.text-lg');
    if (activeCounter) {
      const count = grid.querySelectorAll('.project-card').length;
      activeCounter.textContent = String(count);
    }
  }

  // Repurpose the existing "مشروع جديد" button handler to navigate to the wizard page.
  window.openNewProjectModal = function(){
    // Navigate instead of opening a modal (keeps existing markup intact).
    window.location.href = 'project_creation_wizard.html';
  };

  function showToast(msg, ok=true){
    const t = document.createElement('div');
    t.textContent = msg;
    t.className = 'fixed bottom-6 right-6 ' + (ok ? 'bg-success' : 'bg-error') + ' text-white px-4 py-3 rounded-lg shadow-modal z-[9999]';
    document.body.appendChild(t);
    setTimeout(()=> t.remove(), 3000);
  }

  document.addEventListener('DOMContentLoaded', () => {
    // If redirected from wizard after a successful creation, show a toast
    const url = new URL(window.location.href);
    if (url.searchParams.get('created')) {
      showToast('تم إنشاء المشروع بنجاح ✅', true);
      url.searchParams.delete('created');
      history.replaceState({}, '', url.pathname);
    }
    renderStoredProjects();
  });
})();
</script>
<!-- END INJECT -->

<script>
// ===== LINKED RUNTIME (no design changes) =====
(function(){
  function showSuccessToast(title, message){
    var t = document.createElement('div');
    t.style.position = 'fixed';
    t.style.top = '16px';
    t.style.right = '16px';
    t.style.background = '#10B981';
    t.style.color = '#fff';
    t.style.padding = '12px 16px';
    t.style.borderRadius = '12px';
    t.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
    t.style.zIndex = 9999;
    t.style.opacity = '0';
    t.style.transition = 'opacity .5s ease';
    t.innerHTML = '<strong>' + (title||'') + '</strong><br><small>' + (message||'') + '</small>';
    document.body.appendChild(t);
    requestAnimationFrame(function(){ t.style.opacity = '1'; });
    setTimeout(function(){ t.style.opacity = '0'; setTimeout(function(){ t.remove(); }, 400); }, 4000);
  }

  function addNewProjectCard(p){
    var grid = document.querySelector('#projectsGrid') || document.querySelector('.grid');
    if(!grid){ return; }
    var card = document.createElement('div');
    card.className = 'border border-border rounded-xl p-6 hover:shadow-lg transition-shadow cursor-pointer project-card';
    card.innerHTML = ''
      + '<div class="flex items-start justify-between mb-4">'
      +   '<div>'
      +     '<h3 class="text-lg font-bold text-text-primary">' + (p.name||'مشروع جديد') + '</h3>'
      +     '<p class="text-sm text-text-secondary">العميل: ' + (p.clientName||'غير محدد') + '</p>'
      +   '</div>'
      +   '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success-100 text-success">جديد</span>'
      + '</div>'
      + '<div class="space-y-3 mb-4">'
      +   '<div class="flex justify-between"><span class="text-text-secondary">قيمة المشروع:</span><span class="font-bold text-text-primary">' + (p.projectValue||p.value||'—') + ' ر.س</span></div>'
      +   '<div class="flex justify-between"><span class="text-text-secondary">تاريخ البداية:</span><span class="font-medium">' + (p.startDate||'—') + '</span></div>'
      + '</div>'
      + '<div class="w-full bg-secondary-200 rounded-full h-2 mb-4">'
      +   '<div class="bg-success h-2 rounded-full" style="width:' + (p.progress||0) + '%"></div>'
      + '</div>';
    // animation 1s (fade + scale)
    card.style.opacity = '0';
    card.style.transform = 'scale(0.9)';
    grid.prepend(card);
    setTimeout(function(){
      card.style.transition = 'all 1s ease';
      card.style.opacity = '1';
      card.style.transform = 'scale(1)';
    }, 50);

    // increment active count if exists
    var cnt = document.getElementById('activeProjectsCount');
    if(cnt){ var n=parseInt(cnt.textContent||'0',10); if(!isNaN(n)){ cnt.textContent = (n+1).toString(); } }
  }

  // ensure "مشروع جديد" opens the wizard page
  if (typeof window.openNewProjectModal !== 'function') {
    window.openNewProjectModal = function(){ window.location.href = 'project_creation_wizard.INTEGRATED.html'; };
  } else {
    // override safely to guarantee navigation to wizard
    var _old = window.openNewProjectModal;
    window.openNewProjectModal = function(){ try{ return _old(); }catch(_){ window.location.href = 'project_creation_wizard.INTEGRATED.html'; } };
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{
      var saved = localStorage.getItem('newProject');
      if(saved){
        var p = JSON.parse(saved);
        addNewProjectCard(p);
        localStorage.removeItem('newProject');
      }
      if(localStorage.getItem('toastMessage') === 'success'){
        showSuccessToast('✅ تم إنشاء المشروع بنجاح!', 'تمت إضافته إلى قائمة المشاريع.');
        localStorage.removeItem('toastMessage');
      }
    }catch(_){}
  });
})();
</script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>
